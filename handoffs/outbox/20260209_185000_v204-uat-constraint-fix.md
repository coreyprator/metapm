# [MetaPM] v2.0.4 UAT Constraint Fix â€” COMPLETE

> **From**: Claude Code (Command Center)
> **To**: Claude.ai (Architect)
> **Project**: MetaPM
> **Task**: v2.0.4 UAT Constraint Fix
> **Timestamp**: 2026-02-09T18:50:00Z
> **Status**: COMPLETE

---

## Summary

Fixed the UAT Submit 500 error caused by SQL CHECK constraint violation. The `uat_results.status` column only allowed 'passed' or 'failed', but the v2.0.3 update added 'pending' to the enum. Updated the database constraint to allow all three values.

---

## Root Cause

```
Error: ('23000', '[23000] [Microsoft][ODBC Driver 18 for SQL Server][SQL Server]
The INSERT statement conflicted with the CHECK constraint "CK__uat_resul__statu__50FB042B".
The conflict occurred in database "MetaPM", table "dbo.uat_results", column 'status'.')
```

The `uat_results` table had:
```sql
status NVARCHAR(20) NOT NULL CHECK (status IN ('passed', 'failed'))
```

But the API now accepts `status: 'pending'` from the UATStatus enum.

---

## Fix Applied

### 1. Migration Added (v2.0.4)
Added Migration 11 to [app/core/migrations.py](app/core/migrations.py#L378):
```python
# Migration 11: Update uat_results status constraint to allow 'pending'
execute_query("""
    ALTER TABLE uat_results
    ADD CONSTRAINT CK_uat_results_status
    CHECK (status IN ('passed', 'failed', 'pending'))
""")
```

### 2. Manual Fix Script
Created [fix_uat_constraint.py](fix_uat_constraint.py) for direct database fix (used because Cloud Run had connection issues with migrations).

### 3. Version Updated
[app/core/config.py](app/core/config.py#L15):
```python
VERSION: str = "2.0.4"  # Fix UAT submit status constraint
```

---

## Verification

```bash
curl -X POST "https://metapm.rentyourcio.com/mcp/uat/submit" \
  -H "Content-Type: application/json" \
  -d '{"project":"Test","version":"1.0","status":"pending","total_tests":3,"passed":1,"failed":1,"results_text":"Test"}'

# Response:
{"handoff_id":"C05FB2C7-...","uat_id":"CA74781A-...","status":"pending","message":"UAT results recorded for Test v1.0"}
```

---

## Git

| Field | Value |
|-------|-------|
| Commits | `af64702` chore: Add manual constraint fix script |
| | `bad80ae` fix: Update uat_results status constraint to allow pending (v2.0.4) |
| Branch | main |
| Pushed | Yes |

---

## Files Changed

| File | Change |
|------|--------|
| `app/core/migrations.py` | Added Migration 11 |
| `app/core/config.py` | VERSION = "2.0.4" |
| `fix_uat_constraint.py` | New: Manual fix script |

---

## Deployment

| Field | Value |
|-------|-------|
| Service | metapm |
| Revision | metapm-00005-8qj |
| URL | https://metapm-57478301787.us-central1.run.app |
| Custom Domain | https://metapm.rentyourcio.com |

---

*Sent via Handoff Bridge per project-methodology policy*
*MetaPM/handoffs/outbox/20260209_185000_v204-uat-constraint-fix.md -> GCS backup*
