<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MetaPM Dashboard</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #111a2d;
      --panel-soft: #0f1729;
      --text: #e6edf8;
      --muted: #9aa8c7;
      --line: #26344f;
      --accent: #e74c3c;
      --ok: #23a55a;
      --warn: #f5a623;
      --info: #4a90d9;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    .app {
      max-width: 1320px;
      margin: 0 auto;
      padding: 10px 16px 82px;
      min-height: 100vh;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 10px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      margin-bottom: 10px;
      position: sticky;
      top: 0;
      z-index: 15;
    }
    .title { font-size: 22px; font-weight: 700; }
    .title-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .version-badge {
      font-size: 12px;
      color: var(--muted);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 2px 8px;
      background: var(--panel-soft);
    }
    .controls {
      padding: 12px 16px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
      position: sticky;
      top: 68px;
      z-index: 14;
    }
    .control-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .search-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 360px;
      flex: 1;
    }
    .search-wrap input {
      flex: 1;
      min-width: 260px;
    }
    label { color: var(--muted); font-size: 12px; }
    select, input, textarea, button {
      border: 1px solid var(--line);
      background: var(--panel-soft);
      color: var(--text);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 13px;
    }
    textarea { width: 100%; min-height: 90px; resize: vertical; }
    button { cursor: pointer; }
    .add-wrap { position: relative; }
    .add-menu {
      position: absolute;
      top: 36px;
      right: 0;
      min-width: 180px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 8px;
      display: none;
      z-index: 5;
    }
    .add-menu.open { display: block; }
    .add-menu button {
      width: 100%;
      border: 0;
      border-bottom: 1px solid var(--line);
      border-radius: 0;
      text-align: left;
      background: transparent;
    }
    .add-menu button:last-child { border-bottom: 0; }
    .hierarchy {
      padding: 10px;
      height: calc(100vh - 250px);
      min-height: 280px;
      overflow: auto;
    }
    .project {
      margin-bottom: 8px;
      border: 1px solid var(--line);
      border-left: 5px solid var(--info);
      border-radius: 8px;
      overflow: hidden;
      background: var(--panel-soft);
    }
    .project-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      cursor: pointer;
      user-select: none;
    }
    .project-summary { color: var(--muted); font-size: 12px; }
    .project-body { display: none; border-top: 1px solid var(--line); }
    .project-body.open { display: block; }
    .bucket { padding: 6px 10px; }
    .bucket-title {
      color: var(--muted);
      font-size: 12px;
      margin: 4px 0 6px;
      font-weight: 600;
    }
    .req-row {
      display: grid;
      grid-template-columns: 1fr auto auto auto auto;
      gap: 8px;
      align-items: center;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid var(--line);
      margin-bottom: 6px;
      background: #0f182b;
      cursor: pointer;
    }
    .req-row:hover { background: #13203a; }
    .sprint-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: center;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid var(--line);
      margin-bottom: 6px;
      background: #0f182b;
    }
    .pill { font-size: 11px; border-radius: 999px; padding: 2px 8px; border: 1px solid var(--line); color: var(--muted); }
    .p1 { color: #ff9a9a; border-color: #803c3c; }
    .p2 { color: #ffd18a; border-color: #7a5a2f; }
    .status-done { color: #9de2b4; border-color: #2f6e46; }
    .status-in_progress { color: #9ec2ff; border-color: #34507c; }
    .status-conditional_pass { color: #f5d99a; border-color: #7a6a2f; }
    .task-row {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 6px;
      align-items: center;
      padding: 4px 8px 4px 24px;
      border-radius: 4px;
      border: 1px solid var(--line);
      margin-bottom: 3px;
      background: #0a1220;
      font-size: 12px;
    }
    .task-row .pill { font-size: 10px; }
    .dep-link { color: #9ec2ff; font-size: 12px; cursor: pointer; text-decoration: underline; }
    .drawer {
      position: fixed;
      top: 0;
      right: -520px;
      width: 520px;
      max-width: 100%;
      height: 100%;
      background: var(--panel);
      border-left: 1px solid var(--line);
      transition: right .2s;
      z-index: 20;
      padding: 14px;
      overflow: auto;
    }
    .drawer.open { right: 0; }
    .drawer-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .footer {
      margin-top: 10px;
      padding: 12px 14px;
      color: var(--muted);
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
      position: fixed;
      left: 16px;
      right: 16px;
      bottom: 8px;
      max-width: 1320px;
      margin-left: auto;
      margin-right: auto;
      z-index: 16;
    }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
      padding: 12px;
    }
    .modal.open { display: flex; }
    .modal-card {
      width: 560px;
      max-width: 100%;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 14px;
    }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .danger-btn {
      border-color: #803c3c;
      color: #ff9a9a;
    }
    .danger-btn.active {
      background: #2b1414;
    }
    .icon-btn {
      min-width: 32px;
      padding: 4px 8px;
      line-height: 1;
    }
    .actions-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card header">
      <div class="title-wrap">
        <div class="title">üî¥ MetaPM</div>
        <span id="appVersion" class="version-badge">v-</span>
      </div>
      <div class="actions-row">
        <a href="/static/roadmap-report.html" target="_blank" rel="noopener"><button type="button">üìä Roadmap Report</button></a>
        <a href="/architecture" target="_blank" rel="noopener"><button type="button">üèóÔ∏è Architecture</button></a>
        <div class="add-wrap">
          <button id="addBtn">+ Add ‚ñæ</button>
          <div id="addMenu" class="add-menu">
            <button data-kind="project">Project</button>
            <button data-kind="sprint">Sprint</button>
            <button data-kind="requirement">Requirement</button>
            <button data-kind="bug">Bug</button>
            <button data-kind="task">Task</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card controls">
      <div class="control-row">
        <label>Filter</label>
        <select id="categoryFilter"><option value="">All Categories</option></select>
        <select id="projectFilter"><option value="">All Projects</option></select>
        <select id="priorityFilter"><option value="">All Priorities</option><option>P1</option><option>P2</option><option>P3</option></select>
        <select id="statusFilter"><option value="">All Status</option><option value="not_done">Not Done</option><option value="backlog">backlog</option><option value="planned">planned</option><option value="in_progress">in_progress</option><option value="uat">uat</option><option value="needs_fixes">needs_fixes</option><option value="conditional_pass">conditional_pass</option><option value="done">done</option></select>
        <button id="resetFiltersBtn" type="button" class="danger-btn">Reset Filters</button>
      </div>
      <div class="control-row">
        <label>Sort/Group</label>
        <div class="search-wrap">
          <label for="searchInput">Full Text Search</label>
          <input id="searchInput" placeholder="Search code, title, description, type, status..." />
        </div>
        <select id="sortBy"><option value="priority">Priority</option><option value="code">Code</option><option value="title">Title</option></select>
        <select id="groupBy"><option value="project">By Project</option></select>
        <button id="expandAllBtn" type="button">Expand All</button>
        <button id="collapseAllBtn" type="button">Collapse All</button>
      </div>
    </div>

    <div class="card hierarchy" id="hierarchy"></div>

    <div class="card footer" id="summary">
      <div>Total: 0 | Done: 0 | In Progress: 0 | Backlog: 0 | Projects: 0</div>
      <div id="openP1">Open P1s: 0</div>
    </div>
  </div>

  <aside class="drawer" id="drawer">
    <div class="drawer-head">
      <strong id="drawerTitle">Requirement</strong>
      <div>
        <button id="saveBtn">Save</button>
        <button id="deleteReqBtn" class="danger-btn icon-btn" title="Delete Requirement">üóëÔ∏è</button>
        <button id="closeBtn">Close</button>
      </div>
    </div>
    <div class="grid2">
      <div>
        <label>Code (read-only)</label>
        <input id="dCode" readonly style="opacity:0.7;cursor:not-allowed" />
      </div>
      <div>
        <label>Title (editable)</label>
        <input id="dTitle" style="font-weight:600" />
      </div>
      <div>
        <label>Project</label>
        <select id="dProject"></select>
      </div>
      <div>
        <label>Sprint</label>
        <select id="dSprint"></select>
      </div>
      <div>
        <label>Priority</label>
        <select id="dPriority"><option>P1</option><option>P2</option><option>P3</option></select>
      </div>
      <div>
        <label>Type</label>
        <select id="dType"><option value="feature">feature</option><option value="bug">bug</option><option value="enhancement">enhancement</option><option value="task">task</option></select>
      </div>
      <div>
        <label>Status</label>
        <select id="dStatus"><option value="backlog">backlog</option><option value="planned">planned</option><option value="in_progress">in_progress</option><option value="uat">uat</option><option value="needs_fixes">needs_fixes</option><option value="conditional_pass">conditional_pass</option><option value="done">done</option></select>
      </div>
      <div>
        <label>Target Version</label>
        <input id="dVersion" />
      </div>
    </div>
    <div>
      <label>Description</label>
      <textarea id="dDescription"></textarea>
    </div>
    <div>
      <label>Linked Handoffs</label>
      <div id="dHandoffs" style="font-size:13px;color:var(--muted)">None</div>
    </div>
    <div>
      <label>Dependencies</label>
      <div id="dDependencies" style="font-size:13px;color:var(--muted)">None</div>
    </div>
    <div>
      <label>Tasks</label>
      <div id="dTasks" style="font-size:13px;color:var(--muted)">None</div>
    </div>
    <div>
      <label>Test Plans</label>
      <div id="dTestPlans" style="font-size:13px;color:var(--muted)">None</div>
    </div>
  </aside>

  <div class="modal" id="addModal">
    <div class="modal-card">
      <div class="drawer-head">
        <strong id="addTitle">Create</strong>
        <button id="addClose">Close</button>
      </div>
      <div id="addFields"></div>
      <div style="margin-top:10px;display:flex;justify-content:flex-end;gap:8px">
        <button id="addSave">Create</button>
      </div>
    </div>
  </div>

  <div class="modal" id="editModal">
    <div class="modal-card">
      <div class="drawer-head">
        <strong id="editTitle">Edit</strong>
        <button id="editClose">Close</button>
      </div>
      <div id="editFields"></div>
      <div style="margin-top:10px;display:flex;justify-content:flex-end;gap:8px">
        <button id="editSave">Save</button>
      </div>
    </div>
  </div>

  <script>
    const PROJECT_COLORS = {
      HL: '#4A90D9', SF: '#F5A623', AF: '#E8751A', EM: '#9B59B6', MP: '#E74C3C', PM: '#27AE60'
    };

    const state = {
      projects: [],
      requirements: [],
      sprints: [],
      categories: [],
      tasks: [],
      expanded: new Set(),
      selectedReq: null,
      contextProjectId: null,
      addKind: null,
      editKind: null,
      editId: null
    };

    const qs = (id) => document.getElementById(id);

    async function loadVersion() {
      try {
        const health = await api('/health');
        const v = health?.version;
        if (v) {
          qs('appVersion').textContent = `v${v}`;
          return;
        }
      } catch {}

      try {
        const version = await api('/api/version');
        const v = version?.version || '-';
        qs('appVersion').textContent = `v${v}`;
      } catch {
        qs('appVersion').textContent = 'v-';
      }
    }

    async function api(path, options = {}) {
      const res = await fetch(path, { headers: { 'Content-Type': 'application/json' }, ...options });
      if (!res.ok) {
        let detail = '';
        let rawBody = '';
        try {
          const payload = await res.json();
          rawBody = JSON.stringify(payload);
          detail = payload?.detail || payload?.message || '';
        } catch {
          detail = '';
        }
        // Standard A: log full response body to console
        console.error(`[API Error] ${options.method || 'GET'} ${path}`, { status: res.status, statusText: res.statusText, body: rawBody });
        throw new Error(detail ? `${res.status} ${detail}` : `${res.status} ${res.statusText}`);
      }
      if (res.status === 204) return null;
      return await res.json();
    }

    // Standard B: toast notification ‚Äî errors persist 10s with close button
    function showToast(message, type = 'error') {
      let container = document.getElementById('metapm-toast-container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'metapm-toast-container';
        container.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px;';
        document.body.appendChild(container);
      }
      const toast = document.createElement('div');
      toast.style.cssText = `background:${type === 'error' ? '#dc2626' : '#16a34a'};color:#fff;padding:12px 16px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.3);display:flex;align-items:flex-start;gap:12px;max-width:400px;min-width:240px;word-break:break-word;`;
      const msg = document.createElement('span');
      msg.style.flex = '1';
      msg.textContent = message;
      const close = document.createElement('button');
      close.textContent = '‚úï';
      close.title = 'Dismiss';
      close.style.cssText = 'background:none;border:none;cursor:pointer;font-size:16px;line-height:1;padding:0;opacity:.75;flex-shrink:0;color:inherit;';
      close.onclick = () => toast.remove();
      toast.appendChild(msg);
      toast.appendChild(close);
      container.appendChild(toast);
      const duration = type === 'error' ? 10000 : 4000;
      if (type === 'error') console.error('[MetaPM Error]', message);
      setTimeout(() => toast.remove(), duration);
    }

    function makeId() { return crypto.randomUUID(); }

    function friendlyCreateError(kind, rawMessage, code) {
      const msg = String(rawMessage || '');
      if (/unique key|duplicate key|already exists/i.test(msg)) {
        if (kind === 'project') {
          return `A project with code '${code || ''}' already exists. Choose a different code.`;
        }
        if (code) {
          return `A ${kind} with code '${code}' already exists. Choose a different code.`;
        }
      }
      return msg || 'Request failed.';
    }

    function normalizeReqText(req) { return `${req.code} ${req.title}`.toLowerCase(); }

    function filtersActive() {
      return Boolean(
        qs('categoryFilter').value ||
        qs('projectFilter').value ||
        qs('priorityFilter').value ||
        qs('statusFilter').value ||
        (qs('searchInput').value || '').trim()
      );
    }

    function updateResetButtonState() {
      qs('resetFiltersBtn').classList.toggle('active', filtersActive());
    }

    function getFilteredRequirements() {
      const category = qs('categoryFilter').value;
      const project = qs('projectFilter').value;
      const priority = qs('priorityFilter').value;
      const status = qs('statusFilter').value;
      const search = (qs('searchInput').value || '').trim().toLowerCase();
      return state.requirements.filter((req) => {
        if (category) {
          const proj = state.projects.find(p => p.id === req.project_id);
          if (!proj || proj.category_id !== category) return false;
        }
        if (project && req.project_id !== project) return false;
        if (priority && req.priority !== priority) return false;
        if (status === 'not_done' && req.status === 'done') return false;
        if (status && status !== 'not_done' && req.status !== status) return false;
        if (search) {
          const haystack = `${req.code} ${req.title} ${req.description || ''} ${req.type || ''} ${req.status || ''}`.toLowerCase();
          if (!haystack.includes(search)) return false;
        }
        return true;
      });
    }

    function compareReq(a, b) {
      const by = qs('sortBy').value;
      if (by === 'priority') {
        const weight = { P1: 1, P2: 2, P3: 3 };
        return (weight[a.priority] || 9) - (weight[b.priority] || 9) || a.code.localeCompare(b.code);
      }
      if (by === 'title') return a.title.localeCompare(b.title);
      return a.code.localeCompare(b.code);
    }

    function setSummary(reqs) {
      const total = reqs.length;
      const done = reqs.filter(r => r.status === 'done').length;
      const inProgress = reqs.filter(r => r.status === 'in_progress').length;
      const backlog = reqs.filter(r => r.status === 'backlog').length;
      const projectCount = state.projects.length;
      const openP1 = reqs.filter(r => r.priority === 'P1' && r.status !== 'done').length;
      qs('summary').children[0].textContent = `Total: ${total} | Done: ${done} | In Progress: ${inProgress} | Backlog: ${backlog} | Projects: ${projectCount}`;
      qs('openP1').textContent = `Open P1s: ${openP1}`;
    }

    function projectName(id) {
      const p = state.projects.find(x => x.id === id);
      return p ? p.name : id;
    }

    function sprintName(id) {
      if (!id) return 'Backlog';
      const s = state.sprints.find(x => x.id === id);
      return s ? s.name : 'Backlog';
    }

    function groupedForProject(projectId, reqs) {
      const list = reqs.filter(r => r.project_id === projectId).sort(compareReq);
      const buckets = { sprint: {}, backlog: [], done: [] };
      for (const req of list) {
        if (req.status === 'done') buckets.done.push(req);
        else if (!req.sprint_id) buckets.backlog.push(req);
        else {
          if (!buckets.sprint[req.sprint_id]) buckets.sprint[req.sprint_id] = [];
          buckets.sprint[req.sprint_id].push(req);
        }
      }
      return buckets;
    }

    function rowHtml(req) {
      return `<div class="req-row" data-req="${req.id}">
        <div><strong>${req.code}</strong> ${req.title}</div>
        <span class="pill ${req.priority.toLowerCase()}">${req.priority}</span>
        <span class="pill status-${req.status}">${req.status}</span>
        <span class="pill">${req.type}</span>
        <div class="actions-row">
          <button class="icon-btn" data-open-req="${req.id}" title="Edit Requirement">‚úèÔ∏è</button>
          <button class="icon-btn danger-btn" data-delete-req="${req.id}" title="Delete Requirement">üóëÔ∏è</button>
        </div>
      </div>`;
    }

    function taskRowHtml(t) {
      return `<div class="task-row" data-task="${t.id}">
        <div>${t.title}</div>
        <span class="pill status-${t.status}">${t.status}</span>
        <span class="pill ${t.priority.toLowerCase()}">${t.priority}</span>
        <button class="icon-btn" data-edit-task="${t.id}" title="Edit Task">‚úèÔ∏è</button>
      </div>`;
    }

    function sprintRowHtml(sprint, projectReqs) {
      const count = projectReqs.filter(r => r.sprint_id === sprint.id && r.status !== 'done').length;
      return `<div class="sprint-row">
        <div><strong>${sprint.name}</strong> <span class="project-summary">(${count} active items)</span></div>
        <div class="actions-row">
          <button class="icon-btn" data-edit-sprint="${sprint.id}" title="Edit Sprint">‚úèÔ∏è</button>
          <button class="icon-btn danger-btn" data-delete-sprint="${sprint.id}" title="Delete Sprint">üóëÔ∏è</button>
        </div>
      </div>`;
    }

    function render() {
      const reqs = getFilteredRequirements();
      const hierarchy = qs('hierarchy');
      hierarchy.innerHTML = '';
      const categoryFilter = qs('categoryFilter').value;

      for (const p of state.projects) {
        if (categoryFilter && p.category_id !== categoryFilter) continue;
        const pReqs = reqs.filter(r => r.project_id === p.id);

        const done = pReqs.filter(r => r.status === 'done').length;
        const p1 = pReqs.filter(r => r.priority === 'P1').length;
        const p2 = pReqs.filter(r => r.priority === 'P2').length;
        const open = state.expanded.has(p.id);
        const color = PROJECT_COLORS[p.code] || p.color || '#4A90D9';
        const projectSprints = state.sprints.filter(s => !s.project_id || s.project_id === p.id);

        const buckets = groupedForProject(p.id, reqs);
        const sprintRows = projectSprints.map((s) => sprintRowHtml(s, pReqs)).join('') || '<div class="project-summary">None</div>';
        const sprintBlocks = Object.keys(buckets.sprint).map((sid) => `
          <div class="bucket"><div class="bucket-title">Sprint: ${sprintName(sid)}</div>${buckets.sprint[sid].map(rowHtml).join('')}</div>
        `).join('');

        // Tasks for this project (siblings of requirements)
        const projectTasks = state.tasks.filter(t => {
          const parentReq = state.requirements.find(r => r.id === t.requirement_id);
          return parentReq && parentReq.project_id === p.id;
        });
        const taskSection = projectTasks.length
          ? `<div class="bucket"><div class="bucket-title">Tasks (${projectTasks.filter(t=>t.status==='done').length}/${projectTasks.length} done)</div>${projectTasks.map(taskRowHtml).join('')}</div>`
          : '';

        const html = `
          <section class="project" style="border-left-color:${color}">
            <div class="project-head">
              <div data-project="${p.id}">${open ? '‚ñº' : '‚ñ∂'} ${p.emoji || ''} ${p.name} ${p.current_version || ''}${p.category_name ? ` <span class="pill">${p.category_name}</span>` : ''}</div>
              <div class="actions-row">
                <div class="project-summary">${done} done | ${p1} P1 | ${p2} P2</div>
                <button class="icon-btn" data-edit-project="${p.id}" title="Edit Project">‚úèÔ∏è</button>
                <button class="icon-btn danger-btn" data-delete-project="${p.id}" title="Delete Project">üóëÔ∏è</button>
              </div>
            </div>
            <div class="project-body ${open ? 'open' : ''}">
              <div class="bucket"><div class="bucket-title">Sprints</div>${sprintRows}</div>
              ${sprintBlocks}
              <div class="bucket"><div class="bucket-title">Backlog (unassigned)</div>${buckets.backlog.map(rowHtml).join('') || '<div class="project-summary">None</div>'}</div>
              ${taskSection}
              <div class="bucket"><div class="bucket-title">Done</div>${buckets.done.map(rowHtml).join('') || '<div class="project-summary">None</div>'}</div>
            </div>
          </section>`;

        hierarchy.insertAdjacentHTML('beforeend', html);
      }

      if (!hierarchy.children.length) hierarchy.innerHTML = '<div class="project-summary">No matching requirements.</div>';
      setSummary(reqs);
      updateResetButtonState();
      bindHierarchyEvents();
    }

    function bindHierarchyEvents() {
      document.querySelectorAll('[data-project]').forEach((el) => {
        el.onclick = () => {
          const id = el.dataset.project;
          if (state.expanded.has(id)) state.expanded.delete(id); else state.expanded.add(id);
          state.contextProjectId = id;
          render();
        };
      });

      document.querySelectorAll('[data-open-req]').forEach((el) => {
        el.onclick = (e) => {
          e.stopPropagation();
          openRequirement(el.dataset.openReq);
        };
      });

      document.querySelectorAll('[data-delete-req]').forEach((el) => {
        el.onclick = async (e) => {
          e.stopPropagation();
          const req = state.requirements.find(r => r.id === el.dataset.deleteReq);
          const label = req ? `${req.code || 'REQ'} ‚Äî ${req.title || ''}` : el.dataset.deleteReq;
          if (!confirm(`Delete requirement '${label}'?`)) return;
          await api(`/api/roadmap/requirements/${el.dataset.deleteReq}`, { method: 'DELETE' });
          if (state.selectedReq?.id === el.dataset.deleteReq) {
            state.selectedReq = null;
            qs('drawer').classList.remove('open');
          }
          await loadData();
        };
      });

      document.querySelectorAll('[data-edit-project]').forEach((el) => {
        el.onclick = (e) => {
          e.stopPropagation();
          openEditProject(el.dataset.editProject);
        };
      });

      document.querySelectorAll('[data-edit-sprint]').forEach((el) => {
        el.onclick = (e) => {
          e.stopPropagation();
          openEditSprint(el.dataset.editSprint);
        };
      });

      document.querySelectorAll('[data-delete-project]').forEach((el) => {
        el.onclick = async (e) => {
          e.stopPropagation();
          const proj = state.projects.find(p => p.id === el.dataset.deleteProject);
          const reqCount = state.requirements.filter(r => r.project_id === el.dataset.deleteProject).length;
          const name = proj?.name || el.dataset.deleteProject;
          const warning = reqCount > 0 ? ' Delete all requirements first.' : '';
          if (!confirm(`Delete project '${name}'? This project has ${reqCount} requirements.${warning}`)) return;
          await api(`/api/roadmap/projects/${el.dataset.deleteProject}`, { method: 'DELETE' });
          await loadData();
        };
      });

      document.querySelectorAll('[data-delete-sprint]').forEach((el) => {
        el.onclick = async (e) => {
          e.stopPropagation();
          const sprint = state.sprints.find(s => s.id === el.dataset.deleteSprint);
          const reqCount = state.requirements.filter(r => r.sprint_id === el.dataset.deleteSprint).length;
          const name = sprint?.name || el.dataset.deleteSprint;
          if (!confirm(`Delete sprint '${name}'? ${reqCount} requirements are assigned to this sprint.`)) return;
          await api(`/api/roadmap/sprints/${el.dataset.deleteSprint}`, { method: 'DELETE' });
          await loadData();
        };
      });

      // Task edit buttons
      document.querySelectorAll('[data-edit-task]').forEach((el) => {
        el.onclick = (e) => {
          e.stopPropagation();
          openEditTask(el.dataset.editTask);
        };
      });
    }

    function fillSelect(selectId, items, valueKey = 'id', labelKey = 'name', includeBlank = false, blankText = 'Unassigned') {
      const sel = qs(selectId);
      sel.innerHTML = includeBlank ? `<option value="">${blankText}</option>` : '';
      for (const item of items) {
        sel.insertAdjacentHTML('beforeend', `<option value="${item[valueKey]}">${item[labelKey]}</option>`);
      }
    }

    async function openRequirement(reqId) {
      const req = state.requirements.find(r => r.id === reqId);
      if (!req) return;
      state.selectedReq = req;
      state.contextProjectId = req.project_id;

      qs('drawerTitle').textContent = `${req.code} ${req.title}`;
      fillSelect('dProject', state.projects, 'id', 'name');
      const sprints = state.sprints.filter(s => !s.project_id || s.project_id === req.project_id);
      fillSelect('dSprint', sprints, 'id', 'name', true, 'unassigned');
      qs('dCode').value = req.code || '';
      qs('dTitle').value = req.title || '';
      qs('dProject').value = req.project_id;
      qs('dSprint').value = req.sprint_id || '';
      qs('dPriority').value = req.priority;
      qs('dType').value = req.type;
      qs('dStatus').value = req.status;
      qs('dVersion').value = req.target_version || '';
      qs('dDescription').value = req.description || '';

      try {
        const links = await api(`/api/roadmap/requirements/${req.id}/handoffs`);
        const out = links.handoffs?.length
          ? links.handoffs.map((h) => `<div><a style="color:#9ec2ff" href="${h.url}" target="_blank" rel="noopener">${h.id}</a> ¬∑ ${h.status || '-'} ¬∑ ${h.task || ''}</div>`).join('')
          : 'None';
        qs('dHandoffs').innerHTML = out;
      } catch {
        qs('dHandoffs').textContent = 'None';
      }

      // Load dependencies (MP-014)
      try {
        const deps = await api(`/api/roadmap/dependencies?requirement_id=${req.id}`);
        if (deps.dependencies?.length) {
          qs('dDependencies').innerHTML = deps.dependencies.map(d =>
            `<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px">
              <span class="dep-link" onclick="openRequirementByCode('${d.depends_on_code}')">${d.depends_on_project_code || ''} ${d.depends_on_code}: ${d.depends_on_title}</span>
              <button class="icon-btn danger-btn" onclick="removeDependency('${d.id}')" title="Remove" style="font-size:10px">‚úï</button>
            </div>`
          ).join('');
        } else {
          qs('dDependencies').innerHTML = 'None';
        }
        // Add dependency selector
        const reqOpts = state.requirements
          .filter(r => r.id !== req.id)
          .map(r => `<option value="${r.id}">${r.code}: ${r.title}</option>`)
          .join('');
        const addDepHtml = `<div style="margin-top:6px;display:flex;gap:4px">
          <select id="addDepSelect" style="flex:1;font-size:11px"><option value="">Select requirement...</option>${reqOpts}</select>
          <button style="font-size:11px;padding:4px 8px" onclick="addDependency()">+ Dep</button>
        </div>`;
        const existingDep = document.getElementById('addDepWrap');
        if (existingDep) existingDep.remove();
        qs('dDependencies').insertAdjacentHTML('afterend', `<div id="addDepWrap">${addDepHtml}</div>`);
      } catch {
        qs('dDependencies').textContent = 'None';
      }

      // Load tasks (MP-012)
      try {
        const tasksRes = await api(`/api/roadmap/tasks?requirement_id=${req.id}`);
        if (tasksRes.tasks?.length) {
          qs('dTasks').innerHTML = tasksRes.tasks.map(t =>
            `<div style="margin-bottom:4px;display:flex;align-items:center;gap:6px">
              <span class="pill status-${t.status}">${t.status}</span> ${t.title}
              <button class="icon-btn" onclick="openEditTask('${t.id}')" title="Edit">‚úèÔ∏è</button>
            </div>`
          ).join('');
        } else {
          qs('dTasks').innerHTML = 'None';
        }
      } catch {
        qs('dTasks').textContent = 'None';
      }

      // Load test plans (MP-013)
      try {
        const tpRes = await api(`/api/roadmap/test-plans?requirement_id=${req.id}`);
        if (tpRes.test_plans?.length) {
          let tpHtml = '';
          for (const tp of tpRes.test_plans) {
            tpHtml += `<div style="margin-bottom:8px;border:1px solid var(--line);border-radius:6px;padding:6px">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <strong>${tp.name}</strong>
                <button class="icon-btn danger-btn" onclick="deleteTestPlan('${tp.id}')" title="Delete Plan">üóëÔ∏è</button>
              </div>`;
            if (tp.test_cases?.length) {
              for (const tc of tp.test_cases) {
                const statusOpts = ['pending','pass','fail','conditional_pass'].map(s =>
                  `<option value="${s}" ${tc.status===s?'selected':''}>${s}</option>`
                ).join('');
                tpHtml += `<div style="display:flex;align-items:center;gap:6px;margin:4px 0 4px 12px;font-size:12px">
                  <select style="font-size:11px;padding:2px 4px" onchange="updateTestCase('${tc.id}',this.value)">${statusOpts}</select>
                  <span>${tc.title}</span>
                </div>`;
              }
            } else {
              tpHtml += '<div style="margin-left:12px;font-size:12px;color:var(--muted)">No test cases</div>';
            }
            tpHtml += `<div style="margin-top:4px">
              <input id="newCase_${tp.id}" placeholder="New test case title" style="font-size:11px;padding:4px;width:60%" />
              <button style="font-size:11px;padding:4px 8px" onclick="addTestCase('${tp.id}')">+ Case</button>
            </div></div>`;
          }
          qs('dTestPlans').innerHTML = tpHtml;
        } else {
          qs('dTestPlans').innerHTML = 'None';
        }
      } catch {
        qs('dTestPlans').textContent = 'None';
      }

      // Add test plan button
      const addTpBtn = `<div style="margin-top:6px">
        <input id="newTestPlanName" placeholder="New test plan name" style="font-size:12px;padding:4px;width:60%" />
        <button style="font-size:12px;padding:4px 8px" onclick="addTestPlan()">+ Plan</button>
      </div>`;
      qs('dTestPlans').insertAdjacentHTML('afterend', '');
      const existing = document.getElementById('addTestPlanWrap');
      if (existing) existing.remove();
      qs('dTestPlans').insertAdjacentHTML('afterend', `<div id="addTestPlanWrap">${addTpBtn}</div>`);

      qs('drawer').classList.add('open');
    }

    async function saveRequirement() {
      const req = state.selectedReq;
      if (!req) return;

      const newStatus = qs('dStatus').value;
      // MP-016: Reopen confirmation guard
      if (req.status === 'done' && newStatus !== 'done') {
        if (!confirm(`Reopen requirement '${req.code}'? This will change status from done to ${newStatus}.`)) return;
      }

      const payload = {
        title: qs('dTitle').value.trim(),
        priority: qs('dPriority').value,
        type: qs('dType').value,
        status: newStatus,
        sprint_id: qs('dSprint').value || null,
        description: qs('dDescription').value,
        target_version: qs('dVersion').value || null
      };

      await api(`/api/roadmap/requirements/${req.id}`, { method: 'PUT', body: JSON.stringify(payload) });
      qs('drawer').classList.remove('open');
      state.selectedReq = null;
      await loadData();
    }

    async function deleteSelectedRequirement() {
      const req = state.selectedReq;
      if (!req) return;
      if (!confirm(`Delete requirement '${req.code} ‚Äî ${req.title}'?`)) return;
      await api(`/api/roadmap/requirements/${req.id}`, { method: 'DELETE' });
      qs('drawer').classList.remove('open');
      state.selectedReq = null;
      await loadData();
    }

    function openEditProject(projectId) {
      const project = state.projects.find(p => p.id === projectId);
      if (!project) return;
      state.editKind = 'project';
      state.editId = projectId;
      qs('editTitle').textContent = 'Edit Project';
      const catOpts = state.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
      qs('editFields').innerHTML = `
        <div class="grid2">
          <div><label>Code</label><input id="eCode" value="${project.code || ''}" readonly /></div>
          <div><label>Name</label><input id="eName" value="${project.name || ''}" /></div>
          <div><label>Emoji</label><input id="eEmoji" value="${project.emoji || ''}" /></div>
          <div><label>Version</label><input id="eVersion" value="${project.current_version || ''}" /></div>
          <div><label>Status</label><select id="eStatus"><option value="active">active</option><option value="stable">stable</option><option value="paused">paused</option><option value="archived">archived</option></select></div>
          <div><label>Category</label><select id="eCategory"><option value="">None</option>${catOpts}</select></div>
        </div>`;
      qs('eStatus').value = project.status || 'active';
      qs('eCategory').value = project.category_id || '';
      qs('editModal').classList.add('open');
    }

    function openEditSprint(sprintId) {
      const sprint = state.sprints.find(s => s.id === sprintId);
      if (!sprint) return;
      state.editKind = 'sprint';
      state.editId = sprintId;
      qs('editTitle').textContent = 'Edit Sprint';
      qs('editFields').innerHTML = `
        <div class="grid2">
          <div><label>Name</label><input id="eName" value="${sprint.name || ''}" /></div>
          <div><label>Status</label><select id="eStatus"><option value="active">active</option><option value="planned">planned</option><option value="complete">complete</option></select></div>
        </div>`;
      qs('eStatus').value = sprint.status || 'planned';
      qs('editModal').classList.add('open');
    }

    function openEditTask(taskId) {
      const task = state.tasks.find(t => t.id === taskId);
      if (!task) return;
      state.editKind = 'task';
      state.editId = taskId;
      qs('editTitle').textContent = 'Edit Task';
      qs('editFields').innerHTML = `
        <div class="grid2">
          <div><label>Title</label><input id="eName" value="${(task.title || '').replace(/"/g, '&quot;')}" /></div>
          <div><label>Status</label><select id="eStatus"><option value="backlog">backlog</option><option value="in_progress">in_progress</option><option value="done">done</option></select></div>
          <div><label>Priority</label><select id="ePriority"><option>P1</option><option>P2</option><option>P3</option></select></div>
          <div><label>Assignee</label><input id="eAssignee" value="${task.assignee || ''}" /></div>
        </div>
        <div><label>Description</label><textarea id="eDescription">${task.description || ''}</textarea></div>
        <div style="margin-top:8px"><button class="danger-btn" id="deleteTaskBtn">Delete Task</button></div>`;
      qs('eStatus').value = task.status || 'backlog';
      qs('ePriority').value = task.priority || 'P2';
      qs('editModal').classList.add('open');
      // Bind delete task button
      qs('deleteTaskBtn').onclick = async () => {
        if (!confirm(`Delete task '${task.title}'?`)) return;
        await api(`/api/roadmap/tasks/${taskId}`, { method: 'DELETE' });
        qs('editModal').classList.remove('open');
        state.editKind = null;
        state.editId = null;
        await loadData();
      };
    }

    async function saveEdit() {
      if (state.editKind === 'project' && state.editId) {
        await api(`/api/roadmap/projects/${state.editId}`, {
          method: 'PUT',
          body: JSON.stringify({
            name: qs('eName').value.trim(),
            emoji: qs('eEmoji').value.trim() || null,
            current_version: qs('eVersion').value.trim() || null,
            status: qs('eStatus').value,
            category_id: qs('eCategory')?.value || null
          })
        });
      }
      if (state.editKind === 'sprint' && state.editId) {
        await api(`/api/roadmap/sprints/${state.editId}`, {
          method: 'PUT',
          body: JSON.stringify({
            name: qs('eName').value.trim(),
            status: qs('eStatus').value
          })
        });
      }
      if (state.editKind === 'task' && state.editId) {
        await api(`/api/roadmap/tasks/${state.editId}`, {
          method: 'PUT',
          body: JSON.stringify({
            title: qs('eName').value.trim(),
            status: qs('eStatus').value,
            priority: qs('ePriority').value,
            assignee: qs('eAssignee')?.value?.trim() || null,
            description: qs('eDescription')?.value || null
          })
        });
      }
      qs('editModal').classList.remove('open');
      state.editKind = null;
      state.editId = null;
      await loadData();
    }

    function openAdd(kind) {
      state.addKind = kind;
      const projectDefault = state.contextProjectId || state.projects[0]?.id || '';
      qs('addTitle').textContent = `Create ${kind}`;

      if (kind === 'project') {
        const catOptions = state.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        qs('addFields').innerHTML = `
          <div class="grid2">
            <div><label>Code</label><input id="aCode" placeholder="MP" /></div>
            <div><label>Name</label><input id="aName" placeholder="MetaPM" /></div>
            <div><label>Emoji</label><input id="aEmoji" placeholder="üî¥" /></div>
            <div><label>Version</label><input id="aVersion" placeholder="2.1.7" /></div>
            <div><label>Category</label><select id="aCategory"><option value="">None</option>${catOptions}</select></div>
          </div>`;
      } else if (kind === 'sprint') {
        qs('addFields').innerHTML = `
          <div class="grid2">
            <div><label>Project</label><select id="aProject">${state.projects.map(p => `<option value="${p.id}" ${p.id === projectDefault ? 'selected' : ''}>${p.name}</option>`).join('')}</select></div>
            <div><label>Name</label><input id="aName" placeholder="Sprint 4.2" /></div>
            <div><label>Status</label><select id="aStatus"><option value="active">active</option><option value="planned">planned</option><option value="complete">complete</option></select></div>
          </div>`;
      } else {
        const type = kind === 'bug' ? 'bug' : kind === 'task' ? 'task' : 'feature';
        qs('addFields').innerHTML = `
          <div class="grid2">
            <div><label>Project</label><select id="aProject">${state.projects.map(p => `<option value="${p.id}" ${p.id === projectDefault ? 'selected' : ''}>${p.name}</option>`).join('')}</select></div>
            <div><label>Sprint</label><select id="aSprint"><option value="">unassigned</option>${state.sprints.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select></div>
            <div><label>Code</label><input id="aCode" placeholder="MP-018" /></div>
            <div><label>Title</label><input id="aTitle" placeholder="Title" /></div>
            <div><label>Priority</label><select id="aPriority"><option>P1</option><option selected>P2</option><option>P3</option></select></div>
            <div><label>Status</label><select id="aStatus"><option value="backlog">backlog</option><option value="planned">planned</option><option value="in_progress">in_progress</option><option value="uat">uat</option><option value="needs_fixes">needs_fixes</option><option value="conditional_pass">conditional_pass</option><option value="done">done</option></select></div>
            <div><label>Type</label><input id="aType" value="${type}" /></div>
          </div>
          <div><label>Description</label><textarea id="aDescription"></textarea></div>`;
      }

      qs('addModal').classList.add('open');
    }

    async function saveAdd() {
      const kind = state.addKind;
      try {
        if (kind === 'project') {
          await api('/api/roadmap/projects', {
            method: 'POST',
            body: JSON.stringify({
              id: makeId(),
              code: qs('aCode').value.trim().toUpperCase(),
              name: qs('aName').value.trim(),
              emoji: qs('aEmoji').value.trim() || null,
              current_version: qs('aVersion').value.trim() || null,
              category_id: qs('aCategory')?.value || null,
              status: 'active'
            })
          });
        } else if (kind === 'sprint') {
          await api('/api/roadmap/sprints', {
            method: 'POST',
            body: JSON.stringify({
              id: makeId(),
              project_id: qs('aProject').value,
              name: qs('aName').value.trim(),
              status: qs('aStatus').value
            })
          });
        } else {
          await api('/api/roadmap/requirements', {
            method: 'POST',
            body: JSON.stringify({
              id: makeId(),
              project_id: qs('aProject').value,
              sprint_id: qs('aSprint').value || null,
              code: qs('aCode').value.trim().toUpperCase(),
              title: qs('aTitle').value.trim(),
              description: qs('aDescription').value,
              type: qs('aType').value,
              priority: qs('aPriority').value,
              status: qs('aStatus').value
            })
          });
        }
      } catch (err) {
        const code = qs('aCode') ? qs('aCode').value.trim().toUpperCase() : '';
        showToast(friendlyCreateError(kind, err?.message || '', code));
        return;
      }

      qs('addModal').classList.remove('open');
      if (kind === 'project') {
        qs('projectFilter').value = '';
      }
      await loadData();
    }

    // Dependency CRUD helpers (MP-014)
    async function addDependency() {
      const req = state.selectedReq;
      if (!req) return;
      const depId = qs('addDepSelect')?.value;
      if (!depId) { showToast('Select a requirement to depend on'); return; }
      try {
        await api('/api/roadmap/dependencies', {
          method: 'POST',
          body: JSON.stringify({ requirement_id: req.id, depends_on_id: depId })
        });
        await openRequirement(req.id);
      } catch (err) { showToast(err.message); }
    }

    async function removeDependency(depId) {
      if (!confirm('Remove this dependency?')) return;
      try {
        await api(`/api/roadmap/dependencies/${depId}`, { method: 'DELETE' });
        if (state.selectedReq) await openRequirement(state.selectedReq.id);
      } catch (err) { showToast(err.message); }
    }

    function openRequirementByCode(code) {
      const req = state.requirements.find(r => r.code === code);
      if (req) openRequirement(req.id);
    }

    // Test Plan/Case CRUD helpers (MP-013)
    async function addTestPlan() {
      const req = state.selectedReq;
      if (!req) return;
      const name = qs('newTestPlanName')?.value?.trim();
      if (!name) { showToast('Enter a test plan name'); return; }
      try {
        await api('/api/roadmap/test-plans', {
          method: 'POST',
          body: JSON.stringify({ requirement_id: req.id, name, test_cases: [] })
        });
        await openRequirement(req.id);
      } catch (err) { showToast(err.message); }
    }

    async function addTestCase(planId) {
      const input = document.getElementById(`newCase_${planId}`);
      const title = input?.value?.trim();
      if (!title) { showToast('Enter a test case title'); return; }
      try {
        await api(`/api/roadmap/test-plans/${planId}/cases`, {
          method: 'POST',
          body: JSON.stringify({ title })
        });
        if (state.selectedReq) await openRequirement(state.selectedReq.id);
      } catch (err) { showToast(err.message); }
    }

    async function updateTestCase(caseId, newStatus) {
      try {
        await api(`/api/roadmap/test-cases/${caseId}`, {
          method: 'PUT',
          body: JSON.stringify({ status: newStatus })
        });
        showToast('Test case updated', 'success');
      } catch (err) { showToast(err.message); }
    }

    async function deleteTestPlan(planId) {
      if (!confirm('Delete this test plan and all its test cases?')) return;
      try {
        await api(`/api/roadmap/test-plans/${planId}`, { method: 'DELETE' });
        if (state.selectedReq) await openRequirement(state.selectedReq.id);
      } catch (err) { showToast(err.message); }
    }

    async function loadData() {
      const [projectsRes, requirementsRes, sprintsRes, categoriesRes, tasksRes] = await Promise.all([
        api('/api/roadmap/projects?limit=200&offset=0'),
        api('/api/roadmap/requirements?limit=500&offset=0'),
        api('/api/roadmap/sprints?limit=200&offset=0'),
        api('/api/roadmap/categories').catch(() => ({ categories: [] })),
        api('/api/roadmap/tasks?limit=500').catch(() => ({ tasks: [] }))
      ]);

      state.projects = projectsRes.projects || [];
      state.requirements = requirementsRes.requirements || [];
      state.sprints = sprintsRes.sprints || [];
      state.categories = categoriesRes.categories || [];
      state.tasks = tasksRes.tasks || [];

      // Populate category filter
      const cf = qs('categoryFilter');
      const currentCat = cf.value;
      cf.innerHTML = '<option value="">All Categories</option>';
      for (const c of state.categories) {
        cf.insertAdjacentHTML('beforeend', `<option value="${c.id}">${c.name}</option>`);
      }
      if (currentCat) cf.value = currentCat;

      // Populate project filter with requirement counts
      const pf = qs('projectFilter');
      const current = pf.value;
      pf.innerHTML = '<option value="">All Projects</option>';
      for (const p of state.projects) {
        const reqCount = state.requirements.filter(r => r.project_id === p.id).length;
        pf.insertAdjacentHTML('beforeend', `<option value="${p.id}">${p.emoji || ''} ${p.name} (${reqCount})</option>`);
      }
      if (current) pf.value = current;

      if (!state.expanded.size && state.projects.length) state.expanded.add(state.projects[0].id);
      render();
    }

    function bindControls() {
      ['categoryFilter', 'projectFilter', 'priorityFilter', 'statusFilter', 'sortBy', 'groupBy'].forEach((id) => {
        qs(id).onchange = () => {
          updateResetButtonState();
          render();
        };
      });
      qs('searchInput').addEventListener('input', () => {
        updateResetButtonState();
        render();
      });
      qs('searchInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          render();
        }
      });
      qs('closeBtn').onclick = () => {
        qs('drawer').classList.remove('open');
        state.selectedReq = null;
      };
      qs('saveBtn').onclick = () => saveRequirement().catch(err => showToast(err.message));
      qs('deleteReqBtn').onclick = () => deleteSelectedRequirement().catch(err => showToast(err.message));

      qs('resetFiltersBtn').onclick = () => {
        qs('categoryFilter').value = '';
        qs('projectFilter').value = '';
        qs('priorityFilter').value = '';
        qs('statusFilter').value = '';
        qs('searchInput').value = '';
        updateResetButtonState();
        render();
      };

      qs('addBtn').onclick = () => qs('addMenu').classList.toggle('open');
      qs('addMenu').onclick = (e) => {
        const btn = e.target.closest('button[data-kind]');
        if (!btn) return;
        qs('addMenu').classList.remove('open');
        openAdd(btn.dataset.kind);
      };

      qs('addClose').onclick = () => qs('addModal').classList.remove('open');
      qs('addSave').onclick = () => saveAdd().catch(err => showToast(err.message));

      qs('editClose').onclick = () => {
        qs('editModal').classList.remove('open');
        state.editKind = null;
        state.editId = null;
      };
      qs('editSave').onclick = () => saveEdit().catch(err => showToast(err.message));

      qs('expandAllBtn').onclick = () => {
        state.expanded = new Set(getFilteredRequirements().map((r) => r.project_id));
        render();
      };
      qs('collapseAllBtn').onclick = () => {
        state.expanded.clear();
        render();
      };

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.add-wrap')) qs('addMenu').classList.remove('open');
      });
    }

    bindControls();
    loadVersion();
    loadData().catch((err) => {
      qs('hierarchy').innerHTML = `<div style="color:#ff9a9a">Failed to load data: ${err.message}</div>`;
    });
  </script>
</body>
</html>
