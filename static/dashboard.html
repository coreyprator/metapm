<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MetaPM Dashboard</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #111a2d;
      --panel-soft: #0f1729;
      --text: #e6edf8;
      --muted: #9aa8c7;
      --line: #26344f;
      --accent: #e74c3c;
      --ok: #23a55a;
      --warn: #f5a623;
      --info: #4a90d9;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .app {
      max-width: 1320px;
      margin: 0 auto;
      padding: 16px;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 10px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      margin-bottom: 10px;
    }
    .title { font-size: 22px; font-weight: 700; }
    .controls {
      padding: 12px 16px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    .control-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    label { color: var(--muted); font-size: 12px; }
    select, input, textarea, button {
      border: 1px solid var(--line);
      background: var(--panel-soft);
      color: var(--text);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 13px;
    }
    textarea { width: 100%; min-height: 90px; resize: vertical; }
    button { cursor: pointer; }
    .add-wrap { position: relative; }
    .add-menu {
      position: absolute;
      top: 36px;
      right: 0;
      min-width: 180px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 8px;
      display: none;
      z-index: 5;
    }
    .add-menu.open { display: block; }
    .add-menu button {
      width: 100%;
      border: 0;
      border-bottom: 1px solid var(--line);
      border-radius: 0;
      text-align: left;
      background: transparent;
    }
    .add-menu button:last-child { border-bottom: 0; }
    .hierarchy { padding: 10px; }
    .project {
      margin-bottom: 8px;
      border: 1px solid var(--line);
      border-left: 5px solid var(--info);
      border-radius: 8px;
      overflow: hidden;
      background: var(--panel-soft);
    }
    .project-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      cursor: pointer;
      user-select: none;
    }
    .project-summary { color: var(--muted); font-size: 12px; }
    .project-body { display: none; border-top: 1px solid var(--line); }
    .project-body.open { display: block; }
    .bucket { padding: 6px 10px; }
    .bucket-title {
      color: var(--muted);
      font-size: 12px;
      margin: 4px 0 6px;
      font-weight: 600;
    }
    .req-row {
      display: grid;
      grid-template-columns: 1fr auto auto auto auto;
      gap: 8px;
      align-items: center;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid var(--line);
      margin-bottom: 6px;
      background: #0f182b;
      cursor: pointer;
    }
    .req-row:hover { background: #13203a; }
    .pill { font-size: 11px; border-radius: 999px; padding: 2px 8px; border: 1px solid var(--line); color: var(--muted); }
    .p1 { color: #ff9a9a; border-color: #803c3c; }
    .p2 { color: #ffd18a; border-color: #7a5a2f; }
    .status-done { color: #9de2b4; border-color: #2f6e46; }
    .status-in_progress { color: #9ec2ff; border-color: #34507c; }
    .drawer {
      position: fixed;
      top: 0;
      right: -520px;
      width: 520px;
      max-width: 100%;
      height: 100%;
      background: var(--panel);
      border-left: 1px solid var(--line);
      transition: right .2s;
      z-index: 20;
      padding: 14px;
      overflow: auto;
    }
    .drawer.open { right: 0; }
    .drawer-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .footer {
      margin-top: 10px;
      padding: 12px 14px;
      color: var(--muted);
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
      padding: 12px;
    }
    .modal.open { display: flex; }
    .modal-card {
      width: 560px;
      max-width: 100%;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 14px;
    }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .del-btn { background: #7f1d1d; color: #fecaca; border: 1px solid #991b1b; padding: 4px 10px; font-size: 12px; border-radius: 4px; cursor: pointer; }
    .del-btn:hover { background: #991b1b; }
    .edit-icon { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 13px; padding: 2px 5px; border-radius: 3px; }
    .edit-icon:hover { background: rgba(255,255,255,0.12); color: var(--text); }
    .toast { position: fixed; bottom: 20px; right: 20px; background: #1f2d3d; color: var(--text); border: 1px solid var(--line); border-radius: 8px; padding: 10px 18px; z-index: 100; font-size: 13px; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>
  <div class="app">
    <div class="card header">
      <div class="title">üî¥ MetaPM <span id="appVersion" style="font-size:13px;color:var(--muted);font-weight:400"></span></div>
      <div class="add-wrap">
        <button id="addBtn">+ Add ‚ñæ</button>
        <div id="addMenu" class="add-menu">
          <button data-kind="project">Project</button>
          <button data-kind="sprint">Sprint</button>
          <button data-kind="requirement">Requirement</button>
          <button data-kind="bug">Bug</button>
          <button data-kind="task">Task</button>
        </div>
      </div>
    </div>

    <div class="card controls">
      <div class="control-row">
        <label>Filter</label>
        <select id="projectFilter"><option value="">All Projects</option></select>
        <select id="priorityFilter"><option value="">All Priorities</option><option>P1</option><option>P2</option><option>P3</option></select>
        <select id="statusFilter"><option value="">All Status</option><option value="backlog">backlog</option><option value="planned">planned</option><option value="in_progress">in_progress</option><option value="uat">uat</option><option value="needs_fixes">needs_fixes</option><option value="done">done</option></select>
      </div>
      <div class="control-row">
        <label>Sort/Group</label>
        <select id="sortBy"><option value="priority">Priority</option><option value="code">Code</option><option value="title">Title</option></select>
        <select id="groupBy"><option value="project">By Project</option></select>
        <button id="expandAllBtn" style="font-size:11px;padding:3px 10px;margin-left:8px;background:var(--card);border:1px solid var(--border);border-radius:4px;color:var(--fg);cursor:pointer;">‚ñº Expand All</button>
        <input id="searchBox" type="text" placeholder="üîç Search..." style="padding:5px 10px;font-size:12px;width:200px;border-radius:4px;border:1px solid var(--line);background:var(--panel-soft);color:var(--text);">
      </div>
    </div>

    <div class="card hierarchy" id="hierarchy"></div>

    <div class="card footer" id="summary">
      <div>Total: 0 | Done: 0 | In Progress: 0 | Backlog: 0</div>
      <div id="nextP1">Next P1: -</div>
    </div>
  </div>

  <aside class="drawer" id="drawer">
    <div class="drawer-head">
      <strong id="drawerTitle">Requirement</strong>
      <div style="display:flex;gap:6px">
        <button id="saveBtn">Save</button>
        <button id="delReqBtn" class="del-btn" title="Delete requirement">üóë</button>
        <button id="closeBtn">Close</button>
      </div>
    </div>
    <div>
      <label>Title</label>
      <input id="dTitle" style="width:100%;margin-bottom:8px" />
    </div>
    <div class="grid2">
      <div>
        <label>Project</label>
        <select id="dProject"></select>
      </div>
      <div>
        <label>Sprint</label>
        <select id="dSprint"></select>
      </div>
      <div>
        <label>Priority</label>
        <select id="dPriority"><option>P1</option><option>P2</option><option>P3</option></select>
      </div>
      <div>
        <label>Type</label>
        <select id="dType"><option value="feature">feature</option><option value="bug">bug</option><option value="enhancement">enhancement</option><option value="task">task</option></select>
      </div>
      <div>
        <label>Status</label>
        <select id="dStatus"><option value="backlog">backlog</option><option value="planned">planned</option><option value="in_progress">in_progress</option><option value="uat">uat</option><option value="needs_fixes">needs_fixes</option><option value="done">done</option></select>
      </div>
      <div>
        <label>Target Version</label>
        <input id="dVersion" />
      </div>
    </div>
    <div>
      <label>Description</label>
      <textarea id="dDescription"></textarea>
    </div>
    <div>
      <label>Notes</label>
      <textarea id="dNotes"></textarea>
    </div>
    <div>
      <label>Linked Handoffs</label>
      <div id="dHandoffs" style="font-size:13px;color:var(--muted)">None</div>
    </div>
  </aside>

  <div class="modal" id="addModal">
    <div class="modal-card">
      <div class="drawer-head">
        <strong id="addTitle">Create</strong>
        <button id="addClose">Close</button>
      </div>
      <div id="addFields"></div>
      <div style="margin-top:10px;display:flex;justify-content:flex-end;gap:8px">
        <button id="addSave">Create</button>
      </div>
    </div>
  </div>

  <script>
    const PROJECT_COLORS = {
      HL: '#4A90D9', SF: '#F5A623', AF: '#E8751A', EM: '#9B59B6', MP: '#E74C3C', PM: '#27AE60'
    };

    const state = {
      projects: [],
      requirements: [],
      sprints: [],
      expanded: new Set(),
      selectedReq: null,
      contextProjectId: null,
      addKind: null,
      editMode: false,
      editId: null
    };

    const qs = (id) => document.getElementById(id);

    async function api(path, options = {}) {
      const res = await fetch(path, { headers: { 'Content-Type': 'application/json' }, ...options });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      if (res.status === 204) return null;
      return await res.json();
    }

    function makeId(prefix) { return crypto.randomUUID(); }

    function normalizeReqText(req) { return `${req.code} ${req.title}`.toLowerCase(); }

    function getFilteredRequirements() {
      const project = qs('projectFilter').value;
      const priority = qs('priorityFilter').value;
      const status = qs('statusFilter').value;
      return state.requirements.filter((req) => {
        if (project && req.project_id !== project) return false;
        if (priority && req.priority !== priority) return false;
        if (status && req.status !== status) return false;
        return true;
      });
    }

    function compareReq(a, b) {
      const by = qs('sortBy').value;
      if (by === 'priority') {
        const weight = { P1: 1, P2: 2, P3: 3 };
        return (weight[a.priority] || 9) - (weight[b.priority] || 9) || a.code.localeCompare(b.code);
      }
      if (by === 'title') return a.title.localeCompare(b.title);
      return a.code.localeCompare(b.code);
    }

    function setSummary(reqs) {
      const total = reqs.length;
      const done = reqs.filter(r => r.status === 'done').length;
      const inProgress = reqs.filter(r => r.status === 'in_progress').length;
      const backlog = reqs.filter(r => r.status === 'backlog').length;
      qs('summary').children[0].textContent = `Total: ${total} | Done: ${done} | In Progress: ${inProgress} | Backlog: ${backlog}`;
      const nextP1 = reqs.filter(r => r.priority === 'P1' && r.status !== 'done').sort(compareReq)[0];
      qs('nextP1').textContent = `Next P1: ${nextP1 ? `${nextP1.code} (${projectName(nextP1.project_id)})` : '-'}`;
    }

    function projectName(id) {
      const p = state.projects.find(x => x.id === id);
      return p ? p.name : id;
    }

    function sprintName(id) {
      if (!id) return 'Backlog';
      const s = state.sprints.find(x => x.id === id);
      return s ? s.name : 'Backlog';
    }

    function groupedForProject(projectId, reqs) {
      const list = reqs.filter(r => r.project_id === projectId).sort(compareReq);
      const buckets = { sprint: {}, backlog: [], done: [] };
      for (const req of list) {
        if (req.status === 'done') buckets.done.push(req);
        else if (!req.sprint_id) buckets.backlog.push(req);
        else {
          if (!buckets.sprint[req.sprint_id]) buckets.sprint[req.sprint_id] = [];
          buckets.sprint[req.sprint_id].push(req);
        }
      }
      return buckets;
    }

    function rowHtml(req) {
      const searchable = `${req.code} ${req.title} ${req.type} ${req.priority} ${req.status} ${req.project_name || ''}`.toLowerCase();
      return `<div class="req-row" data-req="${req.id}" data-searchable="${searchable}">
        <div><strong>${req.code}</strong> ${req.title}</div>
        <span class="pill ${req.priority.toLowerCase()}">${req.priority}</span>
        <span class="pill status-${req.status}">${req.status}</span>
        <span class="pill">${req.type}</span>
        <span>‚ñ∏</span>
      </div>`;
    }

    function render() {
      const reqs = getFilteredRequirements();
      const hierarchy = qs('hierarchy');
      hierarchy.innerHTML = '';

      for (const p of state.projects) {
        const pReqs = reqs.filter(r => r.project_id === p.id);

        const done = pReqs.filter(r => r.status === 'done').length;
        const p1 = pReqs.filter(r => r.priority === 'P1').length;
        const p2 = pReqs.filter(r => r.priority === 'P2').length;
        const open = state.expanded.has(p.id);
        const color = PROJECT_COLORS[p.code] || p.color || '#4A90D9';

        const buckets = groupedForProject(p.id, reqs);
        const sprintBlocks = Object.keys(buckets.sprint).map((sid) => `
          <div class="bucket"><div class="bucket-title" style="display:flex;justify-content:space-between;align-items:center;">Sprint: ${sprintName(sid)}<button class="edit-icon" data-edit-sprint="${sid}" title="Edit sprint">‚úèÔ∏è</button></div>${buckets.sprint[sid].map(rowHtml).join('')}</div>
        `).join('');

        const html = `
          <section class="project" style="border-left-color:${color}">
            <div class="project-head" data-project="${p.id}" data-searchable="${(p.name+' '+(p.code||'')).toLowerCase()}">
              <div>${open ? '‚ñº' : '‚ñ∂'} ${p.emoji || ''} ${p.name} ${p.current_version || ''}</div>
              <div style="display:flex;align-items:center;gap:10px">
                <span class="project-summary">${done} done | ${p1} P1 | ${p2} P2</span>
                <button class="edit-icon" data-edit-project="${p.id}" title="Edit project">‚úèÔ∏è</button>
              </div>
            </div>
            <div class="project-body ${open ? 'open' : ''}">
              ${sprintBlocks}
              <div class="bucket"><div class="bucket-title">Backlog (unassigned)</div>${buckets.backlog.map(rowHtml).join('') || '<div class="project-summary">None</div>'}</div>
              <div class="bucket"><div class="bucket-title">Done</div>${buckets.done.map(rowHtml).join('') || '<div class="project-summary">None</div>'}</div>
            </div>
          </section>`;

        hierarchy.insertAdjacentHTML('beforeend', html);
      }

      if (!hierarchy.children.length) hierarchy.innerHTML = '<div class="project-summary">No matching requirements.</div>';
      setSummary(reqs);
      bindHierarchyEvents();
    }

    function bindHierarchyEvents() {
      document.querySelectorAll('[data-project]').forEach((el) => {
        el.onclick = (e) => {
          if (e.target.closest('[data-edit-project]')) return;
          const id = el.dataset.project;
          if (state.expanded.has(id)) state.expanded.delete(id); else state.expanded.add(id);
          state.contextProjectId = id;
          render();
        };
      });

      document.querySelectorAll('[data-req]').forEach((el) => {
        el.onclick = () => openRequirement(el.dataset.req);
      });

      document.querySelectorAll('[data-edit-project]').forEach((el) => {
        el.onclick = (e) => { e.stopPropagation(); openEdit('project', el.dataset.editProject); };
      });

      document.querySelectorAll('[data-edit-sprint]').forEach((el) => {
        el.onclick = (e) => { e.stopPropagation(); openEdit('sprint', el.dataset.editSprint); };
      });
    }

    function fillSelect(selectId, items, valueKey = 'id', labelKey = 'name', includeBlank = false, blankText = 'Unassigned') {
      const sel = qs(selectId);
      sel.innerHTML = includeBlank ? `<option value="">${blankText}</option>` : '';
      for (const item of items) {
        sel.insertAdjacentHTML('beforeend', `<option value="${item[valueKey]}">${item[labelKey]}</option>`);
      }
    }

    async function openRequirement(reqId) {
      const req = state.requirements.find(r => r.id === reqId);
      if (!req) return;
      state.selectedReq = req;
      state.contextProjectId = req.project_id;

      qs('drawerTitle').textContent = `${req.code} ${req.title}`;
      qs('dTitle').value = req.title;
      fillSelect('dProject', state.projects, 'id', 'name');
      const sprints = state.sprints.filter(s => !s.project_id || s.project_id === req.project_id);
      fillSelect('dSprint', sprints, 'id', 'name', true, 'unassigned');
      qs('dProject').value = req.project_id;
      qs('dSprint').value = req.sprint_id || '';
      qs('dPriority').value = req.priority;
      qs('dType').value = req.type;
      qs('dStatus').value = req.status;
      qs('dVersion').value = req.target_version || '';
      qs('dDescription').value = req.description || '';
      qs('dNotes').value = '';

      try {
        const links = await api(`/api/roadmap/requirements/${req.id}/handoffs`);
        const out = links.handoffs?.length
          ? links.handoffs.map((h) => `<div><a style="color:#9ec2ff" href="${h.url}" target="_blank" rel="noopener">${h.id}</a> ¬∑ ${h.status || '-'} ¬∑ ${h.task || ''}</div>`).join('')
          : 'None';
        qs('dHandoffs').innerHTML = out;
      } catch {
        qs('dHandoffs').textContent = 'None';
      }

      qs('drawer').classList.add('open');
    }

    async function saveRequirement() {
      const req = state.selectedReq;
      if (!req) return;

      const payload = {
        title: qs('dTitle').value,
        priority: qs('dPriority').value,
        type: qs('dType').value,
        status: qs('dStatus').value,
        sprint_id: qs('dSprint').value || null,
        description: qs('dDescription').value,
        target_version: qs('dVersion').value || null
      };

      await api(`/api/roadmap/requirements/${req.id}`, { method: 'PUT', body: JSON.stringify(payload) });
      await loadData();
      await openRequirement(req.id);
    }

    function openAdd(kind) {
      state.addKind = kind;
      const projectDefault = state.contextProjectId || state.projects[0]?.id || '';
      qs('addTitle').textContent = `Create ${kind}`;

      if (kind === 'project') {
        qs('addFields').innerHTML = `
          <div class="grid2">
            <div><label>Code</label><input id="aCode" placeholder="MP" /></div>
            <div><label>Name</label><input id="aName" placeholder="MetaPM" /></div>
            <div><label>Emoji</label><input id="aEmoji" placeholder="üî¥" /></div>
            <div><label>Version</label><input id="aVersion" placeholder="2.1.7" /></div>
          </div>`;
      } else if (kind === 'sprint') {
        qs('addFields').innerHTML = `
          <div class="grid2">
            <div><label>Project</label><select id="aProject">${state.projects.map(p => `<option value="${p.id}" ${p.id === projectDefault ? 'selected' : ''}>${p.name}</option>`).join('')}</select></div>
            <div><label>Name</label><input id="aName" placeholder="Sprint 4.2" /></div>
            <div><label>Status</label><select id="aStatus"><option value="active">active</option><option value="planned">planned</option><option value="complete">complete</option></select></div>
          </div>`;
      } else {
        const type = kind === 'bug' ? 'bug' : kind === 'task' ? 'task' : 'feature';
        qs('addFields').innerHTML = `
          <div class="grid2">
            <div><label>Project</label><select id="aProject">${state.projects.map(p => `<option value="${p.id}" ${p.id === projectDefault ? 'selected' : ''}>${p.name}</option>`).join('')}</select></div>
            <div><label>Code</label><input id="aCode" placeholder="MP-018" /></div>
            <div><label>Title</label><input id="aTitle" placeholder="Title" /></div>
            <div><label>Priority</label><select id="aPriority"><option>P1</option><option selected>P2</option><option>P3</option></select></div>
            <div><label>Status</label><select id="aStatus"><option value="backlog">backlog</option><option value="planned">planned</option><option value="in_progress">in_progress</option><option value="uat">uat</option><option value="needs_fixes">needs_fixes</option><option value="done">done</option></select></div>
            <div><label>Type</label><select id="aType"><option value="feature" ${type==='feature'?'selected':''}>feature</option><option value="bug" ${type==='bug'?'selected':''}>bug</option><option value="enhancement" ${type==='enhancement'?'selected':''}>enhancement</option><option value="task" ${type==='task'?'selected':''}>task</option></select></div>
          </div>
          <div><label>Description</label><textarea id="aDescription"></textarea></div>`;
      }

      qs('addModal').classList.add('open');
    }

    async function saveAdd() {
      const kind = state.addKind;

      if (state.editMode) {
        const id = state.editId;
        if (kind === 'project') {
          await api(`/api/roadmap/projects/${id}`, {
            method: 'PUT',
            body: JSON.stringify({
              name: qs('aName').value.trim(),
              emoji: qs('aEmoji').value.trim() || null,
              current_version: qs('aVersion').value.trim() || null,
              status: qs('aStatus').value,
              repo_url: qs('aRepoUrl') ? qs('aRepoUrl').value.trim() || null : null
            })
          });
        } else if (kind === 'sprint') {
          await api(`/api/roadmap/sprints/${id}`, {
            method: 'PUT',
            body: JSON.stringify({
              project_id: qs('aProject').value,
              name: qs('aName').value.trim(),
              status: qs('aStatus').value
            })
          });
        }
        state.editMode = false;
        state.editId = null;
        qs('addModal').classList.remove('open');
        qs('addSave').textContent = 'Create';
        await loadData();
        return;
      }

      if (kind === 'project') {
        await api('/api/roadmap/projects', {
          method: 'POST',
          body: JSON.stringify({
            id: makeId('proj'),
            code: qs('aCode').value.trim().toUpperCase(),
            name: qs('aName').value.trim(),
            emoji: qs('aEmoji').value.trim() || null,
            current_version: qs('aVersion').value.trim() || null,
            status: 'active'
          })
        });
      } else if (kind === 'sprint') {
        await api('/api/roadmap/sprints', {
          method: 'POST',
          body: JSON.stringify({
            id: makeId('spr'),
            project_id: qs('aProject').value,
            name: qs('aName').value.trim(),
            status: qs('aStatus').value
          })
        });
      } else {
        await api('/api/roadmap/requirements', {
          method: 'POST',
          body: JSON.stringify({
            id: makeId('req'),
            project_id: qs('aProject').value,
            code: qs('aCode').value.trim().toUpperCase(),
            title: qs('aTitle').value.trim(),
            description: qs('aDescription').value,
            type: qs('aType').value,
            priority: qs('aPriority').value,
            status: qs('aStatus').value
          })
        });
      }

      qs('addModal').classList.remove('open');
      await loadData();
    }

    async function loadData() {
      const [projectsRes, requirementsRes, sprintsRes] = await Promise.all([
        api('/api/roadmap/projects?limit=200&offset=0'),
        api('/api/roadmap/requirements?limit=500&offset=0'),
        api('/api/roadmap/sprints?limit=200&offset=0')
      ]);

      state.projects = projectsRes.projects || [];
      state.requirements = requirementsRes.requirements || [];
      state.sprints = sprintsRes.sprints || [];

      const pf = qs('projectFilter');
      const current = pf.value;
      pf.innerHTML = '<option value="">All Projects</option>';
      for (const p of state.projects) {
        pf.insertAdjacentHTML('beforeend', `<option value="${p.id}">${p.name}</option>`);
      }
      if (current) pf.value = current;

      if (!state.expanded.size && state.projects.length) state.expanded.add(state.projects[0].id);
      render();
    }

    function bindControls() {
      ['projectFilter', 'priorityFilter', 'statusFilter', 'sortBy', 'groupBy'].forEach((id) => {
        qs(id).onchange = () => render();
      });
      qs('searchBox').addEventListener('input', (e) => filterDashboard(e.target.value));
      qs('closeBtn').onclick = () => qs('drawer').classList.remove('open');
      qs('saveBtn').onclick = () => saveRequirement().catch(err => alert(err.message));
      qs('delReqBtn').onclick = () => deleteRequirement().catch(err => alert(err.message));

      qs('addBtn').onclick = () => qs('addMenu').classList.toggle('open');
      qs('addMenu').onclick = (e) => {
        const btn = e.target.closest('button[data-kind]');
        if (!btn) return;
        qs('addMenu').classList.remove('open');
        openAdd(btn.dataset.kind);
      };

      qs('addClose').onclick = () => {
        qs('addModal').classList.remove('open');
        state.editMode = false;
        state.editId = null;
        qs('addSave').textContent = 'Create';
      };
      qs('addSave').onclick = () => saveAdd().catch(err => alert(err.message));

      qs('expandAllBtn').onclick = () => {
        const isExpand = qs('expandAllBtn').textContent.includes('Expand');
        if (isExpand) {
          state.projects.forEach(p => state.expanded.add(p.id));
          qs('expandAllBtn').textContent = '‚ñ≤ Collapse All';
        } else {
          state.expanded.clear();
          qs('expandAllBtn').textContent = '‚ñº Expand All';
        }
        render();
      };

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.add-wrap')) qs('addMenu').classList.remove('open');
      });
    }

    function escHtml(str) {
      return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    function openEdit(kind, id) {
      state.addKind = kind;
      state.editMode = true;
      state.editId = id;
      qs('addTitle').textContent = `Edit ${kind}`;
      qs('addSave').textContent = 'Save';

      if (kind === 'project') {
        const p = state.projects.find(x => x.id === id);
        if (!p) return;
        qs('addFields').innerHTML = `
          <div class="grid2">
            <div><label>Name</label><input id="aName" value="${escHtml(p.name)}" style="width:100%" /></div>
            <div><label>Code (read-only)</label><input id="aCode" value="${escHtml(p.code)}" readonly style="width:100%;opacity:0.6" /></div>
            <div><label>Emoji</label><input id="aEmoji" value="${escHtml(p.emoji)}" style="width:100%" /></div>
            <div><label>Version</label><input id="aVersion" value="${escHtml(p.current_version)}" style="width:100%" /></div>
            <div><label>Status</label><select id="aStatus" style="width:100%">
              <option value="active" ${p.status==='active'?'selected':''}>active</option>
              <option value="stable" ${p.status==='stable'?'selected':''}>stable</option>
              <option value="paused" ${p.status==='paused'?'selected':''}>paused</option>
              <option value="archived" ${p.status==='archived'?'selected':''}>archived</option>
            </select></div>
            <div><label>Repo URL</label><input id="aRepoUrl" value="${escHtml(p.repo_url)}" style="width:100%" /></div>
          </div>
          <div style="margin-top:10px">
            <button class="del-btn" onclick="deleteEntity('projects','${escHtml(id)}','${escHtml(p.name)}')">üóë Delete Project</button>
            <small style="color:var(--muted);margin-left:8px">Only works if project has no requirements.</small>
          </div>`;
      } else if (kind === 'sprint') {
        const s = state.sprints.find(x => x.id === id);
        if (!s) return;
        qs('addFields').innerHTML = `
          <div class="grid2">
            <div><label>Project</label><select id="aProject" style="width:100%">${state.projects.map(p => `<option value="${p.id}" ${p.id===s.project_id?'selected':''}>${escHtml(p.name)}</option>`).join('')}</select></div>
            <div><label>Name</label><input id="aName" value="${escHtml(s.name)}" style="width:100%" /></div>
            <div><label>Status</label><select id="aStatus" style="width:100%">
              <option value="active" ${s.status==='active'?'selected':''}>active</option>
              <option value="planned" ${s.status==='planned'?'selected':''}>planned</option>
              <option value="complete" ${s.status==='complete'?'selected':''}>complete</option>
            </select></div>
          </div>
          <div style="margin-top:10px">
            <button class="del-btn" onclick="deleteEntity('sprints','${escHtml(id)}','${escHtml(s.name)}')">üóë Delete Sprint</button>
          </div>`;
      }

      qs('addModal').classList.add('open');
    }

    async function deleteEntity(kind, id, name) {
      if (!confirm(`Delete ${kind.slice(0,-1)} "${name}"? This cannot be undone.`)) return;
      qs('addModal').classList.remove('open');
      state.editMode = false;
      state.editId = null;
      qs('addSave').textContent = 'Create';
      try {
        await api(`/api/roadmap/${kind}/${id}`, { method: 'DELETE' });
        await loadData();
        showToast(`Deleted "${name}"`);
      } catch (err) {
        alert(`Delete failed: ${err.message}`);
      }
    }

    async function deleteRequirement() {
      const req = state.selectedReq;
      if (!req) return;
      if (!confirm(`Delete "${req.code} ${req.title}"? This cannot be undone.`)) return;
      qs('drawer').classList.remove('open');
      try {
        await api(`/api/roadmap/requirements/${req.id}`, { method: 'DELETE' });
        await loadData();
        showToast(`Deleted "${req.code}"`);
      } catch (err) {
        alert(`Delete failed: ${err.message}`);
      }
    }

    let _toastTimer;
    function showToast(msg) {
      let t = qs('toast');
      if (!t) {
        t = document.createElement('div');
        t.id = 'toast';
        t.className = 'toast';
        document.body.appendChild(t);
      }
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(_toastTimer);
      _toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
    }

    function filterDashboard(query) {
      const q = query.toLowerCase().trim();
      if (!q) {
        document.querySelectorAll('[data-req]').forEach(el => el.style.display = '');
        document.querySelectorAll('.project').forEach(el => el.style.display = '');
        return;
      }
      document.querySelectorAll('[data-req][data-searchable]').forEach(el => {
        el.style.display = el.dataset.searchable.includes(q) ? '' : 'none';
      });
      document.querySelectorAll('.project').forEach(proj => {
        const head = proj.querySelector('[data-searchable]');
        const projMatch = head && head.dataset.searchable.includes(q);
        const hasVisible = [...proj.querySelectorAll('[data-req]')].some(r => r.style.display !== 'none');
        proj.style.display = (projMatch || hasVisible) ? '' : 'none';
      });
    }

    bindControls();
    loadData().catch((err) => {
      qs('hierarchy').innerHTML = `<div style="color:#ff9a9a">Failed to load data: ${err.message}</div>`;
    });
    api('/health').then(h => {
      if (h && h.version) qs('appVersion').textContent = `v${h.version}`;
    }).catch(() => {});
  </script>
</body>
</html>
