<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>MetaPM Dashboard</title>
    
    <link rel="manifest" href="/static/manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .priority-high { border-left: 4px solid #ef4444; }
        .priority-medium { border-left: 4px solid #f59e0b; }
        .priority-low { border-left: 4px solid #22c55e; }
        
        .event-item {
            transition: all 0.2s ease;
        }
        .event-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .loading {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(145deg, #e94560, #d63447);
            box-shadow: 0 4px 20px rgba(233, 69, 96, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 24px rgba(233, 69, 96, 0.5);
        }
    </style>
</head>
<body class="text-white">
    <div id="app" class="min-h-screen pb-24">
        <!-- Header -->
        <header class="px-4 py-4 flex items-center justify-between border-b border-white/10">
            <div>
                <h1 class="text-xl font-semibold">MetaPM</h1>
                <p id="currentDate" class="text-sm text-gray-400"></p>
            </div>
            <div class="flex gap-2">
                <button id="refreshBtn" class="p-2 rounded-full hover:bg-white/10" title="Refresh">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                </button>
                <a href="/docs" class="p-2 rounded-full hover:bg-white/10" title="API Docs">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                </a>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="px-4 py-4 space-y-4">
            
            <!-- Today's Calendar Section -->
            <section class="glass-card rounded-2xl p-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        Today's Calendar
                    </h2>
                    <span id="calendarStatus" class="text-xs text-gray-500"></span>
                </div>
                <div id="calendarEvents" class="space-y-2">
                    <div class="loading text-gray-400 text-sm">Loading calendar...</div>
                </div>
            </section>
            
            <!-- Priority Tasks Section -->
            <section class="glass-card rounded-2xl p-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        Priority Tasks
                    </h2>
                    <a href="/api/tasks" class="text-xs text-blue-400 hover:underline">View all</a>
                </div>
                <div id="priorityTasks" class="space-y-2">
                    <div class="loading text-gray-400 text-sm">Loading tasks...</div>
                </div>
            </section>
            
            <!-- Recent Captures Section -->
            <section class="glass-card rounded-2xl p-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                        </svg>
                        Recent Captures
                    </h2>
                    <span id="captureCount" class="text-xs text-gray-500"></span>
                </div>
                <div id="recentCaptures" class="space-y-2">
                    <div class="loading text-gray-400 text-sm">Loading captures...</div>
                </div>
            </section>
            
            <!-- Quick Stats Section -->
            <section class="grid grid-cols-3 gap-3">
                <div class="glass-card rounded-xl p-3 text-center">
                    <p id="statTasks" class="text-2xl font-bold text-blue-400">-</p>
                    <p class="text-xs text-gray-400">Active Tasks</p>
                </div>
                <div class="glass-card rounded-xl p-3 text-center">
                    <p id="statProjects" class="text-2xl font-bold text-purple-400">-</p>
                    <p class="text-xs text-gray-400">Projects</p>
                </div>
                <div class="glass-card rounded-xl p-3 text-center">
                    <p id="statCaptures" class="text-2xl font-bold text-green-400">-</p>
                    <p class="text-xs text-gray-400">Captures</p>
                </div>
            </section>
            
        </main>
        
        <!-- Floating Action Button -->
        <a href="/static/capture.html" class="fab" title="Voice Capture">
            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1 1.93c-3.94-.49-7-3.85-7-7.93h2c0 3.31 2.69 6 6 6s6-2.69 6-6h2c0 4.08-3.06 7.44-7 7.93V20h4v2H8v-2h4v-4.07z"/>
            </svg>
        </a>
    </div>
    
    <script>
        const API_BASE = window.location.origin;
        
        // Set current date
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        // Load calendar events
        async function loadCalendar() {
            const container = document.getElementById('calendarEvents');
            const status = document.getElementById('calendarStatus');
            
            try {
                const response = await fetch(`${API_BASE}/api/calendar/today`);
                const data = await response.json();
                
                if (!data.configured) {
                    status.textContent = 'Not connected';
                    container.innerHTML = `
                        <p class="text-gray-400 text-sm">Google Calendar not configured.</p>
                        <a href="/docs#/Calendar/calendar_status_api_calendar_status_get" 
                           class="text-blue-400 text-sm hover:underline">Setup instructions ‚Üí</a>
                    `;
                    return;
                }
                
                status.textContent = `${data.count} events`;
                
                if (data.events.length === 0) {
                    container.innerHTML = '<p class="text-gray-400 text-sm">No events today</p>';
                    return;
                }
                
                container.innerHTML = data.events.map(event => {
                    const time = event.allDay ? 'All day' : new Date(event.startTime).toLocaleTimeString('en-US', {
                        hour: 'numeric',
                        minute: '2-digit'
                    });
                    
                    return `
                        <div class="event-item flex items-center gap-3 p-2 rounded-lg">
                            <span class="text-xs text-gray-400 w-16">${time}</span>
                            <span class="flex-1 text-sm">${event.title}</span>
                            ${event.location ? `<span class="text-xs text-gray-500">üìç</span>` : ''}
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Failed to load calendar:', error);
                container.innerHTML = '<p class="text-red-400 text-sm">Failed to load calendar</p>';
            }
        }
        
        // Load priority tasks
        async function loadTasks() {
            const container = document.getElementById('priorityTasks');
            
            try {
                const response = await fetch(`${API_BASE}/api/tasks?status=NEW&status=STARTED&pageSize=5`);
                const data = await response.json();
                
                document.getElementById('statTasks').textContent = data.total || 0;
                
                if (!data.tasks || data.tasks.length === 0) {
                    container.innerHTML = '<p class="text-gray-400 text-sm">No active tasks</p>';
                    return;
                }
                
                container.innerHTML = data.tasks.map(task => {
                    const priorityClass = task.priority <= 2 ? 'priority-high' : 
                                         task.priority === 3 ? 'priority-medium' : 'priority-low';
                    
                    return `
                        <div class="event-item ${priorityClass} p-2 rounded-lg pl-3">
                            <p class="text-sm font-medium">${task.title}</p>
                            <p class="text-xs text-gray-400">${task.projectCode || 'No project'} ¬∑ Priority ${task.priority}</p>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Failed to load tasks:', error);
                container.innerHTML = '<p class="text-red-400 text-sm">Failed to load tasks</p>';
            }
        }
        
        // Load recent captures
        async function loadCaptures() {
            const container = document.getElementById('recentCaptures');
            
            try {
                const response = await fetch(`${API_BASE}/api/transactions/conversations?n=5`);
                const data = await response.json();
                
                const count = data.conversations?.length || 0;
                document.getElementById('captureCount').textContent = `${count} recent`;
                document.getElementById('statCaptures').textContent = data.total || count;
                
                if (!data.conversations || data.conversations.length === 0) {
                    container.innerHTML = '<p class="text-gray-400 text-sm">No captures yet. Tap the mic button!</p>';
                    return;
                }
                
                container.innerHTML = data.conversations.map(conv => {
                    const time = new Date(conv.createdAt).toLocaleString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit'
                    });
                    
                    return `
                        <div class="event-item p-2 rounded-lg">
                            <p class="text-sm">${conv.title || 'Voice capture'}</p>
                            <p class="text-xs text-gray-400">${time} ¬∑ ${conv.source}</p>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Failed to load captures:', error);
                container.innerHTML = '<p class="text-red-400 text-sm">Failed to load captures</p>';
            }
        }
        
        // Load projects count
        async function loadProjects() {
            try {
                const response = await fetch(`${API_BASE}/api/projects`);
                const data = await response.json();
                document.getElementById('statProjects').textContent = data.projects?.length || 0;
            } catch (error) {
                console.error('Failed to load projects:', error);
            }
        }
        
        // Refresh all data
        async function refreshAll() {
            await Promise.all([
                loadCalendar(),
                loadTasks(),
                loadCaptures(),
                loadProjects()
            ]);
        }
        
        // Event listeners
        document.getElementById('refreshBtn').addEventListener('click', refreshAll);
        
        // Initial load
        refreshAll();
        
        // Auto-refresh every 5 minutes
        setInterval(refreshAll, 5 * 60 * 1000);
    </script>
</body>
</html>
