<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>MetaPM Dashboard</title>
    
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    
    <link rel="manifest" href="/static/manifest.json">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css">
    
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #1e293b;
            --text-primary: #ffffff;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --border-color: rgba(255, 255, 255, 0.1);
        }
        
        body.theme-light {
            --bg-primary: #f8fafc;
            --bg-secondary: #f1f5f9;
            --bg-tertiary: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-color: rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
        }
        
        body.theme-light .glass-card {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--border-color);
        }
        
        .priority-1, .priority-2 { border-left: 4px solid #ef4444; }
        .priority-3 { border-left: 4px solid #f59e0b; }
        .priority-4, .priority-5 { border-left: 4px solid #22c55e; }
        
        .status-NEW { background: rgba(59, 130, 246, 0.2); }
        .status-STARTED { background: rgba(234, 179, 8, 0.2); }
        .status-BLOCKED { background: rgba(239, 68, 68, 0.2); }
        .status-DONE { background: rgba(34, 197, 94, 0.2); }
        
        .item-row { transition: all 0.2s ease; }
        .item-row:hover { background: rgba(255, 255, 255, 0.08); }
        
        .loading { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(145deg, #e94560, #d63447);
            box-shadow: 0 4px 20px rgba(233, 69, 96, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 100;
        }
        .fab:hover { transform: scale(1.1); }
        
        .tab-active { background: rgba(255, 255, 255, 0.1); border-bottom: 2px solid #e94560; }
        .tab-content.hidden { display: none; }
        
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 16px;
        }
        .modal-overlay.hidden { display: none; }
        .modal-content {
            background: var(--bg-tertiary);
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            color: var(--text-primary);
        }
        
        body.theme-light .modal-content {
            background: #ffffff;
            border: 1px solid var(--border-color);
        }
        
        .btn { padding: 8px 16px; border-radius: 8px; font-size: 14px; transition: all 0.2s; }
        .btn-primary { background: #e94560; color: white; }
        .btn-primary:hover { background: #d63447; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); }
        .btn-danger { background: #dc2626; color: white; }
        .btn-danger:hover { background: #b91c1c; }
        
        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }
        .form-input:focus { outline: none; border-color: #e94560; }
        .form-input::placeholder { color: var(--text-muted); }
        
        body.theme-light .form-input {
            background: rgba(0,0,0,0.05);
            color: var(--text-primary);
        }
        body.theme-light .form-input::placeholder { color: var(--text-muted); }
        
        select.form-input { appearance: none; cursor: pointer; }
        
        /* Fix dropdown option contrast - CRITICAL */
        select option {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        body.theme-light select option {
            background-color: #ffffff;
            color: var(--text-primary);
        }
        
        .chip {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .project-chip {
            background: var(--chip-bg, rgba(255,255,255,0.1));
            color: var(--chip-text, var(--text-primary));
        }
        .chip.selected { 
            background: #e94560 !important; 
            color: white !important;
        }
        .chip:hover { background: rgba(255,255,255,0.2); }
        .chip.selected:hover { background: #d63447 !important; }
        .project-chip:not(.selected):hover {
            filter: brightness(1.2);
        }
        
        .expand-btn { transition: transform 0.2s; }
        .expand-btn.expanded { transform: rotate(90deg); }
        
        .theme-toggle {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .theme-toggle button {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .theme-toggle button.active {
            background: #e94560;
            color: white;
            border-color: #e94560;
        }
        .theme-toggle button:hover {
            border-color: #e94560;
            background: rgba(233, 69, 96, 0.2);
        }
        .theme-toggle button.active:hover {
            background: #e94560;
        }
        
        .project-tasks { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .project-tasks.expanded { max-height: 1000px; }

        /* ‚îÄ‚îÄ Compact task rows (v1.6.1) ‚îÄ‚îÄ */
        .task-row {
            display: grid;
            /* checkbox, type, status, priority, project, title, actions */
            grid-template-columns: 32px 28px 68px 40px 64px 1fr 32px;
            align-items: center;
            padding: 5px 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.15s;
            font-size: 13px;
        }
        .task-row:hover { background: rgba(255,255,255,0.08); }
        body.theme-light .task-row:hover { background: rgba(0,0,0,0.06); }
        .task-row.row-odd { background: rgba(255,255,255,0.04); }
        .task-row.row-even { background: transparent; }
        body.theme-light .task-row.row-odd { background: #ffffff; }
        body.theme-light .task-row.row-even { background: #f1f5f9; }
        .task-row .task-title-cell {
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            font-size: 0.875rem;
        }
        .type-icon { font-size: 14px; text-align: center; }
        .status-badge {
            font-size: 0.65rem; padding: 2px 6px; border-radius: 4px;
            font-weight: 600; text-transform: uppercase; text-align: center;
            white-space: nowrap; display: inline-block;
        }
        .status-badge.s-new { background: #3b82f6; color: white; }
        .status-badge.s-started { background: #f59e0b; color: white; }
        .status-badge.s-blocked { background: #ef4444; color: white; }
        .status-badge.s-done { background: #6b7280; color: white; }
        .priority-pill {
            font-size: 0.7rem; font-weight: 700; text-align: center;
        }
        .priority-pill.pp-1, .priority-pill.pp-2 { color: #ef4444; }
        .priority-pill.pp-3 { color: #f59e0b; }
        .priority-pill.pp-4, .priority-pill.pp-5 { color: #22c55e; }
        .project-mini {
            font-size: 0.65rem; padding: 1px 5px; border-radius: 3px;
            display: inline-block; white-space: nowrap;
        }
        .task-row .task-actions-cell { text-align: center; }
        .task-row .task-actions-cell button {
            opacity: 0; transition: opacity 0.15s; background: none; border: none;
            cursor: pointer; color: var(--text-muted); font-size: 16px; padding: 2px;
        }
        .task-row:hover .task-actions-cell button { opacity: 1; }

        /* ‚îÄ‚îÄ Filter bar (v1.6.0) ‚îÄ‚îÄ */
        .filter-bar {
            display: flex; align-items: center; padding: 6px 12px;
            gap: 12px; flex-wrap: wrap; border-bottom: 1px solid var(--border-color);
            font-size: 12px;
        }
        .filter-bar .fg { display: flex; align-items: center; gap: 4px; }
        .filter-bar label { color: var(--text-muted); white-space: nowrap; font-size: 11px; }
        .filter-bar select, .filter-bar input[type="text"] {
            padding: 3px 6px; border-radius: 4px; border: 1px solid var(--border-color);
            background: rgba(255,255,255,0.05); color: var(--text-primary);
            font-size: 12px;
        }
        body.theme-light .filter-bar select,
        body.theme-light .filter-bar input[type="text"] {
            background: rgba(0,0,0,0.03);
        }
        .filter-bar .search-box { margin-left: auto; }
        .filter-bar .search-box input { width: 180px; }

        /* ‚îÄ‚îÄ Status bar (v1.6.0) ‚îÄ‚îÄ */
        .bottom-status-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            display: flex; align-items: center; justify-content: space-between;
            padding: 6px 16px; z-index: 50; font-size: 12px;
            background: rgba(15, 15, 30, 0.97); border-top: 1px solid rgba(255,255,255,0.08);
        }
        body.theme-light .bottom-status-bar {
            background: rgba(248,250,252,0.97); border-top: 1px solid rgba(0,0,0,0.08);
        }
        .bottom-status-bar .sel-info { display: flex; align-items: center; gap: 10px; }
        .bottom-status-bar .sel-info button {
            padding: 3px 10px; border-radius: 4px; font-size: 11px;
            background: rgba(255,255,255,0.1); color: var(--text-secondary);
            border: 1px solid var(--border-color); cursor: pointer;
        }
        .bottom-status-bar .sel-info button:disabled { opacity: 0.4; cursor: not-allowed; }
        .bottom-status-bar .stats-info { display: flex; gap: 16px; }
        
        .icon-btn {
            padding: 6px;
            border-radius: 6px;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.1); }
        
        .badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
        }
        
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            background: #1e293b;
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 300;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateX(-50%) translateY(20px); } }
        
        .toast.success { border-color: #22c55e; }
        .toast.error { border-color: #ef4444; }
        /* Rich text preview styles for project modal */
        .prose h2 { font-size: 1.25rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; color: #fff; }
        .prose h3 { font-size: 1.1rem; font-weight: 600; margin-top: 0.75rem; margin-bottom: 0.5rem; color: #e5e7eb; }
        .prose p { margin-bottom: 0.5rem; color: #d1d5db; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.5rem; }
        .prose li { margin-bottom: 0.25rem; color: #d1d5db; }
        .prose strong { color: #fff; }
        .prose table { width: 100%; border-collapse: collapse; margin: 0.5rem 0; }
        .prose th, .prose td { border: 1px solid rgba(255,255,255,0.1); padding: 0.5rem; text-align: left; }
        .prose th { background: rgba(255,255,255,0.05); }

        /* ‚îÄ‚îÄ Mobile Task List Layout (v1.6.2) ‚îÄ‚îÄ */
        @media (max-width: 768px) {
            /* Switch to flexbox with wrapping for two-line layout */
            .task-row {
                display: flex;
                flex-wrap: wrap;
                padding: 10px 12px;
                gap: 6px 8px;
                align-items: center;
            }

            /* Checkbox: stays on line 1, left side */
            .task-row > div:nth-child(1) {
                order: 1;
                flex: 0 0 28px;
                align-self: flex-start;
                margin-top: 2px;
            }

            .task-row input[type="checkbox"] {
                min-width: 22px;
                min-height: 22px;
            }

            /* Title: order 2, grows to fill line 1 */
            .task-row > div:nth-child(6) {
                order: 2;
                flex: 1 1 calc(100% - 40px); /* Force to take most of line 1 */
                min-width: 0;
            }

            .task-row .task-title-cell {
                white-space: normal;
                overflow: hidden;
                text-overflow: ellipsis;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                font-size: 14px;
                line-height: 1.4;
            }

            /* Type icon: order 10, wraps to line 2 with left margin for indent */
            .task-row > div:nth-child(2) {
                order: 10;
                flex: 0 0 auto;
                margin-left: 30px; /* Indent under title (past checkbox) */
            }

            /* Status: order 11 */
            .task-row > div:nth-child(3) {
                order: 11;
                flex: 0 0 auto;
            }

            /* Priority: order 12 */
            .task-row > div:nth-child(4) {
                order: 12;
                flex: 0 0 auto;
            }

            /* Project: order 13 */
            .task-row > div:nth-child(5) {
                order: 13;
                flex: 0 0 auto;
            }

            /* Actions: hide on mobile to save space */
            .task-row > div:nth-child(7) {
                display: none;
            }

            /* Compact badge sizing for mobile */
            .type-icon {
                font-size: 12px;
            }

            .status-badge {
                font-size: 11px;
                padding: 2px 6px;
                border-radius: 3px;
            }

            .priority-pill {
                font-size: 11px;
                font-weight: 700;
            }

            .project-mini {
                font-size: 10px;
                padding: 1px 4px;
            }

            /* Increase touch targets for mobile usability */
            .task-row {
                min-height: 44px; /* iOS minimum touch target */
            }
        }
    </style>
    <script src="/static/js/offline-data.js"></script>
</head>
<body class="text-white">
    <div id="app" class="min-h-screen pb-24">
        <!-- Header (single line, v1.6.1) -->
        <header style="display:flex;flex-wrap:nowrap;align-items:center;gap:8px;padding:6px 12px;border-bottom:1px solid var(--border-color);position:sticky;top:0;background:var(--bg-primary);backdrop-filter:blur(10px);z-index:50;min-height:36px;overflow-x:auto;">
            <a href="/static/dashboard.html" style="font-size:15px;font-weight:600;white-space:nowrap;color:var(--text-primary);text-decoration:none;">MetaPM</a>
            <span id="versionBadge" style="font-size:11px;font-weight:600;background:#4ade80;color:#000;padding:1px 7px;border-radius:4px;white-space:nowrap;"></span>
            <div id="syncStatus" style="font-size:11px;padding:1px 6px;border-radius:3px;color:#4ade80;white-space:nowrap;" title="Sync status">‚úì Synced</div>
            <span id="currentDate" style="font-size:11px;color:var(--text-muted);white-space:nowrap;"></span>
            <div class="theme-toggle" style="margin-left:auto;gap:2px;">
                <button id="themeLight" title="Light theme" style="padding:3px 6px;font-size:12px;">‚òÄÔ∏è</button>
                <button id="themeDark" class="active" title="Dark theme" style="padding:3px 6px;font-size:12px;">üåô</button>
                <button id="themeAuto" title="Auto theme" style="padding:3px 6px;font-size:12px;">üíª</button>
            </div>
            <select id="viewSelect" class="form-input" style="padding:2px 6px;width:auto;min-width:90px;font-size:12px;">
                <option value="tasks">Tasks</option>
                <option value="projects">Projects</option>
                <option value="history">AI History</option>
                <option value="methodology">Methodology</option>
                <option value="backlog">Backlog</option>
                <option value="handoffs">üåâ Handoff Bridge</option>
            </select>
            <button id="addTaskBtn" class="btn btn-primary" style="padding:3px 10px;font-size:11px;white-space:nowrap;">+ Add Task</button>
            <button id="refreshBtn" class="icon-btn" title="Refresh" style="padding:3px;">
                <svg style="width:14px;height:14px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
            </button>
            <a href="/static/handoffs.html" class="icon-btn" title="Handoff Bridge" style="padding:3px;">
                <svg style="width:14px;height:14px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                </svg>
            </a>
            <a href="/docs" class="icon-btn" title="API Docs" style="padding:3px;">
                <svg style="width:14px;height:14px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
            </a>
        </header>

        <!-- Hidden tab buttons for backward compatibility -->
        <nav class="hidden">
            <button class="tab-btn tab-active" data-tab="tasks">Tasks</button>
            <button class="tab-btn" data-tab="projects">Projects</button>
            <button class="tab-btn" data-tab="history">AI History</button>
            <button class="tab-btn" data-tab="methodology">Methodology</button>
            <button class="tab-btn" data-tab="backlog">Backlog</button>
        </nav>
        
        <!-- Main Content -->
        <main class="px-4 py-4">
            
            <!-- ==================== TASKS TAB ==================== -->
            <section id="tab-tasks" class="tab-content" style="padding-bottom: 48px;">
                <!-- Filter bar -->
                <div class="filter-bar">
                    <div class="fg">
                        <label>Status:</label>
                        <select id="filterStatus">
                            <option value="active">Active</option>
                            <option value="">All</option>
                            <option value="NEW">New</option>
                            <option value="STARTED">Started</option>
                            <option value="BLOCKED">Blocked</option>
                            <option value="DONE">Done</option>
                        </select>
                    </div>
                    <div class="fg">
                        <label>Priority:</label>
                        <select id="filterPriority">
                            <option value="">All</option>
                            <option value="1">P1</option>
                            <option value="2">P2</option>
                            <option value="3">P3</option>
                            <option value="4">P4</option>
                            <option value="5">P5</option>
                        </select>
                    </div>
                    <div class="fg">
                        <label>Project:</label>
                        <select id="projectFilter">
                            <option value="">All</option>
                        </select>
                    </div>
                    <div class="fg">
                        <label>Type:</label>
                        <select id="filterType">
                            <option value="">All</option>
                            <option value="task">Task</option>
                            <option value="bug">Bug</option>
                            <option value="requirement">Req</option>
                        </select>
                    </div>
                    <div class="fg">
                        <label>Sort:</label>
                        <select id="taskSortOrder">
                            <option value="priority">Priority</option>
                            <option value="created">Created</option>
                            <option value="modified">Updated</option>
                            <option value="title">Title</option>
                        </select>
                        <select id="taskSortDirection">
                            <option value="asc">‚Üë</option>
                            <option value="desc">‚Üì</option>
                        </select>
                    </div>
                    <div class="fg search-box">
                        <input type="text" id="taskSearch" placeholder="Search...">
                    </div>
                </div>

                <!-- Task List (grid rows) -->
                <div id="taskList" style="padding-bottom: 4px;">
                    <div class="loading text-gray-400 text-sm p-4">Loading tasks...</div>
                </div>

                <!-- Status Bar (bottom) -->
                <div id="taskStatusBar" class="bottom-status-bar">
                    <div class="sel-info">
                        <span id="selectionCount" style="color:var(--text-muted);">0 selected</span>
                        <select id="bulkStatusSelect" disabled onchange="bulkUpdateStatus(this.value)" style="padding:2px 6px;border-radius:4px;font-size:11px;background:rgba(255,255,255,0.1);color:var(--text-secondary);border:1px solid var(--border-color);">
                            <option value="">Set Status...</option>
                            <option value="NEW">New</option>
                            <option value="STARTED">Started</option>
                            <option value="BLOCKED">Blocked</option>
                            <option value="DONE">Done</option>
                        </select>
                        <button id="bulkDeleteBtn" disabled onclick="bulkDeleteSelected()">Delete</button>
                        <button id="bulkClearBtn" disabled onclick="clearSelection()">Clear</button>
                    </div>
                    <div class="stats-info">
                        <span><span id="statNew" class="font-bold text-blue-400">-</span> <span class="text-gray-500">New</span></span>
                        <span><span id="statStarted" class="font-bold text-yellow-400">-</span> <span class="text-gray-500">Active</span></span>
                        <span><span id="statBlocked" class="font-bold text-red-400">-</span> <span class="text-gray-500">Blocked</span></span>
                        <span><span id="statDone" class="font-bold text-green-400">-</span> <span class="text-gray-500">Done</span></span>
                    </div>
                </div>
            </section>
            
            <!-- ==================== PROJECTS TAB ==================== -->
            <section id="tab-projects" class="tab-content space-y-4 hidden">
                <!-- Search Box -->
                <input type="text" id="projectSearch" class="form-input w-full text-sm" placeholder="üîç Search projects by name, code, or description...">
                
                <!-- Theme Filter -->
                <div class="flex flex-wrap gap-2 items-center">
                    <span class="text-sm text-gray-400">Theme:</span>
                    <select id="themeFilter" class="form-input w-auto text-sm">
                        <option value="">All Themes</option>
                    </select>
                    <select id="statusFilter" class="form-input w-auto text-sm">
                        <option value="">All Status</option>
                        <option value="ACTIVE">Active</option>
                        <option value="BLOCKED">Blocked</option>
                        <option value="PLANNED">Planned</option>
                    </select>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="showOpenTasksOnly" class="form-checkbox">
                        <span class="text-sm text-gray-400">Show only projects with open tasks</span>
                    </label>
                </div>
                <div class="flex gap-2">
                    <button onclick="openProjectModal()" class="flex-1 glass-card rounded-xl p-3 text-left flex items-center gap-3 hover:bg-white/10 transition">
                        <svg class="w-5 h-5 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        <span class="text-gray-400">Add new project...</span>
                    </button>
                    <button onclick="openThemeModal()" class="glass-card rounded-xl p-3 flex items-center gap-2 hover:bg-white/10 transition" title="Manage themes">
                        <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
                        </svg>
                        <span class="text-gray-400 text-sm">Themes</span>
                    </button>
                </div>
                
                <!-- Project List -->
                <div id="projectList" class="space-y-2">
                    <div class="loading text-gray-400 text-sm p-4">Loading projects...</div>
                </div>
            </section>
            
            <!-- ==================== AI HISTORY TAB ==================== -->
            <section id="tab-history" class="tab-content space-y-4 hidden">
                <!-- Search Box -->
                <input type="text" id="historySearch" class="form-input w-full text-sm" placeholder="üîç Search conversations by title or content...">
                
                <!-- Filters -->
                <div class="flex flex-wrap gap-2 items-center">
                    <select id="historyProjectFilter" class="form-input w-auto text-sm">
                        <option value="">All Projects</option>
                    </select>
                    <select id="historySourceFilter" class="form-input w-auto text-sm">
                        <option value="">All Sources</option>
                        <option value="VOICE">Voice</option>
                        <option value="WEB">Web</option>
                        <option value="MOBILE">Mobile</option>
                    </select>
                    <select id="historySortFilter" class="form-input w-auto text-sm">
                        <option value="desc">Newest First</option>
                        <option value="asc">Oldest First</option>
                    </select>
                    <select id="historyDateRange" class="form-input w-auto text-sm">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
                
                <!-- History List -->
                <div class="glass-card rounded-2xl overflow-hidden">
                    <div id="historyList" class="divide-y divide-white/5">
                        <div class="loading text-gray-400 text-sm p-4">Loading history...</div>
                    </div>
                </div>
            </section>
            
            <!-- ==================== METHODOLOGY TAB ==================== -->
            <section id="tab-methodology" class="tab-content space-y-4 hidden">
                <!-- Search Box -->
                <input type="text" id="methodologySearch" class="form-input w-full text-sm" placeholder="üîç Search rules by code, name, or description...">
                
                <!-- Sub-tabs -->
                <div class="flex gap-2">
                    <button class="method-tab chip selected" data-subtab="rules">Rules</button>
                    <button class="method-tab chip" data-subtab="violations">Violations</button>
                </div>
                
                <!-- Rules Section -->
                <div id="subtab-rules" class="space-y-3">
                    <button id="addRuleBtn" class="w-full glass-card rounded-xl p-3 text-left flex items-center gap-3 hover:bg-white/10 transition">
                        <svg class="w-5 h-5 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        <span class="text-gray-400">Add methodology rule...</span>
                    </button>
                    <div class="glass-card rounded-2xl overflow-hidden">
                        <div id="rulesList" class="divide-y divide-white/5">
                            <div class="loading text-gray-400 text-sm p-4">Loading rules...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Violations Section -->
                <div id="subtab-violations" class="space-y-3 hidden">
                    <button id="addViolationBtn" class="w-full glass-card rounded-xl p-3 text-left flex items-center gap-3 hover:bg-white/10 transition">
                        <svg class="w-5 h-5 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        <span class="text-gray-400">Log a violation...</span>
                    </button>
                    <div class="glass-card rounded-2xl overflow-hidden">
                        <div id="violationsList" class="divide-y divide-white/5">
                            <div class="loading text-gray-400 text-sm p-4">Loading violations...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ==================== BACKLOG TAB ==================== -->
            <section id="tab-backlog" class="tab-content space-y-4 hidden">
                <!-- Search -->
                <div class="relative">
                    <input type="text" id="backlogSearch" class="form-input w-full text-sm pr-8" placeholder="Search bugs & requirements...">
                    <button id="clearSearch" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white hidden" title="Clear search">&times;</button>
                </div>

                <!-- Group By toggle -->
                <div class="flex gap-2 flex-wrap items-center">
                    <span class="text-xs text-gray-400">Group By:</span>
                    <div class="inline-flex rounded-lg overflow-hidden border border-white/10">
                        <button id="groupByProject" onclick="switchGroupBy('project')" class="px-3 py-1.5 text-xs font-medium bg-red-500 text-white">Project</button>
                        <button id="groupByItem" onclick="switchGroupBy('item')" class="px-3 py-1.5 text-xs font-medium bg-white/5 text-gray-400 hover:bg-white/10">Item</button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="flex gap-2 flex-wrap items-center">
                    <select id="backlogProjectFilter" class="form-input text-sm" style="width:auto;min-width:120px;">
                        <option value="">All Projects</option>
                    </select>
                    <select id="backlogStatusFilter" class="form-input text-sm" style="width:auto;min-width:100px;">
                        <option value="">All Statuses</option>
                        <option value="Open">Open</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Fixed">Fixed</option>
                        <option value="Deferred">Deferred</option>
                        <option value="Closed">Closed</option>
                        <option value="Backlog">Backlog</option>
                        <option value="Done">Done</option>
                    </select>
                    <select id="backlogPriorityFilter" class="form-input text-sm" style="width:auto;min-width:80px;">
                        <option value="">All Priorities</option>
                        <option value="P1">P1</option>
                        <option value="P2">P2</option>
                        <option value="P3">P3</option>
                        <option value="P4">P4</option>
                        <option value="P5">P5</option>
                    </select>
                    <select id="backlogSortFilter" class="form-input text-sm" style="width:auto;min-width:120px;">
                        <option value="priority">Sort: Priority</option>
                        <option value="project">Sort: Project</option>
                        <option value="code">Sort: Code</option>
                        <option value="updated-desc">Sort: Updated (newest)</option>
                        <option value="updated-asc">Sort: Updated (oldest)</option>
                    </select>
                    <div class="flex-1"></div>
                    <button id="addBugBtn" class="btn btn-primary text-sm">+ Bug</button>
                    <button id="addReqBtn" class="btn btn-secondary text-sm">+ Requirement</button>
                </div>

                <!-- Project Grouped View -->
                <div id="bltab-project" class="space-y-3">
                    <div class="loading text-gray-400 text-sm p-4">Loading backlog...</div>
                </div>

                <!-- Item Flat View -->
                <div id="bltab-item" class="space-y-3" style="display:none">
                    <div class="glass-card rounded-2xl overflow-hidden">
                        <div id="itemsList" class="divide-y divide-white/5">
                            <div class="loading text-gray-400 text-sm p-4">Loading items...</div>
                        </div>
                    </div>
                </div>

                <!-- Bulk Action Bar (fixed at bottom when items selected) -->
                <div id="bulkActions" class="hidden" style="position:sticky; bottom:0; z-index:40;">
                    <div class="glass-card rounded-2xl p-3 flex items-center gap-3 border border-red-500/30" style="background: rgba(20,20,30,0.95);">
                        <span id="bulkCount" class="text-sm font-medium text-white">0 selected</span>
                        <div class="flex-1"></div>
                        <select id="bulkStatusChange" class="form-input text-sm" style="width:auto;min-width:130px;">
                            <option value="">Set Status...</option>
                            <option value="Open">Open</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Fixed">Fixed</option>
                            <option value="Deferred">Deferred</option>
                            <option value="Closed">Closed</option>
                            <option value="Backlog">Backlog</option>
                            <option value="Done">Done</option>
                        </select>
                        <button id="bulkDeleteBtn" class="btn btn-danger text-sm">Delete Selected</button>
                        <button id="bulkClearBtn" class="btn text-sm" style="background:rgba(255,255,255,0.1)">Clear Selection</button>
                    </div>
                </div>
            </section>
        </main>

        <!-- FAB: Voice Capture -->
        <button id="fabCapture" class="fab" title="Voice Capture">
            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1 1.93c-3.94-.49-7-3.85-7-7.93h2c0 3.31 2.69 6 6 6s6-2.69 6-6h2c0 4.08-3.06 7.44-7 7.93V20h4v2H8v-2h4v-4.07z"/>
            </svg>
        </button>
    </div>
    
    <!-- ==================== MODALS ==================== -->
    
    <!-- Task Modal -->
    <div id="taskModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="p-4 border-b border-white/10 flex items-center justify-between">
                <h2 id="taskModalTitle" class="font-semibold">Add Task</h2>
                <button id="closeTaskModal" class="icon-btn">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form id="taskForm" class="p-4 space-y-4">
                <input type="hidden" id="taskId">
                <div>
                    <label class="text-sm text-gray-400">Title *</label>
                    <textarea id="taskTitle" class="form-input mt-1" required placeholder="Task title..." rows="2" style="resize: vertical; min-height: 40px;"></textarea>
                </div>
                <div>
                    <label class="text-sm text-gray-400">Description</label>
                    <textarea id="taskDescription" class="form-input mt-1" rows="3" placeholder="Details..."></textarea>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="text-sm text-gray-400">Type</label>
                        <select id="taskType" class="form-input mt-1">
                            <option value="task">Task</option>
                            <option value="bug">Bug</option>
                            <option value="requirement">Requirement</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">Priority</label>
                        <select id="taskPriority" class="form-input mt-1">
                            <option value="1">1 - Critical</option>
                            <option value="2">2 - High</option>
                            <option value="3" selected>3 - Medium</option>
                            <option value="4">4 - Low</option>
                            <option value="5">5 - Someday</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">Status</label>
                        <select id="taskStatus" class="form-input mt-1">
                            <option value="NEW">New</option>
                            <option value="STARTED">Started</option>
                            <option value="BLOCKED">Blocked</option>
                            <option value="DONE">Done</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="text-sm text-gray-400">Due Date</label>
                    <input type="date" id="taskDueDate" class="form-input mt-1">
                </div>
                <div>
                    <label class="text-sm text-gray-400">Projects</label>
                    <div id="taskProjects" class="flex flex-wrap gap-2 mt-2"></div>
                </div>
                <div>
                    <label class="text-sm text-gray-400">Categories</label>
                    <div id="taskCategories" class="flex flex-wrap gap-2 mt-2"></div>
                </div>
                <div class="flex gap-2 pt-2">
                    <button type="submit" class="btn btn-primary flex-1">Save Task</button>
                    <button type="button" id="deleteTaskBtn" class="btn btn-danger hidden">Delete</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Capture Modal -->
    <div id="captureModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="p-4 border-b border-white/10 flex items-center justify-between">
                <h2 class="font-semibold">Quick Capture</h2>
                <button id="closeCaptureModal" class="icon-btn">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="p-4 space-y-4">
                <div>
                    <label class="text-sm text-gray-400">What's on your mind?</label>
                    <textarea id="captureText" class="form-input mt-1" rows="4" placeholder="Type or use voice..."></textarea>
                </div>
                <div>
                    <label class="text-sm text-gray-400">Project (optional)</label>
                    <select id="captureProject" class="form-input mt-1">
                        <option value="">Auto-detect</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button id="voiceRecordBtn" class="btn btn-secondary flex items-center gap-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                        </svg>
                        Record
                    </button>
                    <button id="submitCapture" class="btn btn-primary flex-1">Submit</button>
                </div>
                <p id="captureStatus" class="text-sm text-gray-400 text-center"></p>
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 700px;">
            <div class="p-4 border-b border-white/10 flex items-center justify-between">
                <h2 id="projectModalTitle" class="font-semibold">Project Details</h2>
                <button id="closeProjectModal" class="icon-btn">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <!-- Tabs within modal -->
            <div class="flex border-b border-white/10 px-4">
                <button class="project-tab px-4 py-2 text-sm tab-active" data-ptab="details">Details</button>
                <button class="project-tab px-4 py-2 text-sm text-gray-400" data-ptab="content">Content</button>
                <button class="project-tab px-4 py-2 text-sm text-gray-400" data-ptab="tasks">Tasks</button>
            </div>
            
            <!-- Details Tab -->
            <form id="projectForm" class="p-4 space-y-4 project-tab-content" data-ptab="details">
                <input type="hidden" id="projectId">
                <input type="hidden" id="originalProjectCode">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-gray-400">Project Code *</label>
                        <input type="text" id="projectCode" class="form-input mt-1" required placeholder="META">
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">Status</label>
                        <select id="projectStatus" class="form-input mt-1">
                            <option value="ACTIVE">Active</option>
                            <option value="BLOCKED">Blocked</option>
                            <option value="PLANNED">Planned</option>
                            <option value="COMPLETED">Completed</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="text-sm text-gray-400">Project Name *</label>
                    <input type="text" id="projectName" class="form-input mt-1" required placeholder="Project name">
                </div>
                
                <div>
                    <label class="text-sm text-gray-400">Description</label>
                    <textarea id="projectDescription" class="form-input mt-1" rows="2" placeholder="Brief description"></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-gray-400">Theme</label>
                        <select id="projectTheme" class="form-input mt-1">
                            <option value="">Select theme...</option>
                            <option value="Creation">Creation</option>
                            <option value="Learning">Learning</option>
                            <option value="Adventure">Adventure</option>
                            <option value="Relationships">Relationships</option>
                            <option value="Meta">Meta</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">Tech Stack</label>
                        <input type="text" id="projectTechStack" class="form-input mt-1" placeholder="Python, FastAPI, etc.">
                    </div>
                </div>
                
                <div>
                    <label class="text-sm text-gray-400">Project Color (Peacock Theme)</label>
                    <div class="flex gap-2 mt-1">
                        <input type="color" id="projectColorPicker" class="h-10 w-16 rounded cursor-pointer" value="#6b7280">
                        <input type="text" id="projectColorHex" class="form-input flex-1" placeholder="#6b7280" pattern="^#[0-9A-Fa-f]{6}$" maxlength="7">
                        <div id="projectColorPreview" class="w-10 h-10 rounded border border-white/20" style="background-color: #6b7280"></div>
                    </div>
                    <small class="text-xs text-gray-500 mt-1">Match your VS Code Peacock color for visual association</small>
                </div>
                
                <div>
                    <label class="text-sm text-gray-400">Goal Statement</label>
                    <input type="text" id="projectGoal" class="form-input mt-1" placeholder="What success looks like">
                </div>
                
                <div>
                    <label class="text-sm text-gray-400">Priority Next Steps</label>
                    <textarea id="projectNextSteps" class="form-input mt-1" rows="3" placeholder="1. First step&#10;2. Second step"></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-gray-400">Production URL</label>
                        <input type="url" id="projectProdURL" class="form-input mt-1" placeholder="https://...">
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">GitHub URL</label>
                        <input type="url" id="projectGitHubURL" class="form-input mt-1" placeholder="https://github.com/...">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-gray-400">VS Code Path</label>
                        <input type="text" id="projectVSCodePath" class="form-input mt-1" placeholder="G:\My Drive\Code\...">
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">Current AI Thread URL</label>
                        <input type="url" id="projectAIThreadURL" class="form-input mt-1" placeholder="https://claude.ai/chat/...">
                    </div>
                </div>
                
                <div class="flex gap-2 pt-2">
                    <button type="submit" class="btn btn-primary flex-1">Save Project</button>
                    <button type="button" id="deleteProjectBtn" class="btn btn-danger hidden">Delete</button>
                </div>
            </form>
            
            <!-- Content Tab -->
            <div class="p-4 project-tab-content hidden" data-ptab="content">
                <div class="mb-3 flex justify-between items-center">
                    <label class="text-sm text-gray-400">Rich Text Content (HTML)</label>
                    <button id="toggleContentPreview" class="btn btn-secondary text-xs">Preview</button>
                </div>
                
                <!-- Editor -->
                <div id="contentEditor">
                    <textarea id="projectContentHTML" class="form-input font-mono text-sm" rows="15" 
                              placeholder="<div class='project-content'>&#10;  <h2>Section Title</h2>&#10;  <p>Content here...</p>&#10;</div>"></textarea>
                    <button id="saveContentBtn" class="btn btn-primary mt-3">Save Content</button>
                </div>
                
                <!-- Preview -->
                <div id="contentPreview" class="hidden">
                    <div id="contentPreviewArea" class="glass-card p-4 rounded-lg prose prose-invert max-w-none" style="min-height: 200px;">
                        <!-- Rendered HTML will appear here -->
                    </div>
                </div>
            </div>
            
            <!-- Tasks Tab -->
            <div class="p-4 project-tab-content hidden" data-ptab="tasks">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-sm text-gray-400">Tasks for this project</span>
                    <button id="addProjectTaskBtn" class="btn btn-secondary text-xs">+ Add Task</button>
                </div>
                <div id="projectTasksList" class="space-y-2 max-h-80 overflow-y-auto">
                    <!-- Tasks loaded dynamically -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Rule Modal -->
    <div id="ruleModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="p-4 border-b border-white/10 flex items-center justify-between">
                <h2 id="ruleModalTitle" class="font-semibold">Add Rule</h2>
                <button id="closeRuleModal" class="icon-btn">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form id="ruleForm" class="p-4 space-y-4">
                <input type="hidden" id="ruleId">
                <div>
                    <label class="text-sm text-gray-400">Rule Code *</label>
                    <input type="text" id="ruleCode" class="form-input mt-1" required placeholder="LL-038">
                </div>
                <div>
                    <label class="text-sm text-gray-400">Rule Name *</label>
                    <input type="text" id="ruleName" class="form-input mt-1" required placeholder="Short name...">
                </div>
                <div>
                    <label class="text-sm text-gray-400">Description *</label>
                    <textarea id="ruleDescription" class="form-input mt-1" rows="3" required placeholder="What is this rule about?"></textarea>
                </div>
                <div>
                    <label class="text-sm text-gray-400">Rationale</label>
                    <textarea id="ruleRationale" class="form-input mt-1" rows="2" placeholder="Why is this important?"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-gray-400">Category</label>
                        <select id="ruleCategory" class="form-input mt-1">
                            <option value="DEVELOPMENT">Development</option>
                            <option value="TESTING">Testing</option>
                            <option value="DEPLOYMENT">Deployment</option>
                            <option value="DOCUMENTATION">Documentation</option>
                            <option value="PROCESS">Process</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">Severity</label>
                        <select id="ruleSeverity" class="form-input mt-1">
                            <option value="CRITICAL">Critical</option>
                            <option value="HIGH">High</option>
                            <option value="MEDIUM" selected>Medium</option>
                            <option value="LOW">Low</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-2 pt-2">
                    <button type="submit" class="btn btn-primary flex-1">Save Rule</button>
                    <button type="button" id="deleteRuleBtn" class="btn btn-danger hidden">Delete</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Violation Modal -->
    <div id="violationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="p-4 border-b border-white/10 flex items-center justify-between">
                <h2 class="font-semibold">Log Violation</h2>
                <button id="closeViolationModal" class="icon-btn">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form id="violationForm" class="p-4 space-y-4">
                <div>
                    <label class="text-sm text-gray-400">Rule Violated *</label>
                    <select id="violationRule" class="form-input mt-1" required></select>
                </div>
                <div>
                    <label class="text-sm text-gray-400">Project *</label>
                    <select id="violationProject" class="form-input mt-1" required></select>
                </div>
                <div>
                    <label class="text-sm text-gray-400">Context / What happened</label>
                    <textarea id="violationContext" class="form-input mt-1" rows="3" placeholder="Describe the violation..."></textarea>
                </div>
                <div>
                    <label class="text-sm text-gray-400">Copilot Session URL (optional)</label>
                    <input type="url" id="violationCopilotRef" class="form-input mt-1" placeholder="https://...">
                </div>
                <div>
                    <label class="text-sm text-gray-400">Resolution</label>
                    <textarea id="violationResolution" class="form-input mt-1" rows="2" placeholder="How was it fixed?"></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-full">Log Violation</button>
            </form>
        </div>
    </div>

    <!-- Theme Management Modal -->
    <div id="themeModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 600px;">
            <div class="p-4 border-b border-white/10 flex items-center justify-between">
                <h2 class="font-semibold">Manage Themes</h2>
                <button id="closeThemeModal" class="icon-btn">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="p-4 space-y-4">
                <!-- Existing Themes List -->
                <div>
                    <h3 class="text-sm font-medium text-gray-300 mb-2">Existing Themes</h3>
                    <div id="themesList" class="space-y-2 max-h-64 overflow-y-auto">
                        <div class="text-gray-400 text-sm p-2">Loading themes...</div>
                    </div>
                </div>

                <!-- Create New Theme Form -->
                <div class="pt-4 border-t border-white/10">
                    <h3 class="text-sm font-medium text-gray-300 mb-3">Create New Theme</h3>
                    <form id="themeCreateForm" class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-400">Code *</label>
                                <input type="text" id="themeCreateCode" class="form-input mt-1 text-sm" placeholder="e.g., CUSTOM" maxlength="20" required>
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">Name *</label>
                                <input type="text" id="themeCreateName" class="form-input mt-1 text-sm" placeholder="e.g., Custom Theme" required>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">Description</label>
                            <input type="text" id="themeCreateDesc" class="form-input mt-1 text-sm" placeholder="Brief description">
                        </div>
                        <div class="flex gap-2 items-end">
                            <div class="flex-1">
                                <label class="text-xs text-gray-400">Color (Hex)</label>
                                <input type="text" id="themeCreateColor" class="form-input mt-1 text-sm" placeholder="#6b7280" pattern="^#[0-9A-Fa-f]{6}$" maxlength="7">
                            </div>
                            <input type="color" id="themeCreateColorPicker" class="h-9 w-12 rounded cursor-pointer">
                        </div>
                        <button type="submit" class="btn btn-primary w-full text-sm">Create Theme</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bug Modal -->
    <div id="bugModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="p-4 border-b border-white/10 flex items-center justify-between">
                <h2 id="bugModalTitle" class="font-semibold">Add Bug</h2>
                <button id="closeBugModal" class="icon-btn">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form id="bugForm" class="p-4 space-y-4">
                <input type="hidden" id="bugId">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-gray-400">Project *</label>
                        <select id="bugProject" class="form-input mt-1" required></select>
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">Code *</label>
                        <input type="text" id="bugCode" class="form-input mt-1" required placeholder="BUG-001">
                    </div>
                </div>
                <div>
                    <label class="text-sm text-gray-400">Title *</label>
                    <input type="text" id="bugTitle" class="form-input mt-1" required placeholder="Brief description of the bug">
                </div>
                <div>
                    <label class="text-sm text-gray-400">Description</label>
                    <textarea id="bugDescription" class="form-input mt-1" rows="3" placeholder="Detailed description, steps to reproduce..."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-gray-400">Status</label>
                        <select id="bugStatus" class="form-input mt-1">
                            <option value="Open">Open</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Fixed">Fixed</option>
                            <option value="Deferred">Deferred</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">Priority</label>
                        <select id="bugPriority" class="form-input mt-1">
                            <option value="P1">P1 - Critical</option>
                            <option value="P2">P2 - High</option>
                            <option value="P3" selected>P3 - Medium</option>
                            <option value="P4">P4 - Low</option>
                            <option value="P5">P5 - Minimal</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-2 pt-2">
                    <button type="submit" class="btn btn-primary flex-1">Save Bug</button>
                    <button type="button" id="deleteBugBtn" class="btn btn-danger hidden">Delete</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Requirement Modal -->
    <div id="reqModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="p-4 border-b border-white/10 flex items-center justify-between">
                <h2 id="reqModalTitle" class="font-semibold">Add Requirement</h2>
                <button id="closeReqModal" class="icon-btn">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form id="reqForm" class="p-4 space-y-4">
                <input type="hidden" id="reqId">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-gray-400">Project *</label>
                        <select id="reqProject" class="form-input mt-1" required></select>
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">Code *</label>
                        <input type="text" id="reqCode" class="form-input mt-1" required placeholder="REQ-001">
                    </div>
                </div>
                <div>
                    <label class="text-sm text-gray-400">Title *</label>
                    <input type="text" id="reqTitle" class="form-input mt-1" required placeholder="Feature or capability needed">
                </div>
                <div>
                    <label class="text-sm text-gray-400">Description</label>
                    <textarea id="reqDescription" class="form-input mt-1" rows="3" placeholder="Detailed requirements..."></textarea>
                </div>
                <div>
                    <label class="text-sm text-gray-400">Reference URL</label>
                    <input type="url" id="reqReferenceURL" class="form-input mt-1" placeholder="https://...">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-gray-400">Status</label>
                        <select id="reqStatus" class="form-input mt-1">
                            <option value="Backlog">Backlog</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Done">Done</option>
                            <option value="Deferred">Deferred</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">Priority</label>
                        <select id="reqPriority" class="form-input mt-1">
                            <option value="P1">P1 - Critical</option>
                            <option value="P2">P2 - High</option>
                            <option value="P3" selected>P3 - Medium</option>
                            <option value="P4">P4 - Low</option>
                            <option value="P5">P5 - Minimal</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-2 pt-2">
                    <button type="submit" class="btn btn-primary flex-1">Save Requirement</button>
                    <button type="button" id="deleteReqBtn" class="btn btn-danger hidden">Delete</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Transaction Detail Modal -->
    <div id="transactionModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="p-4 border-b border-white/10 flex items-center justify-between">
                <h2 class="font-semibold">Transaction Details</h2>
                <button id="closeTransactionModal" class="icon-btn">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="transactionDetail" class="p-4 space-y-4">
                <!-- Filled dynamically -->
            </div>
        </div>
    </div>

    <script>
        const API = window.location.origin;
        
        // ==================== THEME MANAGEMENT ====================
        function initTheme() {
            const savedTheme = localStorage.getItem('metapm-theme') || 'dark';
            applyTheme(savedTheme);
        }
        
        function applyTheme(theme) {
            document.body.classList.remove('theme-light', 'theme-auto');
            document.querySelectorAll('.theme-toggle button').forEach(btn => btn.classList.remove('active'));
            
            if (theme === 'light') {
                document.body.classList.add('theme-light');
                document.getElementById('themeLight').classList.add('active');
            } else if (theme === 'auto') {
                document.body.classList.add('theme-auto');
                document.getElementById('themeAuto').classList.add('active');
                if (window.matchMedia('(prefers-color-scheme: light)').matches) {
                    document.body.classList.add('theme-light');
                }
            } else {
                document.getElementById('themeDark').classList.add('active');
            }
            localStorage.setItem('metapm-theme', theme);
        }
        
        document.getElementById('themeLight').addEventListener('click', () => applyTheme('light'));
        document.getElementById('themeDark').addEventListener('click', () => applyTheme('dark'));
        document.getElementById('themeAuto').addEventListener('click', () => applyTheme('auto'));
        
        // State
        let allTasks = [];
        let allProjects = [];
        let allCategories = [];
        let allRules = [];
        let taskFilter = 'active';
        let projectFilterValue = '';
        let taskSearchValue = '';
        let projectSearchValue = '';
        let historySearchValue = '';
        let methodologySearchValue = '';
        
        // Debounce utility
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Project links
        const PROJECT_LINKS = {
            'META': { vscode: 'vscode://file/G:/My%20Drive/Code/Python/metapm', github: 'https://github.com/coreyprator/metapm' },
            'EM': { vscode: 'vscode://file/G:/My%20Drive/Code/Python/etymython', github: 'https://github.com/coreyprator/etymython' },
            'HL': { vscode: 'vscode://file/G:/My%20Drive/Code/Python/harmonylab', github: 'https://github.com/coreyprator/harmonylab' },
            'SF': { vscode: 'vscode://file/G:/My%20Drive/Code/Python/super-flashcards', github: 'https://github.com/coreyprator/super-flashcards' },
            'AF': { vscode: 'vscode://file/G:/My%20Drive/Code/Python/artforge', github: 'https://github.com/coreyprator/artforge' },
            'CUBIST': { vscode: 'vscode://file/G:/My%20Drive/Code/Python/cubist', github: 'https://github.com/coreyprator/cubist' },
            'PROMPTFORGE': { vscode: 'vscode://file/G:/My%20Drive/Code/Python/promptforge', github: 'https://github.com/coreyprator/promptforge' }
        };
        
        // Utility: Show toast
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        // Utility: Calculate contrasting text color for background
        function getContrastColor(hexColor) {
            if (!hexColor || hexColor.length !== 7) return '#ffffff';
            const r = parseInt(hexColor.slice(1, 3), 16);
            const g = parseInt(hexColor.slice(3, 5), 16);
            const b = parseInt(hexColor.slice(5, 7), 16);
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness > 128 ? '#000000' : '#ffffff';
        }
        
        // Utility: Render project badge with color
        function renderProjectBadge(projectCode) {
            const project = allProjects.find(p => p.projectCode === projectCode);
            const bgColor = project?.colorCode || '#6b7280';  // Default gray
            const textColor = getContrastColor(bgColor);
            return `<span class="badge" style="background-color: ${bgColor}; color: ${textColor}">${projectCode}</span>`;
        }
        
        // Utility: Sort tasks by specified criteria
        function sortTasks(tasks, sortBy, direction) {
            const sorted = [...tasks].sort((a, b) => {
                let comparison = 0;
                
                switch (sortBy) {
                    case 'modified':
                        const aUpdated = a.updatedAt ? new Date(a.updatedAt).getTime() : 0;
                        const bUpdated = b.updatedAt ? new Date(b.updatedAt).getTime() : 0;
                        comparison = aUpdated - bUpdated;
                        break;
                    case 'created':
                        const aCreated = a.createdAt ? new Date(a.createdAt).getTime() : 0;
                        const bCreated = b.createdAt ? new Date(b.createdAt).getTime() : 0;
                        comparison = aCreated - bCreated;
                        break;
                    case 'dueDate':
                        const aDue = a.dueDate ? new Date(a.dueDate).getTime() : 9999999999999;
                        const bDue = b.dueDate ? new Date(b.dueDate).getTime() : 9999999999999;
                        comparison = aDue - bDue;
                        break;
                    case 'priority':
                        comparison = (a.priority || 99) - (b.priority || 99);
                        break;
                    case 'title':
                        comparison = (a.title || '').localeCompare(b.title || '');
                        break;
                }
                
                return direction === 'desc' ? -comparison : comparison;
            });
            
            return sorted;
        }
        
        // Date
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', {
            weekday: 'short', month: 'short', day: 'numeric'
        });
        
        // ==================== VIEW NAVIGATION (dropdown) ====================
        const viewSelect = document.getElementById('viewSelect');
        const addBtn = document.getElementById('addTaskBtn');
        const addLabels = {
            tasks: '+ Add Task', projects: '+ Add Project', history: '+ Add Entry',
            methodology: '+ Add Rule', backlog: '+ Add Item'
        };

        function switchView(view) {
            // Handle Handoff Bridge navigation
            if (view === 'handoffs') {
                window.location.href = '/static/handoffs.html';
                return;
            }
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            const section = document.getElementById(`tab-${view}`);
            if (section) section.classList.remove('hidden');
            // Also update hidden tab-btn states for backward compat
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('tab-active');
                b.classList.add('text-gray-400');
                if (b.dataset.tab === view) { b.classList.add('tab-active'); b.classList.remove('text-gray-400'); }
            });
            // Show status bar only on Tasks tab
            const statusBar = document.getElementById('taskStatusBar');
            if (statusBar) statusBar.style.display = view === 'tasks' ? 'flex' : 'none';
            // Context-aware add button
            addBtn.textContent = addLabels[view] || '+ Add';
        }

        viewSelect.addEventListener('change', e => switchView(e.target.value));
        // Also keep tab-btn click working
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                viewSelect.value = btn.dataset.tab;
                switchView(btn.dataset.tab);
            });
        });

        function setDefaultTab() {
            switchView('tasks');
        }
        
        // ==================== SYNC STATUS ====================
        function initSyncStatus() {
            const statusEl = document.getElementById('syncStatus');
            
            // Handle online/offline changes
            OnlineStatus.onChange(async (online) => {
                if (online) {
                    statusEl.textContent = 'üîÑ Syncing...';
                    statusEl.style.color = 'var(--text-secondary)';
                    await SyncEngine.syncAll();
                } else {
                    statusEl.textContent = 'üî¥ Offline';
                    statusEl.style.color = '#ef4444';
                }
            });
            
            // Handle sync completion
            window.addEventListener('syncComplete', async () => {
                const pending = await OfflineDB.getPendingOperations();
                if (pending.length === 0) {
                    statusEl.textContent = '‚úì Synced';
                    statusEl.style.color = '#22c55e';
                    // Reload data after sync
                    await loadTasks();
                    await loadProjects();
                } else {
                    statusEl.textContent = `‚è≥ Pending (${pending.length})`;
                    statusEl.style.color = '#f59e0b';
                }
            });
            
            // Initial status
            updateSyncStatus();
        }
        
        async function updateSyncStatus() {
            const statusEl = document.getElementById('syncStatus');
            if (!OnlineStatus.isOnline) {
                statusEl.textContent = 'üî¥ Offline';
                statusEl.style.color = '#ef4444';
            } else {
                const pending = await OfflineDB.getPendingOperations();
                if (pending.length === 0) {
                    statusEl.textContent = '‚úì Synced';
                    statusEl.style.color = '#22c55e';
                } else {
                    statusEl.textContent = `‚è≥ Pending (${pending.length})`;
                    statusEl.style.color = '#f59e0b';
                }
            }
        }
        
        // Methodology sub-tabs
        document.querySelectorAll('.method-tab').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.method-tab').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                document.getElementById('subtab-rules').classList.toggle('hidden', btn.dataset.subtab !== 'rules');
                document.getElementById('subtab-violations').classList.toggle('hidden', btn.dataset.subtab !== 'violations');
            });
        });
        
        // ==================== TASK CRUD ====================
        async function loadTasks() {
            try {
                // Try network first
                const res = await fetch(`${API}/api/tasks?pageSize=200`);
                if (res.ok) {
                    const data = await res.json();
                    allTasks = data.tasks || [];
                    // Save to IndexedDB for offline
                    await OfflineDB.bulkSaveTasks(allTasks);
                } else if (OnlineStatus.isOnline) {
                    throw new Error(`API error: ${res.status}`);
                } else {
                    // Offline: load from IndexedDB
                    allTasks = await OfflineDB.getTasks();
                }
                updateTaskStats();
                renderTasks();
                renderProjects(); // Re-render projects to update task counts
            } catch (e) {
                console.error('Load tasks failed:', e);
                // Last resort: load from IndexedDB
                if (allTasks.length === 0) {
                    allTasks = await OfflineDB.getTasks();
                    renderTasks();
                    renderProjects();
                }
            }
        }
        
        function updateTaskStats() {
            const counts = { NEW: 0, STARTED: 0, BLOCKED: 0, DONE: 0 };
            allTasks.forEach(t => { if (counts[t.status] !== undefined) counts[t.status]++; });
            document.getElementById('statNew').textContent = counts.NEW;
            document.getElementById('statStarted').textContent = counts.STARTED;
            document.getElementById('statBlocked').textContent = counts.BLOCKED;
            document.getElementById('statDone').textContent = counts.DONE;
        }
        
        // Selection state for bulk actions
        const selectedTaskIds = new Set();

        function getTypeIcon(taskType) {
            if (taskType === 'bug') return '<span title="Bug" style="color:#ef4444;">&#128027;</span>';
            if (taskType === 'requirement') return '<span title="Requirement" style="color:#a78bfa;">&#128203;</span>';
            return '<span title="Task" style="color:#9ca3af;">&#10003;</span>';
        }

        function getStatusBadge(status) {
            const s = (status || 'NEW').toUpperCase();
            const cls = s === 'NEW' ? 's-new' : s === 'STARTED' ? 's-started' : s === 'BLOCKED' ? 's-blocked' : 's-done';
            const label = s === 'STARTED' ? 'WIP' : s === 'COMPLETE' ? 'DONE' : s;
            return `<span class="status-badge ${cls}">${label}</span>`;
        }

        function renderTasks() {
            let tasks = allTasks;
            // Status filter
            if (taskFilter === 'active') {
                tasks = tasks.filter(t => t.status !== 'DONE' && t.status !== 'COMPLETE');
            } else if (taskFilter) {
                tasks = tasks.filter(t => t.status === taskFilter);
            }
            // Priority filter
            if (priorityFilterValue) tasks = tasks.filter(t => t.priority == priorityFilterValue);
            // Project filter
            if (projectFilterValue) tasks = tasks.filter(t => t.projectCode === projectFilterValue || (t.projects && t.projects.includes(projectFilterValue)));
            // Type filter
            if (typeFilterValue) tasks = tasks.filter(t => (t.taskType || 'task') === typeFilterValue);
            // Search
            if (taskSearchValue) {
                const search = taskSearchValue.toLowerCase();
                tasks = tasks.filter(t =>
                    (t.title && t.title.toLowerCase().includes(search)) ||
                    (t.description && t.description.toLowerCase().includes(search))
                );
            }

            // Apply sorting
            const sortBy = document.getElementById('taskSortOrder')?.value || 'priority';
            const direction = document.getElementById('taskSortDirection')?.value || 'asc';
            tasks = sortTasks(tasks, sortBy, direction);

            const container = document.getElementById('taskList');
            if (!tasks.length) {
                container.innerHTML = '<p class="text-gray-400 text-sm p-4">No tasks found</p>';
                return;
            }

            container.innerHTML = tasks.map((t, i) => {
                const p = allProjects.find(pr => pr.projectCode === t.projectCode);
                const bgColor = p?.colorCode || '#6b7280';
                const textColor = p ? getContrastColor(bgColor) : '#fff';
                const pCode = t.projectCode || '';
                const checked = selectedTaskIds.has(t.taskId) ? 'checked' : '';
                return `<div class="task-row ${i % 2 === 0 ? 'row-even' : 'row-odd'}" data-task-id="${t.taskId}">
                    <div style="text-align:center;">
                        <input type="checkbox" ${checked} onchange="toggleTaskSelect(${t.taskId}, this.checked)" onclick="event.stopPropagation();" />
                    </div>
                    <div class="type-icon">${getTypeIcon(t.taskType)}</div>
                    <div>${getStatusBadge(t.status)}</div>
                    <div class="priority-pill pp-${t.priority || 3}">P${t.priority || 3}</div>
                    <div>${pCode ? `<span class="project-mini" style="background:${bgColor};color:${textColor};">${pCode}</span>` : ''}</div>
                    <div class="task-title-cell" onclick="openTaskModal(${t.taskId})">${escHtml(t.title)}</div>
                    <div class="task-actions-cell"><button onclick="event.stopPropagation();openTaskModal(${t.taskId})" title="Edit">&#9998;</button></div>
                </div>`;
            }).join('');
        }

        function escHtml(s) {
            if (!s) return '';
            return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        function toggleTaskSelect(taskId, checked) {
            if (checked) selectedTaskIds.add(taskId); else selectedTaskIds.delete(taskId);
            updateSelectionUI();
        }
        function clearSelection() {
            selectedTaskIds.clear();
            updateSelectionUI();
            renderTasks();
        }
        function updateSelectionUI() {
            const n = selectedTaskIds.size;
            document.getElementById('selectionCount').textContent = `${n} selected`;
            document.getElementById('bulkDeleteBtn').disabled = n === 0;
            document.getElementById('bulkClearBtn').disabled = n === 0;
            document.getElementById('bulkStatusSelect').disabled = n === 0;
        }
        async function bulkUpdateStatus(newStatus) {
            if (!newStatus || selectedTaskIds.size === 0) return;
            if (!confirm(`Update ${selectedTaskIds.size} tasks to "${newStatus}"?`)) {
                document.getElementById('bulkStatusSelect').value = '';
                return;
            }
            for (const id of selectedTaskIds) {
                try {
                    await fetch(`${API}/api/tasks/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });
                } catch(e) {}
            }
            document.getElementById('bulkStatusSelect').value = '';
            selectedTaskIds.clear();
            await loadTasks();
            showToast(`${selectedTaskIds.size || 'Tasks'} updated to ${newStatus}`);
        }
        async function bulkDeleteSelected() {
            if (!confirm(`Delete ${selectedTaskIds.size} tasks?`)) return;
            for (const id of selectedTaskIds) {
                try { await fetch(`${API}/api/tasks/${id}`, { method: 'DELETE' }); } catch(e) {}
            }
            selectedTaskIds.clear();
            updateSelectionUI();
            await loadTasks();
            showToast('Tasks deleted');
        }

        // New filter variables
        let priorityFilterValue = '';
        let typeFilterValue = '';

        // Filter event listeners
        document.getElementById('filterStatus').addEventListener('change', e => {
            taskFilter = e.target.value;
            renderTasks();
        });
        document.getElementById('filterPriority').addEventListener('change', e => {
            priorityFilterValue = e.target.value;
            renderTasks();
        });
        document.getElementById('projectFilter').addEventListener('change', e => {
            projectFilterValue = e.target.value;
            renderTasks();
        });
        document.getElementById('filterType').addEventListener('change', e => {
            typeFilterValue = e.target.value;
            renderTasks();
        });

        // Search event listeners
        document.getElementById('taskSearch').addEventListener('input', debounce(e => {
            taskSearchValue = e.target.value;
            renderTasks();
        }, 300));

        // Sort event listeners
        document.getElementById('taskSortOrder').addEventListener('change', renderTasks);
        document.getElementById('taskSortDirection').addEventListener('change', renderTasks);
        
        document.getElementById('projectSearch').addEventListener('input', debounce(e => {
            projectSearchValue = e.target.value;
            renderProjects();
        }, 300));
        
        document.getElementById('historySearch').addEventListener('input', debounce(e => {
            historySearchValue = e.target.value;
            loadHistory(); // Reload from API for server-side search
        }, 300));
        
        document.getElementById('methodologySearch').addEventListener('input', debounce(e => {
            methodologySearchValue = e.target.value;
            renderRules();
        }, 300));
        
        // Task Modal
        function openTaskModal(taskId = null) {
            const modal = document.getElementById('taskModal');
            const form = document.getElementById('taskForm');
            const title = document.getElementById('taskModalTitle');
            const deleteBtn = document.getElementById('deleteTaskBtn');
            
            form.reset();
            document.getElementById('taskId').value = '';
            
            // Populate project chips
            const projContainer = document.getElementById('taskProjects');
            projContainer.innerHTML = allProjects.map(p => {
                const bgColor = p.colorCode || 'rgba(255,255,255,0.1)';
                const textColor = p.colorCode ? getContrastColor(p.colorCode) : 'var(--text-primary)';
                return `<button type="button" class="chip project-chip" data-code="${p.projectCode}" 
                        style="--chip-bg: ${bgColor}; --chip-text: ${textColor}">
                        ${p.projectCode}
                    </button>`;
            }).join('');
            
            // Populate category chips
            const catContainer = document.getElementById('taskCategories');
            catContainer.innerHTML = allCategories.map(c => 
                `<button type="button" class="chip category-chip" data-code="${c.categoryCode}">${c.categoryCode}</button>`
            ).join('');
            
            // Chip toggle
            document.querySelectorAll('.project-chip, .category-chip').forEach(chip => {
                chip.addEventListener('click', () => chip.classList.toggle('selected'));
            });
            
            if (taskId) {
                const task = allTasks.find(t => t.taskId === taskId);
                if (task) {
                    title.textContent = 'Edit Task';
                    document.getElementById('taskId').value = task.taskId;
                    document.getElementById('taskTitle').value = task.title || '';
                    document.getElementById('taskDescription').value = task.description || '';
                    document.getElementById('taskType').value = task.taskType || 'task';
                    document.getElementById('taskPriority').value = task.priority || 3;
                    document.getElementById('taskStatus').value = task.status || 'NEW';
                    document.getElementById('taskDueDate').value = task.dueDate ? task.dueDate.split('T')[0] : '';
                    
                    // Select associated projects
                    (task.projects || []).forEach(code => {
                        const chip = projContainer.querySelector(`[data-code="${code}"]`);
                        if (chip) chip.classList.add('selected');
                    });
                    
                    // Select associated categories
                    (task.categories || []).forEach(code => {
                        const chip = catContainer.querySelector(`[data-code="${code}"]`);
                        if (chip) chip.classList.add('selected');
                    });
                    
                    deleteBtn.classList.remove('hidden');
                }
            } else {
                title.textContent = 'Add Task';
                deleteBtn.classList.add('hidden');
            }
            
            modal.classList.remove('hidden');
        }
        
        document.getElementById('addTaskBtn').addEventListener('click', () => {
            const view = viewSelect.value;
            if (view === 'tasks' || view === 'backlog') openTaskModal();
            else if (view === 'projects') openProjectModal();
            else if (view === 'methodology') { const btn = document.getElementById('addRuleBtn'); if (btn) btn.click(); }
        });
        document.getElementById('closeTaskModal').addEventListener('click', () => {
            document.getElementById('taskModal').classList.add('hidden');
        });
        
        document.getElementById('taskForm').addEventListener('submit', async e => {
            e.preventDefault();
            e.stopPropagation(); // Prevent event bubbling
            
            // Prevent double-submit
            const submitBtn = e.target.querySelector('button[type="submit"]');
            if (submitBtn.disabled) return;
            submitBtn.disabled = true;
            
            const taskId = document.getElementById('taskId').value;
            const projects = Array.from(document.querySelectorAll('.project-chip.selected')).map(c => c.dataset.code);
            const categories = Array.from(document.querySelectorAll('.category-chip.selected')).map(c => c.dataset.code);
            
            const payload = {
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                taskType: document.getElementById('taskType').value,
                priority: parseInt(document.getElementById('taskPriority').value),
                status: document.getElementById('taskStatus').value,
                dueDate: document.getElementById('taskDueDate').value || null,
                projects,
                categories
            };
            
            try {
                if (OnlineStatus.isOnline) {
                    // Online: save to server
                    const url = taskId ? `${API}/api/tasks/${taskId}` : `${API}/api/tasks`;
                    const method = taskId ? 'PUT' : 'POST';
                    const res = await fetch(url, {
                        method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!res.ok) throw new Error(await res.text());
                    
                    await res.json();

                    // Reload all tasks from server to guarantee sync
                    await loadTasks();
                    showToast(taskId ? 'Task updated!' : 'Task created!');
                } else {
                    // Offline: save locally and queue for sync
                    const newId = taskId || Math.max(...allTasks.map(t => t.taskId || 0), 0) + 1;
                    const fullTask = { ...payload, taskId: newId, createdAt: new Date().toISOString() };
                    
                    await OfflineDB.saveTask(fullTask);
                    await OfflineDB.queueOperation(
                        taskId ? 'UPDATE_TASK' : 'CREATE_TASK',
                        { ...fullTask, taskId: newId }
                    );
                    
                    // Update UI immediately
                    if (taskId) {
                        const idx = allTasks.findIndex(t => t.taskId === taskId);
                        if (idx !== -1) allTasks[idx] = fullTask;
                    } else {
                        allTasks.push(fullTask);
                    }
                    updateTaskStats();
                    renderTasks();
                    renderProjects();
                    
                    showToast((taskId ? 'Task updated' : 'Task created') + ' offline. Will sync when connected.', 'info');
                }
                
                document.getElementById('taskModal').classList.add('hidden');
                await updateSyncStatus();
            } catch (err) {
                showToast('Error: ' + (err.message || 'Failed to save task'), 'error');
            } finally {
                submitBtn.disabled = false;
            }
        });
        
        document.getElementById('deleteTaskBtn').addEventListener('click', async () => {
            if (!confirm('Delete this task?')) return;
            const taskId = parseInt(document.getElementById('taskId').value);
            try {
                if (OnlineStatus.isOnline) {
                    await fetch(`${API}/api/tasks/${taskId}`, { method: 'DELETE' });
                    await OfflineDB.deleteTask(taskId);
                    // Reload all tasks from server to guarantee sync
                    await loadTasks();
                    showToast('Task deleted');
                } else {
                    await OfflineDB.deleteTask(taskId);
                    await OfflineDB.queueOperation('DELETE_TASK', { taskId });
                    
                    // Update UI immediately
                    allTasks = allTasks.filter(t => t.taskId !== taskId);
                    updateTaskStats();
                    renderTasks();
                    renderProjects();
                    
                    showToast('Task deleted offline. Will sync when connected.', 'info');
                }
                document.getElementById('taskModal').classList.add('hidden');
                await updateSyncStatus();
            } catch (err) {
                showToast('Delete failed: ' + (err.message || 'Unknown error'), 'error');
            }
        });
        
        // ==================== PROJECTS ====================
        async function loadProjects() {
            try {
                const res = await fetch(`${API}/api/projects`);
                if (res.ok) {
                    const data = await res.json();
                    allProjects = data.projects || [];
                    await OfflineDB.bulkSaveProjects(allProjects);
                    console.log('Loaded projects:', allProjects.length);
                    populateProjectFilters(data.themes || []);
                } else if (OnlineStatus.isOnline) {
                    console.error('Projects API failed:', res.status, await res.text());
                    return;
                } else {
                    // Offline: load from IndexedDB
                    allProjects = await OfflineDB.getProjects();
                    console.log('Loaded projects from cache:', allProjects.length);
                }
                renderProjects();
            } catch (e) {
                console.error('Load projects failed:', e);
                showToast('Failed to load projects', 'error');
            }
        }
        
        function populateProjectFilters(themes = []) {
            const themeList = themes.length ? themes : [...new Set(allProjects.map(p => p.theme).filter(Boolean))];
            document.getElementById('themeFilter').innerHTML = '<option value="">All Themes</option>' +
                themeList.map(t => `<option value="${t}">${t}</option>`).join('');
            
            const projSelect = [
                document.getElementById('projectFilter'),
                document.getElementById('historyProjectFilter'),
                document.getElementById('captureProject')
            ];
            projSelect.forEach(sel => {
                if (sel) {
                    const first = sel.options[0] ? sel.options[0].outerHTML : '<option value="">All Projects</option>';
                    if (allProjects.length > 0) {
                        sel.innerHTML = first + allProjects.map(p => `<option value="${p.projectCode}">${p.projectCode} - ${p.projectName}</option>`).join('');
                        console.log(`Populated ${sel.id} with ${allProjects.length} projects`);
                    } else {
                        console.warn(`No projects to populate in ${sel.id}`);
                    }
                }
            });
        }
        
        function renderProjects() {
            const themeVal = document.getElementById('themeFilter').value;
            const statusVal = document.getElementById('statusFilter').value;
            const openTasksOnly = document.getElementById('showOpenTasksOnly')?.checked || false;
            
            let projects = allProjects;
            if (themeVal) projects = projects.filter(p => p.theme === themeVal);
            if (statusVal) projects = projects.filter(p => p.status === statusVal);
            if (projectSearchValue) {
                const search = projectSearchValue.toLowerCase();
                projects = projects.filter(p => 
                    (p.projectName && p.projectName.toLowerCase().includes(search)) ||
                    (p.projectCode && p.projectCode.toLowerCase().includes(search)) ||
                    (p.description && p.description.toLowerCase().includes(search))
                );
            }
            if (openTasksOnly) {
                projects = projects.filter(p => {
                    const projectTasks = allTasks.filter(t => 
                        (t.projectCode === p.projectCode || (t.projects && t.projects.includes(p.projectCode))) &&
                        t.status !== 'DONE'
                    );
                    return projectTasks.length > 0;
                });
            }
            
            const container = document.getElementById('projectList');
            if (!projects.length) {
                container.innerHTML = '<p class="text-gray-400 text-sm p-4">No projects found</p>';
                return;
            }
            
            container.innerHTML = projects.map(p => {
                const links = PROJECT_LINKS[p.projectCode] || {};
                const projectTasks = allTasks.filter(t => 
                    (t.projectCode === p.projectCode || (t.projects && t.projects.includes(p.projectCode))) &&
                    t.status !== 'DONE'
                );
                const taskCount = projectTasks.length;
                const nextSteps = (p.priorityNextSteps || '').split('\n').filter(Boolean)[0] || p.description || '';
                const borderColor = p.colorCode || '#6b7280';
                const badgeBg = p.colorCode || 'rgba(255,255,255,0.1)';
                const badgeText = p.colorCode ? getContrastColor(p.colorCode) : '#ffffff';
                
                const tasksList = projectTasks.length > 0 ? `
                    <div class="project-tasks mt-2" id="tasks-${p.projectCode}">
                        <div class="space-y-1">
                            ${projectTasks.slice(0, 5).map(t => `
                                <div class="text-xs p-2 rounded" style="background: rgba(255,255,255,0.03)">
                                    <div class="flex items-center gap-2">
                                        <span class="status-badge status-${t.status}">${t.status}</span>
                                        <span class="flex-1" style="word-break: break-word;">${t.title}</span>
                                        <button onclick="event.stopPropagation(); openTaskModal(${t.taskId})" class="text-gray-400 hover:text-white">‚úèÔ∏è</button>
                                    </div>
                                </div>
                            `).join('')}
                            ${projectTasks.length > 5 ? `<div class="text-xs text-gray-500 p-2">...and ${projectTasks.length - 5} more</div>` : ''}
                        </div>
                    </div>
                ` : '';
                
                return `
                <div class="glass-card rounded-xl p-3">
                    <div class="flex items-start gap-3 hover:bg-white/5 transition cursor-pointer" onclick="openProjectModal('${p.projectCode}')" style="border-left: 4px solid ${borderColor}; margin-left: -12px; padding-left: 12px;">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                ${taskCount > 0 ? `<button onclick="event.stopPropagation(); toggleProjectTasks('${p.projectCode}')" class="expand-btn text-gray-400 hover:text-white">‚ñ∂</button>` : '<span style="width:16px"></span>'}
                                <span class="font-medium truncate">${p.projectName}</span>
                                <span class="badge" style="background-color: ${badgeBg}; color: ${badgeText}">${p.projectCode}</span>
                                <span class="text-xs text-gray-500">${p.status}</span>
                            </div>
                            <p class="text-xs text-gray-400 ml-6">${p.theme || 'No theme'} ¬∑ ${taskCount} tasks ¬∑ ${p.violationCount || 0} violations</p>
                            ${nextSteps ? `<p class="text-xs text-gray-300 mt-1 line-clamp-2 ml-6">${nextSteps}</p>` : ''}
                        </div>
                        <div class="flex gap-1">
                            ${p.currentAIThreadURL ? `<a href="${p.currentAIThreadURL}" target="_blank" class="icon-btn" title="AI Chat" onclick="event.stopPropagation()">ü§ñ</a>` : ''}
                            ${links.vscode ? `<a href="${links.vscode}" class="icon-btn" title="VS Code" onclick="event.stopPropagation()">üíª</a>` : ''}
                            ${links.github ? `<a href="${links.github}" target="_blank" class="icon-btn" title="GitHub" onclick="event.stopPropagation()">üìÇ</a>` : ''}
                        </div>
                    </div>
                    ${tasksList}
                </div>
                `;
            }).join('');
        }
        
        function toggleProjectTasks(projectCode) {
            const container = document.getElementById(`tasks-${projectCode}`);
            const btn = event.currentTarget;
            if (container.classList.contains('expanded')) {
                container.classList.remove('expanded');
                btn.classList.remove('expanded');
            } else {
                container.classList.add('expanded');
                btn.classList.add('expanded');
            }
        }
        
        function openTaskModalForProject(projectCode) {
            openTaskModal();
            setTimeout(() => {
                const chip = document.querySelector(`.project-chip[data-code="${projectCode}"]`);
                if (chip) chip.classList.add('selected');
            }, 100);
        }

        document.getElementById('themeFilter').addEventListener('change', renderProjects);
        document.getElementById('statusFilter').addEventListener('change', renderProjects);
        document.getElementById('showOpenTasksOnly')?.addEventListener('change', renderProjects);
        
        // Project modal tab switching
        document.querySelectorAll('.project-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.project-tab').forEach(t => {
                    t.classList.remove('tab-active');
                    t.classList.add('text-gray-400');
                });
                tab.classList.add('tab-active');
                tab.classList.remove('text-gray-400');
                
                document.querySelectorAll('.project-tab-content').forEach(c => c.classList.add('hidden'));
                document.querySelector(`.project-tab-content[data-ptab="${tab.dataset.ptab}"]`).classList.remove('hidden');
            });
        });
        
        // Content preview toggle
        document.getElementById('toggleContentPreview').addEventListener('click', () => {
            const editor = document.getElementById('contentEditor');
            const preview = document.getElementById('contentPreview');
            const btn = document.getElementById('toggleContentPreview');
            
            if (preview.classList.contains('hidden')) {
                const html = document.getElementById('projectContentHTML').value;
                document.getElementById('contentPreviewArea').innerHTML = html || '<p class="text-gray-400">No content yet</p>';
                preview.classList.remove('hidden');
                editor.classList.add('hidden');
                btn.textContent = 'Edit';
            } else {
                preview.classList.add('hidden');
                editor.classList.remove('hidden');
                btn.textContent = 'Preview';
            }
        });
        
        function renderProjectTasks(tasks) {
            const container = document.getElementById('projectTasksList');
            if (!tasks.length) {
                container.innerHTML = '<p class="text-gray-400 text-sm">No tasks yet</p>';
                return;
            }
            
            container.innerHTML = tasks.map(t => `
                <div class="item-row p-2 rounded flex justify-between items-center cursor-pointer" onclick="openTaskModal(${t.taskId})">
                    <div>
                        <span class="text-sm">${t.title}</span>
                        <span class="badge ml-2">${t.status}</span>
                    </div>
                    <span class="text-xs text-gray-400">P${t.priority}</span>
                </div>
            `).join('');
        }
        
        async function openProjectModal(projectCode = null) {
            const modal = document.getElementById('projectModal');
            const form = document.getElementById('projectForm');
            const title = document.getElementById('projectModalTitle');
            const deleteBtn = document.getElementById('deleteProjectBtn');
            
            // Reset form and tabs
            form.reset();
            document.getElementById('projectId').value = '';
            document.getElementById('originalProjectCode').value = '';
            document.getElementById('projectContentHTML').value = '';
            document.getElementById('projectTasksList').innerHTML = '';
            
            document.querySelectorAll('.project-tab').forEach((t, i) => {
                t.classList.toggle('tab-active', i === 0);
                t.classList.toggle('text-gray-400', i !== 0);
            });
            document.querySelectorAll('.project-tab-content').forEach((c, i) => c.classList.toggle('hidden', i !== 0));
            
            if (projectCode) {
                title.textContent = 'Edit Project';
                deleteBtn.classList.remove('hidden');
                try {
                    const res = await fetch(`${API}/api/projects/${projectCode}`);
                    const project = await res.json();
                    
                    document.getElementById('projectId').value = project.projectId;
                    document.getElementById('originalProjectCode').value = project.projectCode;
                    document.getElementById('projectCode').value = project.projectCode;
                    document.getElementById('projectName').value = project.projectName || '';
                    document.getElementById('projectDescription').value = project.description || '';
                    document.getElementById('projectTheme').value = project.theme || '';
                    document.getElementById('projectStatus').value = project.status || 'ACTIVE';
                    document.getElementById('projectGoal').value = project.goalStatement || '';
                    document.getElementById('projectTechStack').value = project.techStack || '';
                    document.getElementById('projectNextSteps').value = project.priorityNextSteps || '';
                    document.getElementById('projectProdURL').value = project.productionURL || '';
                    document.getElementById('projectGitHubURL').value = project.gitHubURL || '';
                    document.getElementById('projectVSCodePath').value = project.vsCodePath || '';
                    document.getElementById('projectAIThreadURL').value = project.currentAIThreadURL || '';
                    document.getElementById('projectContentHTML').value = project.contentHTML || '';
                    
                    // Set color picker values
                    const color = project.colorCode || '#6b7280';
                    document.getElementById('projectColorPicker').value = color;
                    document.getElementById('projectColorHex').value = color;
                    document.getElementById('projectColorPreview').style.backgroundColor = color;
                    
                    renderProjectTasks(project.recentTasks || []);
                } catch (e) {
                    console.error('Failed to load project:', e);
                    showToast('Failed to load project', 'error');
                }
            } else {
                title.textContent = 'Create Project';
                deleteBtn.classList.add('hidden');
                document.getElementById('projectStatus').value = 'ACTIVE';
            }
            
            modal.classList.remove('hidden');
        }
        
        document.getElementById('closeProjectModal').addEventListener('click', () => {
            document.getElementById('projectModal').classList.add('hidden');
        });
        
        document.getElementById('projectForm').addEventListener('submit', async e => {
            e.preventDefault();
            const originalCode = document.getElementById('originalProjectCode').value;
            const isEdit = !!originalCode;
            
            const payload = {
                projectCode: document.getElementById('projectCode').value,
                projectName: document.getElementById('projectName').value,
                description: document.getElementById('projectDescription').value,
                theme: document.getElementById('projectTheme').value || null,
                status: document.getElementById('projectStatus').value,
                goalStatement: document.getElementById('projectGoal').value || null,
                techStack: document.getElementById('projectTechStack').value || null,
                priorityNextSteps: document.getElementById('projectNextSteps').value || null,
                productionURL: document.getElementById('projectProdURL').value || null,
                gitHubURL: document.getElementById('projectGitHubURL').value || null,
                vsCodePath: document.getElementById('projectVSCodePath').value || null,
                currentAIThreadURL: document.getElementById('projectAIThreadURL').value || null,
                colorCode: document.getElementById('projectColorHex').value || null
            };
            
            try {
                const url = isEdit ? `${API}/api/projects/${originalCode}` : `${API}/api/projects`;
                const method = isEdit ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!res.ok) throw new Error(await res.text());
                
                showToast(isEdit ? 'Project updated!' : 'Project created!');
                document.getElementById('projectModal').classList.add('hidden');
                await loadProjects();
                await loadTasks();
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        });
        
        document.getElementById('saveContentBtn').addEventListener('click', async () => {
            const projectCode = document.getElementById('originalProjectCode').value;
            if (!projectCode) {
                showToast('Save project first before adding content', 'error');
                return;
            }
            
            const contentHTML = document.getElementById('projectContentHTML').value;
            
            try {
                const res = await fetch(`${API}/api/projects/${projectCode}/content`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contentHTML })
                });
                
                if (!res.ok) throw new Error(await res.text());
                showToast('Content saved!');
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        });
        
        document.getElementById('deleteProjectBtn').addEventListener('click', async () => {
            if (!confirm('Delete this project? This cannot be undone.')) return;
            
            const projectCode = document.getElementById('originalProjectCode').value;
            
            try {
                await fetch(`${API}/api/projects/${projectCode}`, { method: 'DELETE' });
                showToast('Project deleted');
                document.getElementById('projectModal').classList.add('hidden');
                await loadProjects();
                await loadTasks();
            } catch (err) {
                showToast('Delete failed', 'error');
            }
        });
        
        document.getElementById('addProjectTaskBtn').addEventListener('click', () => {
            const projectCode = document.getElementById('originalProjectCode').value;
            document.getElementById('projectModal').classList.add('hidden');
            openTaskModalForProject(projectCode);
        });

        // ==================== THEME MANAGEMENT ====================
        async function openThemeModal() {
            const modal = document.getElementById('themeModal');
            await loadThemesForModal();
            modal.classList.remove('hidden');
        }

        async function loadThemesForModal() {
            try {
                const res = await fetch(`${API}/api/themes?include_inactive=true`);
                const data = await res.json();
                const themes = data.themes || [];

                const container = document.getElementById('themesList');
                if (!themes.length) {
                    container.innerHTML = '<p class="text-gray-400 text-sm p-2">No themes found</p>';
                    return;
                }

                container.innerHTML = themes.map(t => `
                    <div class="glass-card rounded-lg p-3 flex items-center justify-between">
                        <div class="flex items-center gap-3 flex-1">
                            <div class="w-6 h-6 rounded border" style="background-color: ${t.colorCode || '#6b7280'}"></div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium">${t.themeName}</p>
                                <p class="text-xs text-gray-400">${t.themeCode}</p>
                            </div>
                            ${!t.isActive ? '<span class="text-xs text-gray-500">Inactive</span>' : ''}
                        </div>
                        <div class="flex gap-1">
                            <button class="icon-btn text-sm hover:text-yellow-400" onclick="editTheme(${t.themeId})">‚úèÔ∏è</button>
                            <button class="icon-btn text-sm hover:text-red-400" onclick="deleteThemeConfirm(${t.themeId})">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load themes:', e);
                showToast('Failed to load themes', 'error');
            }
        }

        async function editTheme(themeId) {
            const themeName = prompt('New theme name:');
            if (!themeName) return;

            try {
                const res = await fetch(`${API}/api/themes/${themeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ themeName })
                });

                if (!res.ok) throw new Error(await res.text());
                showToast('Theme updated');
                await loadThemesForModal();
            } catch (err) {
                showToast('Update failed: ' + err.message, 'error');
            }
        }

        async function deleteThemeConfirm(themeId) {
            if (!confirm('Delete this theme?')) return;

            try {
                const res = await fetch(`${API}/api/themes/${themeId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hard_delete: false })
                });

                if (!res.ok) {
                    const err = await res.text();
                    if (err.includes('Cannot delete theme')) {
                        showToast('Cannot delete: Projects use this theme', 'error');
                    } else {
                        throw new Error(err);
                    }
                } else {
                    showToast('Theme deleted');
                    await loadThemesForModal();
                }
            } catch (err) {
                showToast('Delete failed: ' + err.message, 'error');
            }
        }

        document.getElementById('closeThemeModal').addEventListener('click', () => {
            document.getElementById('themeModal').classList.add('hidden');
        });

        // Color picker sync for theme creation
        document.getElementById('themeCreateColorPicker').addEventListener('input', (e) => {
            const color = e.target.value;
            document.getElementById('themeCreateColor').value = color;
        });

        document.getElementById('themeCreateColor').addEventListener('input', (e) => {
            const color = e.target.value;
            if (/^#[0-9A-Fa-f]{6}$/.test(color)) {
                document.getElementById('themeCreateColorPicker').value = color;
            }
        });

        document.getElementById('themeCreateForm').addEventListener('submit', async e => {
            e.preventDefault();

            const payload = {
                themeCode: document.getElementById('themeCreateCode').value,
                themeName: document.getElementById('themeCreateName').value,
                description: document.getElementById('themeCreateDesc').value || null,
                colorCode: document.getElementById('themeCreateColor').value || null,
                displayOrder: 999
            };

            try {
                const res = await fetch(`${API}/api/themes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error(await res.text());

                showToast('Theme created!');
                document.getElementById('themeCreateForm').reset();
                await loadThemesForModal();
                await loadProjects(); // Refresh projects to show new theme
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        });
        
        // ==================== AI HISTORY ====================
        function getDateRangeAfter(range) {
            const now = new Date();
            switch(range) {
                case 'today':
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    return today.toISOString();
                case 'week':
                    const dayOfWeek = now.getDay();
                    const monday = new Date(now);
                    monday.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                    monday.setHours(0, 0, 0, 0);
                    return monday.toISOString();
                case 'month':
                    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                    return firstDay.toISOString();
                default:
                    return null;
            }
        }
        
        async function loadHistory() {
            const projFilter = document.getElementById('historyProjectFilter').value;
            const sourceFilter = document.getElementById('historySourceFilter').value;
            const sort = document.getElementById('historySortFilter').value;
            const dateRange = document.getElementById('historyDateRange')?.value || 'all';
            
            try {
                let url = `${API}/api/transactions/conversations?n=50&sort_order=${sort}`;
                if (projFilter) url += `&project_code=${projFilter}`;
                if (sourceFilter) url += `&source=${sourceFilter}`;
                const afterDate = getDateRangeAfter(dateRange);
                if (afterDate) url += `&after=${encodeURIComponent(afterDate)}`;
                
                const res = await fetch(url);
                const data = await res.json();
                renderHistory(data.conversations || []);
            } catch (e) {
                console.error('Load history failed:', e);
            }
        }
        
        function renderHistory(conversations) {
            let filtered = conversations;
            if (historySearchValue) {
                const search = historySearchValue.toLowerCase();
                filtered = conversations.filter(c => 
                    (c.title && c.title.toLowerCase().includes(search)) ||
                    (c.prompt && c.prompt.toLowerCase().includes(search))
                );
            }
            
            const container = document.getElementById('historyList');
            if (!filtered.length) {
                container.innerHTML = '<p class="text-gray-400 text-sm p-4">No history found</p>';
                return;
            }
            
            container.innerHTML = filtered.map(c => {
                const date = new Date(c.createdAt).toLocaleString();
                const icon = c.source === 'VOICE' ? 'üé§' : c.source === 'MOBILE' ? 'üì±' : 'üí¨';
                
                return `
                <div class="item-row p-3 cursor-pointer" onclick="openTransactionDetail('${c.conversationGuid}')">
                    <div class="flex items-start gap-3">
                        <span class="text-lg">${icon}</span>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-sm truncate">${c.title || 'Conversation'}</p>
                            <p class="text-xs text-gray-400">${date}</p>
                            <div class="flex gap-2 mt-1">
                                ${c.projectCode ? renderProjectBadge(c.projectCode) : ''}
                                <span class="badge">${c.source}</span>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        async function openTransactionDetail(guid) {
            try {
                const res = await fetch(`${API}/api/transactions/conversations/${guid}/full`);
                const data = await res.json();
                
                const detail = document.getElementById('transactionDetail');
                detail.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <p class="text-xs text-gray-400">Conversation</p>
                            <p class="font-medium">${data.conversation?.title || 'Untitled'}</p>
                            <p class="text-sm text-gray-400">${new Date(data.conversation?.createdAt).toLocaleString()}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400 mb-2">Transactions</p>
                            ${(data.transactions || []).map(t => `
                                <div class="glass-card rounded-lg p-3 mb-2">
                                    <p class="text-xs text-gray-400">${t.promptType} ‚Üí ${t.responseModel || 'N/A'}</p>
                                    <p class="text-sm mt-1"><strong>Prompt:</strong> ${t.promptText?.substring(0, 200) || 'N/A'}...</p>
                                    <p class="text-sm mt-1"><strong>Response:</strong> ${t.responseText?.substring(0, 200) || 'N/A'}...</p>
                                    ${t.extractedIntent ? `<span class="badge mt-2">${t.extractedIntent}</span>` : ''}
                                </div>
                            `).join('')}
                        </div>
                        ${data.media?.length ? `
                        <div>
                            <p class="text-xs text-gray-400 mb-2">Media Files</p>
                            ${data.media.map(m => `
                                <div class="flex items-center justify-between p-2 glass-card rounded mb-1">
                                    <span class="text-sm">${m.fileName}</span>
                                    <a href="${m.gcsUrl}" target="_blank" class="btn btn-secondary text-xs">Download</a>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                    </div>
                `;
                
                document.getElementById('transactionModal').classList.remove('hidden');
            } catch (e) {
                showToast('Failed to load details', 'error');
            }
        }
        
        document.getElementById('closeTransactionModal').addEventListener('click', () => {
            document.getElementById('transactionModal').classList.add('hidden');
        });
        
        document.getElementById('historyProjectFilter').addEventListener('change', loadHistory);
        document.getElementById('historySourceFilter').addEventListener('change', loadHistory);
        document.getElementById('historySortFilter').addEventListener('change', loadHistory);
        document.getElementById('historyDateRange')?.addEventListener('change', loadHistory);
        
        // ==================== METHODOLOGY ====================
        async function loadRules() {
            try {
                const res = await fetch(`${API}/api/methodology/rules`);
                const data = await res.json();
                allRules = data.rules || [];
                renderRules();
                populateRuleSelect();
            } catch (e) {
                console.error('Load rules failed:', e);
            }
        }
        
        function renderRules() {
            let rules = allRules;
            if (methodologySearchValue) {
                const search = methodologySearchValue.toLowerCase();
                rules = allRules.filter(r => 
                    (r.ruleCode && r.ruleCode.toLowerCase().includes(search)) ||
                    (r.ruleName && r.ruleName.toLowerCase().includes(search)) ||
                    (r.description && r.description.toLowerCase().includes(search))
                );
            }
            
            const container = document.getElementById('rulesList');
            if (!rules.length) {
                container.innerHTML = '<p class="text-gray-400 text-sm p-4">No rules found</p>';
                return;
            }
            
            container.innerHTML = rules.map(r => `
                <div class="item-row p-3 cursor-pointer" onclick="openRuleModal(${r.ruleId})">
                    <div class="flex items-start justify-between">
                        <div>
                            <span class="badge mr-2">${r.ruleCode}</span>
                            <span class="font-medium text-sm">${r.ruleName}</span>
                        </div>
                        <span class="badge">${r.severity || 'MEDIUM'}</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-1 line-clamp-2">${r.description}</p>
                </div>
            `).join('');
        }
        
        function populateRuleSelect() {
            const sel = document.getElementById('violationRule');
            sel.innerHTML = '<option value="">Select rule...</option>' +
                allRules.map(r => `<option value="${r.ruleId}">${r.ruleCode} - ${r.ruleName}</option>`).join('');
        }
        
        function openRuleModal(ruleId = null) {
            const modal = document.getElementById('ruleModal');
            const form = document.getElementById('ruleForm');
            const title = document.getElementById('ruleModalTitle');
            const deleteBtn = document.getElementById('deleteRuleBtn');
            
            form.reset();
            document.getElementById('ruleId').value = '';
            
            if (ruleId) {
                const rule = allRules.find(r => r.ruleId === ruleId);
                if (rule) {
                    title.textContent = 'Edit Rule';
                    document.getElementById('ruleId').value = rule.ruleId;
                    document.getElementById('ruleCode').value = rule.ruleCode;
                    document.getElementById('ruleName').value = rule.ruleName;
                    document.getElementById('ruleDescription').value = rule.description || '';
                    document.getElementById('ruleRationale').value = rule.rationale || '';
                    document.getElementById('ruleCategory').value = rule.category || 'DEVELOPMENT';
                    document.getElementById('ruleSeverity').value = rule.severity || 'MEDIUM';
                    deleteBtn.classList.remove('hidden');
                }
            } else {
                title.textContent = 'Add Rule';
                deleteBtn.classList.add('hidden');
                // Auto-generate next rule code
                const lastCode = allRules.length ? allRules[allRules.length - 1].ruleCode : 'LL-000';
                const nextNum = parseInt(lastCode.split('-')[1] || 0) + 1;
                document.getElementById('ruleCode').value = `LL-${String(nextNum).padStart(3, '0')}`;
            }
            
            modal.classList.remove('hidden');
        }
        
        document.getElementById('addRuleBtn').addEventListener('click', () => openRuleModal());
        document.getElementById('closeRuleModal').addEventListener('click', () => {
            document.getElementById('ruleModal').classList.add('hidden');
        });
        
        document.getElementById('ruleForm').addEventListener('submit', async e => {
            e.preventDefault();
            const ruleId = document.getElementById('ruleId').value;
            
            const payload = {
                ruleCode: document.getElementById('ruleCode').value,
                ruleName: document.getElementById('ruleName').value,
                description: document.getElementById('ruleDescription').value,
                rationale: document.getElementById('ruleRationale').value,
                category: document.getElementById('ruleCategory').value,
                severity: document.getElementById('ruleSeverity').value
            };
            
            try {
                const url = ruleId ? `${API}/api/methodology/rules/${ruleId}` : `${API}/api/methodology/rules`;
                const method = ruleId ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!res.ok) throw new Error(await res.text());
                
                showToast(ruleId ? 'Rule updated!' : 'Rule created!');
                document.getElementById('ruleModal').classList.add('hidden');
                loadRules();
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        });
        
        document.getElementById('deleteRuleBtn').addEventListener('click', async () => {
            if (!confirm('Delete this rule?')) return;
            const ruleId = document.getElementById('ruleId').value;
            try {
                await fetch(`${API}/api/methodology/rules/${ruleId}`, { method: 'DELETE' });
                showToast('Rule deleted');
                document.getElementById('ruleModal').classList.add('hidden');
                loadRules();
            } catch (err) {
                showToast('Delete failed', 'error');
            }
        });
        
        // Violations
        async function loadViolations() {
            try {
                const res = await fetch(`${API}/api/methodology/violations`);
                const data = await res.json();
                renderViolations(data.violations || []);
            } catch (e) {
                console.error('Load violations failed:', e);
            }
        }
        
        function renderViolations(violations) {
            const container = document.getElementById('violationsList');
            if (!violations.length) {
                container.innerHTML = '<p class="text-gray-400 text-sm p-4">No violations logged üéâ</p>';
                return;
            }
            
            container.innerHTML = violations.map(v => {
                const rule = allRules.find(r => r.ruleId === v.ruleId);
                const project = allProjects.find(p => p.projectId === v.projectId);
                
                return `
                <div class="item-row p-3">
                    <div class="flex items-start justify-between">
                        <div>
                            <span class="badge mr-2">${rule?.ruleCode || 'N/A'}</span>
                            <span class="badge">${project?.projectCode || 'N/A'}</span>
                        </div>
                        <span class="text-xs text-gray-400">${new Date(v.createdAt).toLocaleDateString()}</span>
                    </div>
                    <p class="text-sm mt-1">${v.context || 'No context'}</p>
                    ${v.resolution ? `<p class="text-xs text-green-400 mt-1">‚úì ${v.resolution}</p>` : ''}
                    ${v.copilotSessionRef ? `<a href="${v.copilotSessionRef}" target="_blank" class="text-xs text-blue-400 hover:underline">View Copilot Session</a>` : ''}
                </div>
                `;
            }).join('');
        }
        
        document.getElementById('addViolationBtn').addEventListener('click', () => {
            document.getElementById('violationForm').reset();
            // Populate project select
            document.getElementById('violationProject').innerHTML = '<option value="">Select project...</option>' +
                allProjects.map(p => `<option value="${p.projectId}">${p.projectCode} - ${p.projectName}</option>`).join('');
            document.getElementById('violationModal').classList.remove('hidden');
        });
        
        document.getElementById('closeViolationModal').addEventListener('click', () => {
            document.getElementById('violationModal').classList.add('hidden');
        });
        
        document.getElementById('violationForm').addEventListener('submit', async e => {
            e.preventDefault();
            
            const payload = {
                ruleId: parseInt(document.getElementById('violationRule').value),
                projectId: parseInt(document.getElementById('violationProject').value),
                context: document.getElementById('violationContext').value,
                copilotSessionRef: document.getElementById('violationCopilotRef').value || null,
                resolution: document.getElementById('violationResolution').value || null
            };
            
            try {
                const res = await fetch(`${API}/api/methodology/violations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!res.ok) throw new Error(await res.text());
                
                showToast('Violation logged');
                document.getElementById('violationModal').classList.add('hidden');
                loadViolations();
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        });
        
        // ==================== CAPTURE MODAL ====================
        function populateCaptureProjects() {
            const select = document.getElementById('captureProject');
            select.innerHTML = '<option value="">Auto-detect</option>';
            allProjects.forEach(p => {
                const option = document.createElement('option');
                option.value = p.projectCode;
                option.textContent = `${p.projectCode} - ${p.projectName}`;
                select.appendChild(option);
            });
        }
        
        document.getElementById('fabCapture').addEventListener('click', async () => {
            if (!allProjects.length) {
                await loadProjects();
            }
            document.getElementById('captureText').value = '';
            document.getElementById('captureStatus').textContent = '';
            populateCaptureProjects();
            document.getElementById('captureModal').classList.remove('hidden');
        });
        
        document.getElementById('closeCaptureModal').addEventListener('click', () => {
            document.getElementById('captureModal').classList.add('hidden');
        });
        
        document.getElementById('submitCapture').addEventListener('click', async () => {
            const text = document.getElementById('captureText').value.trim();
            const project = document.getElementById('captureProject').value;
            const status = document.getElementById('captureStatus');
            
            if (!text) {
                status.textContent = 'Please enter some text';
                return;
            }
            
            status.textContent = 'Processing...';
            
            try {
                const res = await fetch(`${API}/api/capture/text`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, projectCode: project || null })
                });
                
                if (!res.ok) throw new Error(await res.text());
                
                const data = await res.json();
                status.textContent = data.message || 'Captured!';
                showToast('Captured successfully!');
                
                setTimeout(() => {
                    document.getElementById('captureModal').classList.add('hidden');
                    loadTasks();
                    loadHistory();
                }, 1000);
            } catch (err) {
                status.textContent = 'Error: ' + err.message;
                showToast('Capture failed', 'error');
            }
        });
        
        // Voice recording
        let mediaRecorder = null;
        let audioChunks = [];
        
        // Color picker synchronization
        document.getElementById('projectColorPicker').addEventListener('input', (e) => {
            const color = e.target.value;
            document.getElementById('projectColorHex').value = color;
            document.getElementById('projectColorPreview').style.backgroundColor = color;
        });
        
        document.getElementById('projectColorHex').addEventListener('input', (e) => {
            const color = e.target.value;
            if (/^#[0-9A-Fa-f]{6}$/.test(color)) {
                document.getElementById('projectColorPicker').value = color;
                document.getElementById('projectColorPreview').style.backgroundColor = color;
            }
        });
        
        document.getElementById('voiceRecordBtn').addEventListener('click', async () => {
            const btn = document.getElementById('voiceRecordBtn');
            const status = document.getElementById('captureStatus');
            
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                btn.innerHTML = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/></svg> Record';
                btn.classList.remove('btn-danger');
                return;
            }
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                
                mediaRecorder.onstop = async () => {
                    stream.getTracks().forEach(t => t.stop());
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    
                    status.textContent = 'Uploading...';
                    
                    const formData = new FormData();
                    formData.append('audio', audioBlob, 'recording.webm');
                    
                    const project = document.getElementById('captureProject').value;
                    if (project) formData.append('projectCode', project);
                    
                    try {
                        const res = await fetch(`${API}/api/capture/voice`, {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!res.ok) throw new Error(await res.text());
                        
                        const data = await res.json();
                        document.getElementById('captureText').value = data.transcript || '';
                        status.textContent = data.message || 'Transcribed!';
                        showToast('Voice captured!');
                    } catch (err) {
                        status.textContent = 'Error: ' + err.message;
                    }
                };
                
                mediaRecorder.start();
                btn.innerHTML = '‚èπ Stop';
                btn.classList.add('btn-danger');
                status.textContent = 'Recording...';
                
            } catch (err) {
                status.textContent = 'Microphone access denied';
            }
        });
        
        // ==================== LOAD CATEGORIES ====================
        async function loadCategories() {
            try {
                const res = await fetch(`${API}/api/categories`);
                const data = await res.json();
                allCategories = data.categories || [];
            } catch (e) {
                console.error('Load categories failed:', e);
            }
        }
        
        // ==================== BACKLOG ====================
        let allBugs = [];
        let allRequirements = [];
        let backlogSubTab = 'project';
        let backlogSearchValue = '';
        let lastBugProjectId = '';  // Persist project selection across bug adds
        let selectedItems = new Set();  // For multi-select: "bug-123" or "req-456"

        // Group By toggle (PM BUG-001) - called from inline onclick
        function switchGroupBy(mode) {
            console.log('switchGroupBy called:', mode);
            backlogSubTab = mode;
            // Update button styles
            const projBtn = document.getElementById('groupByProject');
            const itemBtn = document.getElementById('groupByItem');
            if (mode === 'project') {
                projBtn.className = 'px-3 py-1.5 text-xs font-medium bg-red-500 text-white';
                itemBtn.className = 'px-3 py-1.5 text-xs font-medium bg-white/5 text-gray-400 hover:bg-white/10';
            } else {
                projBtn.className = 'px-3 py-1.5 text-xs font-medium bg-white/5 text-gray-400 hover:bg-white/10';
                itemBtn.className = 'px-3 py-1.5 text-xs font-medium bg-red-500 text-white';
            }
            // Toggle view containers
            document.getElementById('bltab-project').style.display = mode === 'project' ? '' : 'none';
            document.getElementById('bltab-item').style.display = mode === 'item' ? '' : 'none';
            saveBacklogState();
            renderBacklog();
        }

        // Restore saved filter state from localStorage (BUG-003)
        function restoreBacklogState() {
            try {
                const saved = JSON.parse(localStorage.getItem('backlogFilters') || '{}');
                if (saved.groupBy && (saved.groupBy === 'project' || saved.groupBy === 'item')) {
                    switchGroupBy(saved.groupBy);
                }
                if (saved.status) document.getElementById('backlogStatusFilter').value = saved.status;
                if (saved.priority) document.getElementById('backlogPriorityFilter').value = saved.priority;
                if (saved.sort) document.getElementById('backlogSortFilter').value = saved.sort;
                if (saved.search) {
                    backlogSearchValue = saved.search;
                    document.getElementById('backlogSearch').value = saved.search;
                    document.getElementById('clearSearch').classList.toggle('hidden', !saved.search);
                }
                if (saved.projectId) {
                    document.getElementById('backlogProjectFilter').dataset.savedValue = saved.projectId;
                }
            } catch (e) { console.error('restoreBacklogState error:', e); }
        }

        function saveBacklogState() {
            const state = {
                groupBy: backlogSubTab,
                projectId: document.getElementById('backlogProjectFilter').value,
                status: document.getElementById('backlogStatusFilter').value,
                priority: document.getElementById('backlogPriorityFilter').value,
                sort: document.getElementById('backlogSortFilter').value,
                search: backlogSearchValue
            };
            localStorage.setItem('backlogFilters', JSON.stringify(state));
        }

        restoreBacklogState();

        // Search clear button (BUG-010)
        document.getElementById('clearSearch').addEventListener('click', () => {
            document.getElementById('backlogSearch').value = '';
            backlogSearchValue = '';
            document.getElementById('clearSearch').classList.add('hidden');
            saveBacklogState();
            renderBacklog();
        });

        // Backlog filter + sort + search handlers
        ['backlogProjectFilter', 'backlogStatusFilter', 'backlogPriorityFilter', 'backlogSortFilter'].forEach(id => {
            document.getElementById(id).addEventListener('change', () => {
                saveBacklogState();
                renderBacklog();
            });
        });

        document.getElementById('backlogSearch').addEventListener('input', debounce(e => {
            backlogSearchValue = e.target.value;
            document.getElementById('clearSearch').classList.toggle('hidden', !backlogSearchValue);
            saveBacklogState();
            renderBacklog();
        }, 250));

        // Bulk actions
        function updateBulkUI() {
            const bar = document.getElementById('bulkActions');
            if (selectedItems.size > 0) {
                bar.classList.remove('hidden');
                document.getElementById('bulkCount').textContent = `${selectedItems.size} selected`;
            } else {
                bar.classList.add('hidden');
            }
        }

        function toggleItemSelection(key, checkbox) {
            if (checkbox.checked) {
                selectedItems.add(key);
            } else {
                selectedItems.delete(key);
            }
            updateBulkUI();
        }

        document.getElementById('bulkClearBtn').addEventListener('click', () => {
            selectedItems.clear();
            document.querySelectorAll('.bulk-checkbox').forEach(cb => cb.checked = false);
            updateBulkUI();
        });

        document.getElementById('bulkDeleteBtn').addEventListener('click', async () => {
            if (!selectedItems.size || !confirm(`Delete ${selectedItems.size} items?`)) return;
            try {
                const promises = [];
                for (const key of selectedItems) {
                    const [type, id] = key.split('-', 2);
                    const endpoint = type === 'bug' ? 'bugs' : 'requirements';
                    promises.push(fetch(`${API}/api/backlog/${endpoint}/${id}`, { method: 'DELETE' }));
                }
                await Promise.all(promises);
                selectedItems.clear();
                updateBulkUI();
                await loadBacklog();
            } catch (err) {
                console.error('Bulk delete failed:', err);
                alert('Some deletes failed');
            }
        });

        document.getElementById('bulkStatusChange').addEventListener('change', async (e) => {
            const newStatus = e.target.value;
            if (!newStatus || !selectedItems.size) return;
            try {
                const promises = [];
                for (const key of selectedItems) {
                    const [type, id] = key.split('-', 2);
                    const endpoint = type === 'bug' ? 'bugs' : 'requirements';
                    promises.push(fetch(`${API}/api/backlog/${endpoint}/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    }));
                }
                await Promise.all(promises);
                selectedItems.clear();
                updateBulkUI();
                e.target.value = '';
                await loadBacklog();
            } catch (err) {
                console.error('Bulk status change failed:', err);
                alert('Some updates failed');
            }
        });

        function getBacklogFilters() {
            return {
                projectId: document.getElementById('backlogProjectFilter').value,
                status: document.getElementById('backlogStatusFilter').value,
                priority: document.getElementById('backlogPriorityFilter').value,
                sort: document.getElementById('backlogSortFilter').value
            };
        }

        function backlogProjectBadge(projectCode) {
            const project = allProjects.find(p => p.projectCode === projectCode);
            const bgColor = project?.colorCode || '#6b7280';
            const textColor = getContrastColor(bgColor);
            return `<span class="inline-block px-2 py-0.5 rounded text-xs font-medium" style="background-color: ${bgColor}; color: ${textColor}">${projectCode}</span>`;
        }

        async function loadBacklog() {
            try {
                const [bugsRes, reqsRes] = await Promise.all([
                    fetch(`${API}/api/backlog/bugs`),
                    fetch(`${API}/api/backlog/requirements`)
                ]);
                const bugsData = await bugsRes.json();
                const reqsData = await reqsRes.json();
                allBugs = bugsData.bugs || [];
                allRequirements = reqsData.requirements || [];

                // Populate project filter from allProjects (all projects, not just those with items)
                const projFilter = document.getElementById('backlogProjectFilter');
                const savedValue = projFilter.value || projFilter.dataset.savedValue || '';
                const projectsWithItems = new Set([
                    ...allBugs.map(b => b.projectId),
                    ...allRequirements.map(r => r.projectId)
                ]);
                projFilter.innerHTML = '<option value="">All Projects</option>' +
                    allProjects
                        .filter(p => projectsWithItems.has(p.projectId))
                        .map(p => `<option value="${p.projectId}">${p.projectCode} - ${p.projectName}</option>`)
                        .join('');
                if (savedValue) projFilter.value = savedValue;
                delete projFilter.dataset.savedValue;

                renderBacklog();
            } catch (err) {
                console.error('Failed to load backlog:', err);
                document.getElementById('bltab-project').innerHTML = '<p class="text-red-400 p-4">Failed to load backlog data</p>';
            }
        }

        function filterItem(item, f) {
            if (f.projectId && String(item.projectId) !== String(f.projectId)) return false;
            if (f.status && item.status !== f.status) return false;
            if (f.priority && item.priority !== f.priority) return false;
            if (backlogSearchValue) {
                const search = backlogSearchValue.toLowerCase();
                const fields = [item.code, item.title, item.description, item.projectCode, item.projectName].filter(Boolean);
                if (!fields.some(field => field.toLowerCase().includes(search))) return false;
            }
            return true;
        }

        function sortItems(items, sortKey) {
            const sorted = [...items];
            switch (sortKey) {
                case 'priority':
                    sorted.sort((a, b) => (a.priority || 'P5').localeCompare(b.priority || 'P5'));
                    break;
                case 'project':
                    sorted.sort((a, b) => (a.projectCode || '').localeCompare(b.projectCode || '') || (a.code || '').localeCompare(b.code || ''));
                    break;
                case 'code':
                    sorted.sort((a, b) => (a.projectCode || '').localeCompare(b.projectCode || '') || (a.code || '').localeCompare(b.code || ''));
                    break;
                case 'updated-desc':
                    sorted.sort((a, b) => new Date(b.updatedAt || b.createdAt || 0) - new Date(a.updatedAt || a.createdAt || 0));
                    break;
                case 'updated-asc':
                    sorted.sort((a, b) => new Date(a.updatedAt || a.createdAt || 0) - new Date(b.updatedAt || b.createdAt || 0));
                    break;
            }
            return sorted;
        }

        function renderBacklog() {
            const f = getBacklogFilters();
            const filteredBugs = sortItems(allBugs.filter(b => filterItem(b, f)), f.sort);
            const filteredReqs = sortItems(allRequirements.filter(r => filterItem(r, f)), f.sort);

            renderGroupedBacklog(filteredBugs, filteredReqs);
            renderItemsList(filteredBugs, filteredReqs, f.sort);
        }

        function priorityClass(p) {
            if (p === 'P1' || p === 'P2') return 'text-red-400';
            if (p === 'P3') return 'text-yellow-400';
            return 'text-green-400';
        }

        function statusBadge(status) {
            const colors = {
                'Open': 'bg-blue-500/20 text-blue-300',
                'In Progress': 'bg-yellow-500/20 text-yellow-300',
                'Fixed': 'bg-green-500/20 text-green-300',
                'Closed': 'bg-gray-500/20 text-gray-400',
                'Deferred': 'bg-orange-500/20 text-orange-300',
                'Backlog': 'bg-purple-500/20 text-purple-300',
                'Done': 'bg-green-500/20 text-green-300'
            };
            const cls = colors[status] || 'bg-gray-500/20 text-gray-300';
            return `<span class="inline-block px-2 py-0.5 rounded text-xs ${cls}">${status}</span>`;
        }

        function renderGroupedBacklog(bugs, reqs) {
            const container = document.getElementById('bltab-project');

            // Group by project - use Map to preserve insertion order
            const projects = new Map();
            bugs.forEach(b => {
                const key = String(b.projectId);
                if (!projects.has(key)) projects.set(key, { id: b.projectId, code: b.projectCode, name: b.projectName, bugs: [], reqs: [] });
                projects.get(key).bugs.push(b);
            });
            reqs.forEach(r => {
                const key = String(r.projectId);
                if (!projects.has(key)) projects.set(key, { id: r.projectId, code: r.projectCode, name: r.projectName, bugs: [], reqs: [] });
                projects.get(key).reqs.push(r);
            });

            if (projects.size === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm p-4 text-center">No backlog items found</p>';
                return;
            }

            // Sort project groups by code
            const sortedProjects = [...projects.values()].sort((a, b) => a.code.localeCompare(b.code));

            container.innerHTML = sortedProjects.map(proj => {
                const projObj = allProjects.find(p => p.projectId === proj.id);
                const borderColor = projObj?.colorCode || '#6b7280';
                return `
                <div class="glass-card rounded-2xl overflow-hidden" style="border-left: 4px solid ${borderColor}">
                    <div class="p-3 border-b border-white/10 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            ${backlogProjectBadge(proj.code)}
                            <h3 class="font-semibold">${proj.name}</h3>
                        </div>
                        <span class="text-xs text-gray-400">${proj.bugs.length} bugs, ${proj.reqs.length} reqs</span>
                    </div>
                    ${proj.bugs.length ? `
                        <div class="px-3 pt-2 pb-1"><span class="text-xs text-gray-500 uppercase tracking-wider">Bugs</span></div>
                        <div class="divide-y divide-white/5">
                            ${proj.bugs.map(b => `
                                <div class="item-row p-3 flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" class="bulk-checkbox" data-key="bug-${b.bugId}" onclick="event.stopPropagation(); toggleItemSelection('bug-${b.bugId}', this)" ${selectedItems.has('bug-'+b.bugId) ? 'checked' : ''}>
                                    <span class="font-mono text-xs ${priorityClass(b.priority)}">${b.priority}</span>
                                    <span class="font-mono text-xs text-gray-500">${b.code}</span>
                                    <span class="flex-1 text-sm clickable-title" onclick="openBugModal(${b.bugId})">${b.title}</span>
                                    ${statusBadge(b.status)}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    ${proj.reqs.length ? `
                        <div class="px-3 pt-2 pb-1"><span class="text-xs text-gray-500 uppercase tracking-wider">Requirements</span></div>
                        <div class="divide-y divide-white/5">
                            ${proj.reqs.map(r => `
                                <div class="item-row p-3 flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" class="bulk-checkbox" data-key="req-${r.requirementId}" onclick="event.stopPropagation(); toggleItemSelection('req-${r.requirementId}', this)" ${selectedItems.has('req-'+r.requirementId) ? 'checked' : ''}>
                                    <span class="font-mono text-xs ${priorityClass(r.priority)}">${r.priority}</span>
                                    <span class="font-mono text-xs text-gray-500">${r.code}</span>
                                    <span class="flex-1 text-sm clickable-title" onclick="openReqModal(${r.requirementId})">${r.title}</span>
                                    ${r.referenceURL ? `<a href="${r.referenceURL}" target="_blank" class="text-blue-400 hover:text-blue-300 text-xs" onclick="event.stopPropagation()">link</a>` : ''}
                                    ${statusBadge(r.status)}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `}).join('');
        }

        function renderItemsList(bugs, reqs, sortKey) {
            const container = document.getElementById('itemsList');
            // Merge bugs and reqs into a single list with type markers
            const items = [
                ...bugs.map(b => ({ ...b, _type: 'bug', _id: b.bugId, _sortDate: b.updatedAt || b.createdAt })),
                ...reqs.map(r => ({ ...r, _type: 'req', _id: r.requirementId, _sortDate: r.updatedAt || r.createdAt }))
            ];
            // Re-sort the merged list
            const sorted = sortItems(items, sortKey);

            if (!sorted.length) {
                container.innerHTML = '<p class="text-gray-400 text-sm p-4 text-center">No items found</p>';
                return;
            }
            container.innerHTML = sorted.map(item => {
                const key = `${item._type}-${item._id}`;
                const typeLabel = item._type === 'bug'
                    ? '<span class="text-xs px-1.5 py-0.5 rounded bg-red-500/20 text-red-300">BUG</span>'
                    : '<span class="text-xs px-1.5 py-0.5 rounded bg-purple-500/20 text-purple-300">REQ</span>';
                const onclick = item._type === 'bug' ? `openBugModal(${item._id})` : `openReqModal(${item._id})`;
                return `
                    <div class="item-row p-3 flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" class="bulk-checkbox" data-key="${key}" onclick="event.stopPropagation(); toggleItemSelection('${key}', this)" ${selectedItems.has(key) ? 'checked' : ''}>
                        <span class="font-mono text-xs ${priorityClass(item.priority)}">${item.priority}</span>
                        ${typeLabel}
                        <span class="font-mono text-xs text-gray-500">${item.code}</span>
                        ${backlogProjectBadge(item.projectCode)}
                        <span class="flex-1 text-sm clickable-title" onclick="${onclick}">${item.title}</span>
                        ${item._type === 'req' && item.referenceURL ? `<a href="${item.referenceURL}" target="_blank" class="text-blue-400 hover:text-blue-300 text-xs" onclick="event.stopPropagation()">link</a>` : ''}
                        ${statusBadge(item.status)}
                        <span class="text-xs text-gray-500">${item._sortDate ? new Date(item._sortDate).toLocaleDateString() : ''}</span>
                    </div>
                `;
            }).join('');
        }

        // Bug modal
        function populateBugProjectDropdown() {
            const sel = document.getElementById('bugProject');
            sel.innerHTML = allProjects.map(p => `<option value="${p.projectId}">${p.projectCode} - ${p.projectName}</option>`).join('');
        }

        async function openBugModal(bugId = null) {
            populateBugProjectDropdown();
            const modal = document.getElementById('bugModal');
            const title = document.getElementById('bugModalTitle');
            const deleteBtn = document.getElementById('deleteBugBtn');

            if (bugId) {
                title.textContent = 'Edit Bug';
                deleteBtn.classList.remove('hidden');
                try {
                    const res = await fetch(`${API}/api/backlog/bugs/${bugId}`);
                    const bug = await res.json();
                    document.getElementById('bugId').value = bug.bugId;
                    document.getElementById('bugProject').value = bug.projectId;
                    document.getElementById('bugCode').value = bug.code;
                    document.getElementById('bugTitle').value = bug.title;
                    document.getElementById('bugDescription').value = bug.description || '';
                    document.getElementById('bugStatus').value = bug.status;
                    document.getElementById('bugPriority').value = bug.priority;
                } catch (err) {
                    console.error('Failed to load bug:', err);
                    return;
                }
            } else {
                title.textContent = 'Add Bug';
                deleteBtn.classList.add('hidden');
                document.getElementById('bugForm').reset();
                document.getElementById('bugId').value = '';
                // Restore last used project
                if (lastBugProjectId) {
                    document.getElementById('bugProject').value = lastBugProjectId;
                }
                const projId = document.getElementById('bugProject').value;
                if (projId) {
                    try {
                        const codeRes = await fetch(`${API}/api/backlog/next-code/${projId}/bug`);
                        const codeData = await codeRes.json();
                        document.getElementById('bugCode').value = codeData.code;
                    } catch (e) { /* ignore */ }
                }
            }
            modal.classList.remove('hidden');
        }

        // Auto-generate bug code when project changes
        document.getElementById('bugProject').addEventListener('change', async (e) => {
            if (!document.getElementById('bugId').value) {
                try {
                    const codeRes = await fetch(`${API}/api/backlog/next-code/${e.target.value}/bug`);
                    const codeData = await codeRes.json();
                    document.getElementById('bugCode').value = codeData.code;
                } catch (err) { /* ignore */ }
            }
        });

        document.getElementById('bugForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const bugId = document.getElementById('bugId').value;
            const projectId = parseInt(document.getElementById('bugProject').value);
            lastBugProjectId = String(projectId);  // Persist selection
            const payload = {
                projectId: projectId,
                code: document.getElementById('bugCode').value,
                title: document.getElementById('bugTitle').value,
                description: document.getElementById('bugDescription').value || null,
                status: document.getElementById('bugStatus').value,
                priority: document.getElementById('bugPriority').value
            };

            try {
                if (bugId) {
                    await fetch(`${API}/api/backlog/bugs/${bugId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } else {
                    await fetch(`${API}/api/backlog/bugs`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }
                document.getElementById('bugModal').classList.add('hidden');
                await loadBacklog();
            } catch (err) {
                console.error('Failed to save bug:', err);
                alert('Failed to save bug');
            }
        });

        document.getElementById('deleteBugBtn').addEventListener('click', async () => {
            const bugId = document.getElementById('bugId').value;
            if (!bugId || !confirm('Delete this bug?')) return;
            try {
                await fetch(`${API}/api/backlog/bugs/${bugId}`, { method: 'DELETE' });
                document.getElementById('bugModal').classList.add('hidden');
                await loadBacklog();
            } catch (err) {
                console.error('Failed to delete bug:', err);
            }
        });

        document.getElementById('closeBugModal').addEventListener('click', () => {
            document.getElementById('bugModal').classList.add('hidden');
        });

        // Requirement modal
        function populateReqProjectDropdown() {
            const sel = document.getElementById('reqProject');
            sel.innerHTML = allProjects.map(p => `<option value="${p.projectId}">${p.projectCode} - ${p.projectName}</option>`).join('');
        }

        async function openReqModal(reqId = null) {
            populateReqProjectDropdown();
            const modal = document.getElementById('reqModal');
            const title = document.getElementById('reqModalTitle');
            const deleteBtn = document.getElementById('deleteReqBtn');

            if (reqId) {
                title.textContent = 'Edit Requirement';
                deleteBtn.classList.remove('hidden');
                try {
                    const res = await fetch(`${API}/api/backlog/requirements/${reqId}`);
                    const req = await res.json();
                    document.getElementById('reqId').value = req.requirementId;
                    document.getElementById('reqProject').value = req.projectId;
                    document.getElementById('reqCode').value = req.code;
                    document.getElementById('reqTitle').value = req.title;
                    document.getElementById('reqDescription').value = req.description || '';
                    document.getElementById('reqReferenceURL').value = req.referenceURL || '';
                    document.getElementById('reqStatus').value = req.status;
                    document.getElementById('reqPriority').value = req.priority;
                } catch (err) {
                    console.error('Failed to load requirement:', err);
                    return;
                }
            } else {
                title.textContent = 'Add Requirement';
                deleteBtn.classList.add('hidden');
                document.getElementById('reqForm').reset();
                document.getElementById('reqId').value = '';
                const projId = document.getElementById('reqProject').value;
                if (projId) {
                    try {
                        const codeRes = await fetch(`${API}/api/backlog/next-code/${projId}/requirement`);
                        const codeData = await codeRes.json();
                        document.getElementById('reqCode').value = codeData.code;
                    } catch (e) { /* ignore */ }
                }
            }
            modal.classList.remove('hidden');
        }

        // Auto-generate req code when project changes
        document.getElementById('reqProject').addEventListener('change', async (e) => {
            if (!document.getElementById('reqId').value) {
                try {
                    const codeRes = await fetch(`${API}/api/backlog/next-code/${e.target.value}/requirement`);
                    const codeData = await codeRes.json();
                    document.getElementById('reqCode').value = codeData.code;
                } catch (err) { /* ignore */ }
            }
        });

        document.getElementById('reqForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const reqId = document.getElementById('reqId').value;
            const payload = {
                projectId: parseInt(document.getElementById('reqProject').value),
                code: document.getElementById('reqCode').value,
                title: document.getElementById('reqTitle').value,
                description: document.getElementById('reqDescription').value || null,
                referenceURL: document.getElementById('reqReferenceURL').value || null,
                status: document.getElementById('reqStatus').value,
                priority: document.getElementById('reqPriority').value
            };

            try {
                if (reqId) {
                    await fetch(`${API}/api/backlog/requirements/${reqId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } else {
                    await fetch(`${API}/api/backlog/requirements`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }
                document.getElementById('reqModal').classList.add('hidden');
                await loadBacklog();
            } catch (err) {
                console.error('Failed to save requirement:', err);
                alert('Failed to save requirement');
            }
        });

        document.getElementById('deleteReqBtn').addEventListener('click', async () => {
            const reqId = document.getElementById('reqId').value;
            if (!reqId || !confirm('Delete this requirement?')) return;
            try {
                await fetch(`${API}/api/backlog/requirements/${reqId}`, { method: 'DELETE' });
                document.getElementById('reqModal').classList.add('hidden');
                await loadBacklog();
            } catch (err) {
                console.error('Failed to delete requirement:', err);
            }
        });

        document.getElementById('closeReqModal').addEventListener('click', () => {
            document.getElementById('reqModal').classList.add('hidden');
        });

        // Add Bug / Add Requirement buttons
        document.getElementById('addBugBtn').addEventListener('click', () => openBugModal());
        document.getElementById('addReqBtn').addEventListener('click', () => openReqModal());

        // ==================== INIT ====================
        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadTasks();
            loadProjects();
            loadHistory();
            loadRules();
            loadViolations();
            loadBacklog();
        });
        
        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target === modal) modal.classList.add('hidden');
            });
        });
        
        // Initial load
        (async () => {
            // Load version
            try {
                const versionRes = await fetch('/api/version');
                const versionData = await versionRes.json();
                const buildLabel = (versionData.build && versionData.build !== 'unknown') ? ` (${versionData.build})` : '';
                document.getElementById('versionBadge').textContent = `v${versionData.version}${buildLabel}`;
                console.log('MetaPM Version:', versionData.version, 'Build:', versionData.build || 'n/a');
            } catch (error) {
                console.error('Failed to load version:', error);
            }
            
            initTheme();
            initSyncStatus();
            setDefaultTab();
            await loadCategories();
            await loadProjects();
            await loadTasks();
            loadHistory();
            loadRules();
            loadViolations();
            loadBacklog();
        })();
    </script>
</body>
</html>
